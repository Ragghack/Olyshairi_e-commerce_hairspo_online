<!DOCTYPE html>
<html lang="en">
  <head>
    <head>
    <!-- ðŸ–¼ï¸ Favicon (shows in browser tab) -->
    <link rel="icon" type="image/png" href="/images/Logo Version Transparente-01.png">
    <!-- Optional for Apple/Android homescreens -->
    <link rel="apple-touch-icon" href="/images/Logo Version Transparente-01.png">

    <!-- ðŸ” Google Structured Data (shows logo in search results) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "url": "https://www.olyshair.com",
      "logo": "https://www.olyshair.com/images/Logo%20Version%20Transparente-01.png"
    }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OLYS HAIR - Admin Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --cream: #392625;
        --white: #ffffff;
        --dark-gray: #1e1e1e;
        --light-bg: #f8f5f2;
        --text-dark: #1e1e1e;
        --text-light: #ffffff;
        --card-bg: #ffffff;
        --shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --info: #17a2b8;
      }

      .dark-mode {
        --cream: #c8b4a8;
        --white: #1e1e1e;
        --dark-gray: #f8f5f2;
        --light-bg: #2d2d2d;
        --text-dark: #f8f5f2;
        --text-light: #1e1e1e;
        --card-bg: #181212;
        --shadow: 0 5px 15px rgba(182, 131, 131, 0.2);
      }

      body {
        font-family: "Montserrat", sans-serif;
        background-color: var(--white);
        color: var(--text-dark);
        overflow-x: hidden;
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      h1,
      h2,
      h3,
      h4 {
        font-family: "Playfair Display", serif;
        font-weight: 600;
        color: var(--cream);
      }

      /* Header Styles */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
        background-color: var(--white);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
      }

      .logo-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 180px;
        height: 80px;
        background-color: var(--white);
        border-radius: 10px;
        box-shadow: var(--shadow);
      }

      .logo {
        max-width: 100%;
        height: auto;
        max-height: 60px;
      }

      .header-icons {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .header-icons i {
        font-size: 20px;
        color: var(--cream);
        cursor: pointer;
      }

      /* User Profile Dropdown */
      .user-profile {
        position: relative;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--cream);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-weight: bold;
      }

      .dropdown-menu {
        position: absolute;
        top: 50px;
        right: 0;
        background-color: var(--white);
        border-radius: 8px;
        box-shadow: var(--shadow);
        width: 200px;
        padding: 15px;
        display: none;
        z-index: 1001;
      }

      .dropdown-menu.show {
        display: block;
      }

      .dropdown-menu a {
        display: block;
        padding: 10px;
        text-decoration: none;
        color: var(--text-dark);
        transition: background-color 0.3s;
      }

      .dropdown-menu a:hover {
        background-color: var(--light-bg);
        border-radius: 4px;
      }

      /* Dark/Light Mode Toggle */
      .mode-toggle {
        position: relative;
        width: 60px;
        height: 30px;
        background-color: var(--light-bg);
        border-radius: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 0 5px;
        transition: background-color 0.3s ease;
      }

      .toggle-circle {
        position: absolute;
        width: 22px;
        height: 22px;
        background-color: var(--cream);
        border-radius: 50%;
        transition: all 0.3s ease;
        left: 4px;
      }

      .dark-mode .toggle-circle {
        left: 34px;
      }

      .mode-toggle i {
        font-size: 14px;
        z-index: 2;
      }

      .fa-sun {
        color: var(--cream);
        margin-right: auto;
      }

      .fa-moon {
        color: var(--cream);
        margin-left: auto;
      }

      /* Dashboard Layout */
      .dashboard-container {
        display: flex;
        margin-top: 120px;
        min-height: calc(100vh - 180px);
      }

      /* Sidebar Navigation */
      .sidebar {
        width: 280px;
        background-color: var(--light-bg);
        padding: 30px 20px;
        position: fixed;
        height: calc(100vh - 120px);
        overflow-y: auto;
      }

      .sidebar-bubble {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        margin-bottom: 10px;
        border-radius: 10px;
        background-color: var(--card-bg);
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .sidebar-bubble:hover,
      .sidebar-bubble.active {
        background-color: var(--cream);
        color: var(--white);
      }

      .sidebar-bubble i {
        margin-right: 15px;
        font-size: 18px;
      }

      /* Main Content Area */
      .dashboard-content {
        flex: 1;
        margin-left: 280px;
        padding: 30px 40px;
        position: relative;
        overflow: hidden;
      }

      /* Content Sections */
      .content-section {
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.4s ease, transform 0.4s ease;
      }

      .content-section.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
      }

      /* Welcome Banner */
      .welcome-banner {
        background: linear-gradient(
          rgba(167, 156, 156, 0.85),
          rgba(57, 38, 37, 0.85)
        );
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        color: var(--white);
        box-shadow: var(--shadow);
        background: linear-gradient(
          45deg,
          #ffffff 20%,
          #392625 40%,
          #ffffff 60%,
          #392625 80%
        );
        background-size: 200% auto;
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 5s infinite linear;
        text-shadow: 0 0 10px rgba(57, 38, 37, 0.5);
        font-weight: 600;
      }

      .welcome-banner h1 {
        color: var(--white);
        margin-bottom: 10px;
      }

      /* Dashboard Cards */
      .dashboard-section {
        margin-bottom: 40px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .view-all {
        color: var(--cream);
        text-decoration: none;
        font-weight: 500;
      }

      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .dashboard-card {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        box-shadow: var(--shadow);
      }

      /* KPI Cards */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .kpi-card {
        background: linear-gradient(135deg, var(--cream), var(--dark-gray));
        color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: var(--shadow);
      }

      .kpi-card h3 {
        font-size: 0.9rem;
        margin-bottom: 10px;
        color: #fff;
      }

      .kpi-card .value {
        font-size: 1.8rem;
        font-weight: bold;
      }

      /* Tables */
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th,
      .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--light-bg);
      }

      .data-table th {
        font-weight: 600;
        color: var(--cream);
      }

      .status-badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-delivered {
        background-color: #e6f7ee;
        color: #0c9770;
      }

      .status-processing {
        background-color: #fef5e7;
        color: #e58e02;
      }

      .status-shipped {
        background-color: #e6f0ff;
        color: #2d6bdb;
      }

      .status-low {
        background-color: #ffe6e6;
        color: #d9534f;
      }

      /* Booking Status Badges */
      .status-pending {
        background-color: #fef5e7;
        color: #e58e02;
      }

      .status-confirmed {
        background-color: #e6f0ff;
        color: #2d6bdb;
      }

      .status-in-progress {
        background-color: #e6f7ff;
        color: #1890ff;
      }

      .status-completed {
        background-color: #e6f7ee;
        color: #0c9770;
      }

      .status-cancelled {
        background-color: #ffe6e6;
        color: #d9534f;
      }

      .action-btn {
        padding: 6px 12px;
        background-color: var(--cream);
        color: var(--white);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-right: 5px;
        transition: background-color 0.3s;
      }

      .action-btn:hover {
        background-color: var(--dark-gray);
      }

      .btn-danger {
        background-color: var(--danger);
      }

      .btn-success {
        background-color: var(--success);
      }

      .btn-warning {
        background-color: var(--warning);
        color: var(--dark-gray);
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--cream);
      }

      .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--light-bg);
        border-radius: 8px;
        background-color: var(--card-bg);
        color: var(--text-dark);
        font-family: "Montserrat", sans-serif;
        transition: border-color 0.3s;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--cream);
      }

      /* Login Form */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: var(--light-bg);
      }

      .login-card {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 40px;
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 400px;
      }

      .login-card h2 {
        text-align: center;
        margin-bottom: 30px;
      }

      /* Notifications */
      .notification {
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        z-index: 2000;
        box-shadow: var(--shadow);
        transform: translateX(120%);
        transition: transform 0.3s ease;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background-color: var(--success);
      }

      .notification.error {
        background-color: var(--danger);
      }

      .notification.warning {
        background-color: var(--warning);
        color: var(--dark-gray);
      }

      /* Loading Spinner */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Floating Bubbles */
      .floating-bubbles {
        position: fixed;
        right: 30px;
        bottom: 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 1200;
      }

      .bubble-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--cream);
        color: var(--white);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 22px;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .bubble-btn span {
        display: none;
        position: absolute;
        right: 70px;
        background: var(--dark-gray);
        color: var(--white);
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 14px;
        white-space: nowrap;
      }

      .bubble-btn:hover {
        background-color: var(--dark-gray);
        transform: scale(1.1);
      }

      .bubble-btn:hover span {
        display: block;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .modal-content {
        background: var(--card-bg);
        padding: 30px;
        border-radius: 10px;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        width: 95%;
      }

      .detail-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--light-bg);
      }

      .detail-section h4 {
        margin-bottom: 10px;
        color: var(--cream);
      }

      /* Product Images Preview */
      .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .image-preview {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--light-bg);
      }

      .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .image-preview .remove-image {
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .sidebar {
          width: 220px;
        }

        .dashboard-content {
          margin-left: 220px;
        }
      }

      @media (max-width: 768px) {
        header {
          padding: 15px 20px;
        }

        .dashboard-container {
          flex-direction: column;
          margin-top: 100px;
        }

        .sidebar {
          position: relative;
          width: 100%;
          height: auto;
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          padding: 15px;
          justify-content: center;
        }

        .sidebar-bubble {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          padding: 0;
          justify-content: center;
          margin-bottom: 0;
        }

        .sidebar-bubble span {
          display: none;
        }

        .sidebar-bubble i {
          margin-right: 0;
          font-size: 20px;
        }

        .dashboard-content {
          margin-left: 0;
          padding: 20px;
        }

        .card-grid,
        .kpi-grid {
          grid-template-columns: 1fr;
        }

        .data-table {
          display: block;
          overflow-x: auto;
        }

        .floating-bubbles {
          bottom: 80px;
          right: 15px;
        }

        .bubble-btn span {
          right: 65px;
          bottom: 0;
        }

        .modal-content {
          max-width: 95%;
          padding: 20px;
        }
      }

      @keyframes shine {
        0% {
          background-position: 0% center;
        }
        100% {
          background-position: 200% center;
        }
      }
      /* Add to admindashboard.html CSS */
.image-preview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 15px;
  margin-top: 10px;
}

.image-preview-item {
  position: relative;
}

.image-preview {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid var(--light-bg);
  transition: border-color 0.3s ease;
}

.image-preview:hover {
  border-color: var(--cream);
}

.image-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-preview-info {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 4px;
  font-size: 11px;
  display: flex;
  justify-content: space-between;
}

.main-image-badge {
  background: var(--success);
  color: white;
  padding: 1px 4px;
  border-radius: 3px;
  font-size: 10px;
}

.remove-preview {
  position: absolute;
  top: 5px;
  right: 5px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.remove-preview:hover {
  background: #c82333;
}
/* Add to existing CSS */
.btn-danger {
  background-color: var(--danger);
  color: white;
}

.btn-danger:hover {
  background-color: #c82333;
  color: white;
}

/* Make sure action buttons have proper spacing */
.action-btn {
  margin: 2px;
}

/* Style for delete confirmation */
.delete-confirmation {
  background-color: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 4px;
  padding: 10px;
  margin: 10px 0;
}

.delete-confirmation p {
  color: #856404;
  margin: 0;
}
/* Add to existing CSS */
.order-details {
  max-height: 60vh;
  overflow-y: auto;
  padding-right: 10px;
}

.order-details::-webkit-scrollbar {
  width: 6px;
}

.order-details::-webkit-scrollbar-track {
  background: var(--light-bg);
  border-radius: 3px;
}

.order-details::-webkit-scrollbar-thumb {
  background: var(--cream);
  border-radius: 3px;
}

.status-badge.status-delivered {
  background-color: #e6f7ee;
  color: #0c9770;
}

.status-badge.status-shipped {
  background-color: #e6f0ff;
  color: #2d6bdb;
}

.status-badge.status-confirmed {
  background-color: #f0f7ff;
  color: #1a73e8;
}

.status-badge.status-pending {
  background-color: #fef5e7;
  color: #e58e02;
}

.status-badge.status-processing {
  background-color: #f0e6ff;
  color: #8a2be2;
}

.status-badge.status-cancelled {
  background-color: #ffe6e6;
  color: #d9534f;
}

/* Timeline styles */
.timeline-item {
  position: relative;
  padding-left: 30px;
  margin-bottom: 15px;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background-color: var(--cream);
}

.timeline-item.completed::before {
  background-color: var(--success);
}

.timeline-item.pending::before {
  background-color: var(--warning);
}

.timeline-item.cancelled::before {
  background-color: var(--danger);
}

/* Table styles in modals */
.modal-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
}

.modal-content th {
  background-color: var(--light-bg);
  font-weight: 600;
  color: var(--cream);
  text-align: left;
  padding: 10px;
}

.modal-content td {
  padding: 10px;
  border-bottom: 1px solid var(--light-bg);
}

.modal-content tfoot td {
  font-weight: bold;
  border-top: 2px solid var(--cream);
}

/* Print styles */
@media print {
  .modal-overlay {
    position: static;
    background: white;
  }
  
  .modal-content {
    max-height: none;
    max-width: none;
    box-shadow: none;
    border: 1px solid #ddd;
  }
  
  .action-btn {
    display: none;
  }
}
    </style>
  </head>
  <body>
    <!-- Login Form (Initially Visible) -->
    <div class="login-container" id="loginContainer">
      <div class="login-card">
        <h2>Admin Login</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input
              type="password"
              id="loginPassword"
              class="form-control"
              required
            />
          </div>
          <button
            type="submit"
            class="action-btn"
            style="width: 100%; padding: 12px"
            id="loginBtn"
          >
            <span id="loginBtnText">Login</span>
            <div class="loading" id="loginLoading" style="display: none"></div>
          </button>
        </form>
        <p style="text-align: center; margin-top: 20px">
          <a href="#" id="showRegister">Register as Admin</a>
        </p>
      </div>
    </div>

    <!-- Register Form (Initially Hidden) -->
    <div class="login-container" id="registerContainer" style="display: none">
      <div class="login-card">
        <h2>Admin Registration</h2>
        <form id="registerForm">
          <div class="form-group">
            <label for="registerFirstName">First Name</label>
            <input
              type="text"
              id="registerFirstName"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="registerLastName">Last Name</label>
            <input
              type="text"
              id="registerLastName"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="registerEmail">Email</label>
            <input
              type="email"
              id="registerEmail"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="registerPassword">Password</label>
            <input
              type="password"
              id="registerPassword"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="registerPhone">Phone Number</label>
            <input type="tel" id="registerPhone" class="form-control" />
          </div>
          <button
            type="submit"
            class="action-btn"
            style="width: 100%; padding: 12px"
            id="registerBtn"
          >
            <span id="registerBtnText">Register</span>
            <div
              class="loading"
              id="registerLoading"
              style="display: none"
            ></div>
          </button>
        </form>
        <p style="text-align: center; margin-top: 20px">
          <a href="#" id="showLogin">Back to Login</a>
        </p>
      </div>
    </div>

    <!-- Dashboard (Initially Hidden) -->
    <div id="dashboard" style="display: none">
      <!-- Header -->
      <header>
        <div class="logo-container">
          <img src="images/Logo Version Transparente-01.png" alt="Olys Hair Logo" class="logo" />
        </div>
        <div class="header-icons">
          <i class="fas fa-bell"></i>
          <i class="fas fa-envelope"></i>
          <div class="user-profile">
            <div class="user-avatar">
              <img
                id="avatar-img"
                src="banner/default.png"
                alt="Profile"
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  object-fit: cover;
                "
              />
            </div>
            <span id="adminName">Admin</span>
            <div class="dropdown-menu">
              <a href="#"><i class="fas fa-user"></i> My Profile</a>
              <a href="#"><i class="fas fa-cog"></i> Settings</a>
              <a href="#" id="logoutBtn"
                ><i class="fas fa-sign-out-alt"></i> Logout</a
              >
            </div>
          </div>
          <div class="mode-toggle">
            <i class="fas fa-sun"></i>
            <i class="fas fa-moon"></i>
            <div class="toggle-circle"></div>
          </div>
        </div>
      </header>

      <!-- Floating Bubbles -->
      <div class="floating-bubbles">
        <div class="bubble-btn" onclick="window.location.href='shop.html'">
          <i class="fas fa-store"></i>
          <span>Return to Shop</span>
        </div>
        <div
          class="bubble-btn"
          onclick="window.location.href='customerdashboard.html'"
        >
          <i class="fas fa-exchange-alt"></i>
          <span>Switch to Customer Dashboard</span>
        </div>
      </div>

      <!-- Dashboard Container -->
      <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
          <div class="sidebar-bubble active" data-section="dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </div>
          <div class="sidebar-bubble" data-section="products">
            <i class="fas fa-box"></i>
            <span>Products</span>
          </div>
          <div class="sidebar-bubble" data-section="orders">
            <i class="fas fa-shopping-cart"></i>
            <span>Orders</span>
          </div>
          <div class="sidebar-bubble" data-section="bookings">
            <i class="fas fa-calendar-alt"></i>
            <span>Bookings</span>
          </div>
          <div class="sidebar-bubble" data-section="users">
            <i class="fas fa-users"></i>
            <span>Users</span>
          </div>
          <!--<div class="sidebar-bubble" data-section="inventory">
            <i class="fas fa-warehouse"></i>
            <span>Inventory</span>
          </div>
          <div class="sidebar-bubble" data-section="marketing">
            <i class="fas fa-bullhorn"></i>
            <span>Marketing</span>
          </div>-->
          <div class="sidebar-bubble" data-section="reports">
            <i class="fas fa-chart-line"></i>
            <span>Reports</span>
          </div>
          <div class="sidebar-bubble" data-section="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </div>
        </div>

        <!-- Main Content Area -->
        <div class="dashboard-content">
          <!-- Dashboard Section -->
          <div class="content-section active" id="dashboard">
            <!-- Welcome Banner -->
            <div class="welcome-banner">
              <h1 id="welcomeMessage">Admin Dashboard</h1>
              <p>
                Welcome back, <span id="adminGreeting">Admin</span>. Here's an
                overview of your store performance.
              </p>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-grid">
              <div class="kpi-card">
                <h3>Total Sales Today</h3>
                <div class="value" id="totalSales">â‚¬0</div>
              </div>
              <div class="kpi-card">
                <h3>New Orders</h3>
                <div class="value" id="newOrders">0</div>
              </div>
              <div class="kpi-card">
                <h3>Pending Bookings</h3>
                <div class="value" id="pendingBookings">0</div>
              </div>
              <div class="kpi-card">
                <h3>Booking Revenue</h3>
                <div class="value" id="bookingRevenue">â‚¬0</div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="dashboard-section">
              <div class="section-header">
                <h2>Recent Bookings</h2>
                <a href="#" class="view-all" data-section="bookings">View All</a>
              </div>
              <div class="dashboard-card">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Customer</th>
                      <th>Service</th>
                      <th>Wigs</th>
                      <th>Status</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="recentBookings">
                    <!-- Bookings will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- System Diagnostics -->
            <div class="dashboard-card" style="margin-top: 20px">
              <h3>System Diagnostics</h3>
              <button class="action-btn" onclick="runDiagnostics()">
                Run Diagnostics
              </button>
              <div
                id="diagnosticResults"
                style="
                  margin-top: 15px;
                  font-family: monospace;
                  font-size: 12px;
                "
              ></div>
            </div>
          </div>

          <!-- Products Section -->
          <div class="content-section" id="products">
            <div class="section-header">
              <h2>Product Management</h2>
              <button class="action-btn" id="addProductBtn">
                Add New Product
              </button>
            </div>

            <!-- Add Product Form (Initially Hidden) -->
            <div
              class="dashboard-card"
              id="addProductForm"
              style="display: none"
            >
              <h3>Add New Product</h3>
              <form id="productForm">
                <div class="form-group">
                  <label for="productName">Product Name</label>
                  <input
                    type="text"
                    id="productName"
                    class="form-control"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="productDescription">Description</label>
                  <textarea
                    id="productDescription"
                    class="form-control"
                    rows="3"
                    required
                  ></textarea>
                </div>
                <div class="form-group">
                  <label for="productPrice">Price</label>
                  <input
                    type="number"
                    id="productPrice"
                    class="form-control"
                    step="0.01"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="productOldPrice">Old Price (Optional)</label>
                  <input
                    type="number"
                    id="productOldPrice"
                    class="form-control"
                    step="0.01"
                  />
                </div>
                <div class="form-group">
                  <label for="productStock">Stock Quantity</label>
                  <input
                    type="number"
                    id="productStock"
                    class="form-control"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="productCategory">Category</label>
                  <select id="productCategory" class="form-control" required>
                    <option value="">Select Category</option>
                    <option value="brazilian">Brazilian</option>
                    <option value="peruvian">Peruvian</option>
                    <option value="malaysian">Malaysian</option>
                    <option value="indian">Indian</option>
                    <option value="accessories">Accessories</option>
                    <option value="extensions">Extensions</option>
                    <option value="wigs">Wigs</option>
                    <option value="closures">Closures</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="productType">Type</label>
                  <input
                    type="text"
                    id="productType"
                    class="form-control"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="productLength">Length</label>
                  <input type="text" id="productLength" class="form-control" />
                </div>
                <div class="form-group">
                  <label for="productTexture">Texture</label>
                  <input type="text" id="productTexture" class="form-control" />
                </div>
                <div class="form-group">
                  <label for="productColor">Color</label>
                  <input type="text" id="productColor" class="form-control" />
                </div>
                <div class="form-group">
                  <label for="productQuality">Quality</label>
                  <input
                    type="text"
                    id="productQuality"
                    class="form-control"
                    value="Premium"
                  />
                </div>
<div class="form-group">
  <label for="productImages">Product Images (Multiple)</label>
  <input
    type="file"
    id="productImages"
    class="form-control"
    accept="image/*"
    multiple
    onchange="previewMultipleImages(this)"
  />
  <small>You can select multiple images. First image will be the main display image.</small>
</div>
<!-- Add image preview container -->
<div class="form-group" id="imagePreviewContainer" style="display: none;">
  <label>Image Previews</label>
  <div class="image-preview-grid" id="imagePreviews">
    <!-- Image previews will be added here -->
  </div>
</div>
                <button type="submit" class="action-btn" id="saveProductBtn">
                  Save Product
                </button>
                <button
                  type="button"
                  class="action-btn btn-danger"
                  id="cancelAddProduct"
                >
                  Cancel
                </button>
              </form>
            </div>

            <!-- Products Table -->
            <div class="dashboard-card">
              <div class="section-header">
                <h3>All Products</h3>
                <input
                  type="text"
                  id="productSearch"
                  class="form-control"
                  placeholder="Search products..."
                  style="width: 300px"
                />
              </div>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="productsTableBody">
                  <!-- Products will be loaded here -->
                </tbody>
              </table>
              <div
                id="productsPagination"
                style="margin-top: 20px; text-align: center"
              >
                <!-- Pagination will be added here -->
              </div>
            </div>
          </div>

          <!-- Orders Section -->
<!-- Orders Section -->
<div class="content-section" id="orders">
  <div class="section-header">
    <h2>Order Management</h2>
    <div style="display: flex; gap: 10px; align-items: center;">
      <input
        type="text"
        id="orderSearch"
        class="form-control"
        placeholder="Search orders..."
        style="width: 250px;"
      />
      <select id="orderStatusFilter" class="form-control" style="width: 150px;">
        <option value="all">All Status</option>
        <option value="pending">Pending</option>
        <option value="confirmed">Confirmed</option>
        <option value="processing">Processing</option>
        <option value="shipped">Shipped</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <button class="action-btn" onclick="refreshOrders()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Orders Stats -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <h3>Total Orders</h3>
      <div class="value" id="totalOrders">0</div>
    </div>
    <div class="kpi-card">
      <h3>Pending</h3>
      <div class="value" id="pendingOrders">0</div>
    </div>
    <div class="kpi-card">
      <h3>Processing</h3>
      <div class="value" id="processingOrders">0</div>
    </div>
    <div class="kpi-card">
      <h3>Completed</h3>
      <div class="value" id="completedOrders">0</div>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div class="dashboard-card" style="margin-bottom: 20px;">
    <h4>Bulk Actions</h4>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <button class="action-btn" onclick="selectAllOrders()">
        <i class="fas fa-check-square"></i> Select All
      </button>
      <button class="action-btn btn-warning" onclick="bulkUpdateOrderStatus()">
        <i class="fas fa-edit"></i> Update Status
      </button>
      <button class="action-btn btn-danger" onclick="bulkDeleteOrders()">
        <i class="fas fa-trash"></i> Delete Selected
      </button>
      <div style="margin-left: auto;">
        <span id="selectedCount">0 orders selected</span>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="dashboard-card">
    <div class="section-header" style="margin-bottom: 15px;">
      <h3>All Orders</h3>
      <div>
        <span style="margin-right: 10px;">Show:</span>
        <select id="ordersPerPage" class="form-control" style="width: 80px; display: inline-block;">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th style="width: 30px;">
            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAllOrders(this)">
          </th>
          <th>Order #</th>
          <th>Customer</th>
          <th>Status</th>
          <th>Total</th>
          <th>Date</th>
          <th>Items</th>
          <th>Payment</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersTableBody">
        <!-- Orders will be loaded here -->
      </tbody>
    </table>
    
    <div id="ordersPagination" style="margin-top: 20px; text-align: center; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <span id="ordersCount">0 orders found</span>
      </div>
      <div>
        <button class="action-btn" id="prevPageBtn" disabled onclick="changeOrdersPage(-1)">Previous</button>
        <span style="margin: 0 15px;" id="currentPage">Page 1</span>
        <button class="action-btn" id="nextPageBtn" disabled onclick="changeOrdersPage(1)">Next</button>
      </div>
    </div>
  </div>
</div>

          <!-- Bookings Section -->
          <div class="content-section" id="bookings">
            <div class="section-header">
              <h2>Booking Management</h2>
              <button class="action-btn" onclick="loadBookings()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>

            <!-- Booking Stats -->
            <div class="kpi-grid" id="bookings-stats">
              <div class="kpi-card">
                <h3>Total Bookings</h3>
                <div class="value" id="totalBookings">0</div>
              </div>
              <div class="kpi-card">
                <h3>Pending</h3>
                <div class="value" id="pendingBookingsCount">0</div>
              </div>
              <div class="kpi-card">
                <h3>In Progress</h3>
                <div class="value" id="inProgressBookings">0</div>
              </div>
              <div class="kpi-card">
                <h3>Completed</h3>
                <div class="value" id="completedBookings">0</div>
              </div>
            </div>

            <!-- Bookings Table -->
            <div class="dashboard-card">
              <div class="section-header">
                <h3>All Bookings</h3>
                <input
                  type="text"
                  id="bookingSearch"
                  class="form-control"
                  placeholder="Search bookings..."
                  style="width: 300px"
                />
              </div>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Booking ID</th>
                    <th>Customer</th>
                    <th>Service</th>
                    <th>Wigs</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bookingsTableBody">
                  <!-- Bookings will be loaded here -->
                </tbody>
              </table>
              <div
                id="bookingsPagination"
                style="margin-top: 20px; text-align: center"
              ></div>
            </div>
          </div>

          <!-- Users Section -->
          <div class="content-section" id="users">
            <div class="section-header">
              <h2>User Management</h2>
              <input
                type="text"
                id="userSearch"
                class="form-control"
                placeholder="Search users..."
                style="width: 300px"
              />
            </div>
            <div class="dashboard-card">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Orders</th>
                    <th>Bookings</th>
                    <th>Last Active</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <!-- Users will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Reports Section -->
      <!-- Reports Section -->
<div class="content-section" id="reports">
  <div class="section-header">
    <h2>Analytics & Reports</h2>
  </div>

  <!-- Date Range Selector -->
  <div class="dashboard-card">
    <div class="form-group">
      <label for="reportRange">Select Date Range</label>
      <select id="reportRange" class="form-control" style="width: 200px; display: inline-block; margin-right: 10px;">
        <option value="1">Today</option>
        <option value="7">Last 7 Days</option>
        <option value="30" selected>Last 30 Days</option>
        <option value="90">Last 90 Days</option>
        <option value="365">Last Year</option>
        <option value="custom">Custom Range</option>
      </select>
      
      <!-- Custom Date Range (Hidden by default) -->
      <div id="customDateRange" style="display: none; margin-top: 10px;">
        <label style="display: block; margin-bottom: 5px;">Custom Date Range:</label>
        <input type="date" id="startDate" class="form-control" style="width: 150px; display: inline-block;">
        <span style="margin: 0 10px;">to</span>
        <input type="date" id="endDate" class="form-control" style="width: 150px; display: inline-block;">
        <button class="action-btn" onclick="applyCustomDateRange()" style="margin-left: 10px;">Apply</button>
      </div>
    </div>
    
    <button class="action-btn" onclick="generateReport()" style="margin-top: 15px;">
      <i class="fas fa-chart-line"></i> Generate Report
    </button>
  </div>

  <!-- Report Summary -->
  <div class="dashboard-card">
    <h3>Report Summary</h3>
    <div id="reportSummary" style="margin-top: 15px;">
      <div style="text-align: center; padding: 40px; color: #666;">
        <i class="fas fa-chart-pie" style="font-size: 48px; margin-bottom: 15px;"></i>
        <p>Select a date range and generate report to view analytics data.</p>
      </div>
    </div>
  </div>

  <!-- Revenue Breakdown Charts -->
  <div class="dashboard-card" id="revenueCharts" style="display: none;">
    <h3>Revenue Breakdown</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
      <div>
        <h4>Revenue Sources</h4>
        <canvas id="revenueChart" height="200"></canvas>
      </div>
      <div>
        <h4>Daily Trend</h4>
        <canvas id="dailyTrendChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Detailed Statistics -->
  <div class="dashboard-card" id="detailedStats" style="display: none;">
    <h3>Detailed Statistics</h3>
    <div class="kpi-grid" style="margin-top: 15px;" id="detailedStatsGrid">
      <!-- Filled by JavaScript -->
    </div>
    
    <!-- Data Tables Toggle -->
    <div style="margin-top: 20px;">
      <button class="action-btn" onclick="toggleDataTable('salesTable')">
        <i class="fas fa-shopping-cart"></i> View Sales Details
      </button>
      <button class="action-btn" onclick="toggleDataTable('bookingsTable')" style="margin-left: 10px;">
        <i class="fas fa-calendar-alt"></i> View Bookings Details
      </button>
      <button class="action-btn" onclick="toggleDataTable('customersTable')" style="margin-left: 10px;">
        <i class="fas fa-users"></i> View Customers List
      </button>
    </div>
    
    <!-- Data Tables -->
    <div id="salesTable" class="data-table-container" style="display: none; margin-top: 20px;">
      <h4>Sales Details</h4>
      <table class="data-table">
        <thead>
          <tr>
            <th>Order #</th>
            <th>Customer</th>
            <th>Date</th>
            <th>Items</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="salesTableBody"></tbody>
      </table>
    </div>
    
    <div id="bookingsTable" class="data-table-container" style="display: none; margin-top: 20px;">
      <h4>Bookings Details</h4>
      <table class="data-table">
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Customer</th>
            <th>Service</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="bookingsTableBody"></tbody>
      </table>
    </div>
    
    <div id="customersTable" class="data-table-container" style="display: none; margin-top: 20px;">
      <h4>Customers List</h4>
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Orders</th>
            <th>Bookings</th>
            <th>Total Spent</th>
            <th>Joined</th>
          </tr>
        </thead>
        <tbody id="customersTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Data Export -->
  <div class="dashboard-card">
    <h3>Data Export</h3>
    <div style="margin-top: 15px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <div class="form-group">
            <label for="exportType">Export Type</label>
            <select id="exportType" class="form-control">
              <option value="summary">Summary Report</option>
              <option value="sales">Sales Details</option>
              <option value="bookings">Bookings Details</option>
              <option value="customers">Customers List</option>
              <option value="all">All Data</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="exportFormat">Export Format</label>
            <select id="exportFormat" class="form-control">
              <option value="csv">CSV (Excel)</option>
              <option value="pdf">PDF Summary</option>
              <option value="detailed-pdf">Detailed PDF</option>
            </select>
          </div>
        </div>
        
        <div style="display: flex; flex-direction: column; justify-content: center;">
          <p><strong>Export Options:</strong></p>
          <div style="margin-top: 10px;">
            <button class="action-btn" onclick="exportReport()" style="width: 100%; margin-bottom: 10px;">
              <i class="fas fa-download"></i> Export Selected Data
            </button>
            <button class="action-btn" onclick="exportAllReports()" style="width: 100%;">
              <i class="fas fa-file-archive"></i> Export Complete Report Package
            </button>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: var(--light-bg); border-radius: 8px;">
        <h4>Export Preview</h4>
        <div id="exportPreview" style="margin-top: 10px; font-size: 12px;">
          Select export options to see preview
        </div>
      </div>
    </div>
  </div>
</div>

          <!-- Other sections would be implemented similarly -->
          <div class="content-section" id="inventory">
            <h2>Inventory Management</h2>
            <!-- Inventory management content -->
          </div>

          <div class="content-section" id="marketing">
            <h2>Marketing Tools</h2>
            <!-- Marketing content -->
          </div>

          <div class="content-section" id="settings">
            <h2>Admin Settings</h2>
            <!-- Settings content -->
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

<script>
  // ==================== ENHANCED REPORTS MODULE ====================
let ChartJS = null;
let revenueChartInstance = null;
let trendChartInstance = null;

// Load Chart.js dynamically
async function loadChartJS() {
  if (!ChartJS) {
    return new Promise((resolve) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
      script.onload = () => {
        ChartJS = window.Chart;
        resolve();
      };
      document.head.appendChild(script);
    });
  }
  return Promise.resolve();
}

// Initialize report section
async function initializeReports() {
  await loadChartJS();
  setupReportEventListeners();
}

// Setup report event listeners
function setupReportEventListeners() {
  // Date range change
  const reportRange = document.getElementById('reportRange');
  if (reportRange) {
    reportRange.addEventListener('change', function() {
      if (this.value === 'custom') {
        document.getElementById('customDateRange').style.display = 'block';
      } else {
        document.getElementById('customDateRange').style.display = 'none';
      }
    });
  }
  
  // Export format change
  const exportFormat = document.getElementById('exportFormat');
  const exportType = document.getElementById('exportType');
  if (exportFormat && exportType) {
    exportFormat.addEventListener('change', updateExportPreview);
    exportType.addEventListener('change', updateExportPreview);
  }
  
  // Set default dates for custom range
  const endDate = document.getElementById('endDate');
  const startDate = document.getElementById('startDate');
  if (endDate && startDate) {
    const today = new Date().toISOString().split('T')[0];
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
    
    endDate.value = today;
    startDate.value = thirtyDaysAgoStr;
    endDate.max = today;
    startDate.max = today;
  }
}

// Apply custom date range
function applyCustomDateRange() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  
  if (!startDate || !endDate) {
    showNotification('Please select both start and end dates', 'error');
    return;
  }
  
  if (new Date(startDate) > new Date(endDate)) {
    showNotification('Start date cannot be after end date', 'error');
    return;
  }
  
  generateReport('custom', startDate, endDate);
}

// Generate comprehensive report
async function generateReport(rangeType = null, startDate = null, endDate = null) {
  try {
    showNotification('Generating report...', 'info');
    
    let days = rangeType || document.getElementById('reportRange').value;
    let queryParams = '';
    
    if (days === 'custom' && startDate && endDate) {
      queryParams = `?startDate=${startDate}&endDate=${endDate}`;
    } else {
      queryParams = `?days=${days}`;
    }
    
    // Fetch comprehensive report data
    const reportData = await fetchComprehensiveReportData(queryParams);
    
    // Display report summary
    displayReportSummary(reportData);
    
    // Show charts and detailed stats
    document.getElementById('revenueCharts').style.display = 'block';
    document.getElementById('detailedStats').style.display = 'block';
    
    // Generate charts
    generateRevenueChart(reportData);
    generateDailyTrendChart(reportData);
    
    // Update detailed statistics
    updateDetailedStatistics(reportData);
    
    // Update export preview
    updateExportPreview();
    
    showNotification('Report generated successfully!', 'success');
    
  } catch (error) {
    console.error('Generate report error:', error);
    showNotification('Failed to generate report', 'error');
  }
}

// Fetch comprehensive report data
async function fetchComprehensiveReportData(queryParams) {
  try {
    // Fetch all report data in parallel
    const [salesResult, bookingsResult, customersResult] = await Promise.all([
      ApiClient.authenticatedRequest(`${ENDPOINTS.SALES_REPORT}${queryParams}`),
      ApiClient.authenticatedRequest(`${ENDPOINTS.BOOKINGS_STATS}${queryParams}`),
      ApiClient.authenticatedRequest(`${ENDPOINTS.USERS}/reports${queryParams}`)
    ]);
    
    let reportData = {
      period: queryParams.includes('startDate') ? 'Custom Range' : queryParams.replace('?days=', '') + ' days',
      sales: {},
      bookings: {},
      customers: {},
      exportData: {}
    };
    
    // Process sales data
    if (salesResult.ok) {
      reportData.sales = salesResult.data;
    } else {
      reportData.sales = {
        totalSales: 0,
        totalOrders: 0,
        averageOrderValue: 0,
        dailyData: [],
        topProducts: [],
        orders: []
      };
    }
    
    // Process bookings data
    if (bookingsResult.ok) {
      reportData.bookings = bookingsResult.data;
    } else {
      reportData.bookings = {
        totalBookings: 0,
        bookingRevenue: 0,
        averageBookingValue: 0,
        statusBreakdown: {},
        bookings: []
      };
    }
    
    // Process customers data
    if (customersResult.ok) {
      reportData.customers = customersResult.data;
    } else {
      reportData.customers = {
        totalCustomers: 0,
        newCustomers: 0,
        activeCustomers: 0,
        customers: []
      };
    }
    
    // Prepare export data
    reportData.exportData = {
      summary: generateSummaryData(reportData),
      sales: reportData.sales.orders || [],
      bookings: reportData.bookings.bookings || [],
      customers: reportData.customers.customers || []
    };
    
    return reportData;
    
  } catch (error) {
    console.error('Fetch report data error:', error);
    throw error;
  }
}

// Generate summary data for export
function generateSummaryData(reportData) {
  const totalRevenue = (reportData.sales.totalSales || 0) + (reportData.bookings.bookingRevenue || 0);
  const totalOrders = reportData.sales.totalOrders || 0;
  const totalBookings = reportData.bookings.totalBookings || 0;
  const newCustomers = reportData.customers.newCustomers || 0;
  
  return {
    period: reportData.period,
    totalRevenue,
    totalOrders,
    totalBookings,
    newCustomers,
    salesRevenue: reportData.sales.totalSales || 0,
    bookingRevenue: reportData.bookings.bookingRevenue || 0,
    averageOrderValue: reportData.sales.averageOrderValue || 0,
    averageBookingValue: reportData.bookings.averageBookingValue || 0,
    generatedAt: new Date().toISOString()
  };
}

// Display report summary
function displayReportSummary(reportData) {
  const summaryContainer = document.getElementById('reportSummary');
  
  const totalRevenue = (reportData.sales.totalSales || 0) + (reportData.bookings.bookingRevenue || 0);
  const totalOrders = reportData.sales.totalOrders || 0;
  const totalBookings = reportData.bookings.totalBookings || 0;
  const newCustomers = reportData.customers.newCustomers || 0;
  
  summaryContainer.innerHTML = `
    <div class="kpi-grid">
      <div class="kpi-card">
        <h3>Total Revenue</h3>
        <div class="value">â‚¬${totalRevenue.toFixed(2)}</div>
        <small>Sales: â‚¬${(reportData.sales.totalSales || 0).toFixed(2)} | Bookings: â‚¬${(reportData.bookings.bookingRevenue || 0).toFixed(2)}</small>
      </div>
      <div class="kpi-card">
        <h3>Total Orders</h3>
        <div class="value">${totalOrders}</div>
        <small>Avg Order: â‚¬${(reportData.sales.averageOrderValue || 0).toFixed(2)}</small>
      </div>
      <div class="kpi-card">
        <h3>Total Bookings</h3>
        <div class="value">${totalBookings}</div>
        <small>Completed: ${reportData.bookings.statusBreakdown?.completed || 0}</small>
      </div>
      <div class="kpi-card">
        <h3>New Customers</h3>
        <div class="value">${newCustomers}</div>
        <small>Active: ${reportData.customers.activeCustomers || 0}</small>
      </div>
    </div>
    
    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <p><strong>Report Period:</strong> Last ${reportData.period}</p>
        <p><strong>Date Range:</strong> ${getDateRangeText()}</p>
      </div>
      <div>
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
        <p><strong>Data Source:</strong> Live System Data</p>
      </div>
    </div>
  `;
}

// Get date range text
function getDateRangeText() {
  const range = document.getElementById('reportRange').value;
  if (range === 'custom') {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    return `${start} to ${end}`;
  }
  
  const today = new Date();
  const startDate = new Date();
  startDate.setDate(today.getDate() - parseInt(range));
  
  return `${startDate.toLocaleDateString()} to ${today.toLocaleDateString()}`;
}

// Generate revenue chart
function generateRevenueChart(reportData) {
  const ctx = document.getElementById('revenueChart');
  if (!ctx) return;
  
  if (revenueChartInstance) {
    revenueChartInstance.destroy();
  }
  
  const salesRevenue = reportData.sales.totalSales || 0;
  const bookingRevenue = reportData.bookings.bookingRevenue || 0;
  
  revenueChartInstance = new ChartJS(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Sales Revenue', 'Booking Revenue'],
      datasets: [{
        data: [salesRevenue, bookingRevenue],
        backgroundColor: ['#392625', '#c8b4a8'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              const total = salesRevenue + bookingRevenue;
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `â‚¬${value.toFixed(2)} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

// Generate daily trend chart
function generateDailyTrendChart(reportData) {
  const ctx = document.getElementById('dailyTrendChart');
  if (!ctx) return;
  
  if (trendChartInstance) {
    trendChartInstance.destroy();
  }
  
  // Use actual daily data or generate sample
  const dailyData = reportData.sales.dailyData || generateSampleDailyData();
  const dates = dailyData.map(item => item.date.split('-').slice(1).join('/'));
  const amounts = dailyData.map(item => item.amount);
  
  trendChartInstance = new ChartJS(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Daily Revenue (â‚¬)',
        data: amounts,
        borderColor: '#392625',
        backgroundColor: 'rgba(57, 38, 37, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        }
      }
    }
  });
}

// Generate sample daily data for demo
function generateSampleDailyData() {
  const data = [];
  const today = new Date();
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(today.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    const amount = Math.floor(Math.random() * 1000) + 100;
    
    data.push({ date: dateStr, amount });
  }
  
  return data;
}

// Update detailed statistics
function updateDetailedStatistics(reportData) {
  const statsGrid = document.getElementById('detailedStatsGrid');
  
  const stats = [
    {
      title: 'Average Order Value',
      value: `â‚¬${(reportData.sales.averageOrderValue || 0).toFixed(2)}`,
      icon: 'fa-euro-sign'
    },
    {
      title: 'Average Booking Value',
      value: `â‚¬${(reportData.bookings.averageBookingValue || 0).toFixed(2)}`,
      icon: 'fa-calendar-check'
    },
    {
      title: 'Sales Growth',
      value: '+12.5%',
      icon: 'fa-chart-line',
      trend: 'up'
    },
    {
      title: 'Customer Retention',
      value: '78%',
      icon: 'fa-user-check'
    },
    {
      title: 'Top Product Category',
      value: reportData.sales.topProducts?.[0]?.category || 'Wigs',
      icon: 'fa-star'
    },
    {
      title: 'Most Popular Service',
      value: 'Wig Renovation',
      icon: 'fa-award'
    }
  ];
  
  statsGrid.innerHTML = stats.map(stat => `
    <div class="dashboard-card" style="padding: 15px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas ${stat.icon}" style="font-size: 24px; color: var(--cream);"></i>
        <div>
          <h4 style="margin: 0; font-size: 14px; color: #666;">${stat.title}</h4>
          <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">${stat.value}</div>
        </div>
      </div>
    </div>
  `).join('');
  
  // Update data tables
  updateDataTables(reportData);
}

// Update data tables
function updateDataTables(reportData) {
  // Sales table
  updateSalesTable(reportData.sales.orders || []);
  
  // Bookings table
  updateBookingsTable(reportData.bookings.bookings || []);
  
  // Customers table
  updateCustomersTable(reportData.customers.customers || []);
}

function updateSalesTable(orders) {
  const tbody = document.getElementById('salesTableBody');
  tbody.innerHTML = '';
  
  if (orders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No sales data available</td></tr>';
    return;
  }
  
  orders.slice(0, 10).forEach(order => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>#${order.orderNumber || 'N/A'}</td>
      <td>${order.customerName || 'Unknown'}</td>
      <td>${new Date(order.createdAt || order.date).toLocaleDateString()}</td>
      <td>${order.itemsCount || 0}</td>
      <td>â‚¬${(order.totalAmount || 0).toFixed(2)}</td>
      <td><span class="status-badge status-${order.status || 'pending'}">${order.status || 'Pending'}</span></td>
    `;
    tbody.appendChild(row);
  });
}

function updateBookingsTable(bookings) {
  const tbody = document.getElementById('bookingsTableBody');
  tbody.innerHTML = '';
  
  if (bookings.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No bookings data available</td></tr>';
    return;
  }
  
  bookings.slice(0, 10).forEach(booking => {
    const customerName = booking.customerName || 
                        (booking.userId ? `${booking.userId.firstName} ${booking.userId.lastName}` : 'Unknown');
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>#${booking._id?.substring(0, 8) || 'N/A'}</td>
      <td>${customerName}</td>
      <td>${booking.service || 'Wig Renovation'}</td>
      <td>${new Date(booking.createdAt).toLocaleDateString()}</td>
      <td>â‚¬${(booking.totalPrice || (booking.wigCount * 15) || 0).toFixed(2)}</td>
      <td><span class="status-badge status-${booking.status?.replace('_', '-')}">${booking.status || 'pending'}</span></td>
    `;
    tbody.appendChild(row);
  });
}

function updateCustomersTable(customers) {
  const tbody = document.getElementById('customersTableBody');
  tbody.innerHTML = '';
  
  if (customers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No customers data available</td></tr>';
    return;
  }
  
  customers.slice(0, 10).forEach(customer => {
    const name = customer.name || `${customer.firstName || ''} ${customer.lastName || ''}`.trim();
    const totalSpent = (customer.totalOrdersValue || 0) + (customer.totalBookingsValue || 0);
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${name}</td>
      <td>${customer.email || 'N/A'}</td>
      <td>${customer.phone || 'N/A'}</td>
      <td>${customer.ordersCount || 0}</td>
      <td>${customer.bookingsCount || 0}</td>
      <td>â‚¬${totalSpent.toFixed(2)}</td>
      <td>${new Date(customer.createdAt || customer.joinedDate).toLocaleDateString()}</td>
    `;
    tbody.appendChild(row);
  });
}

// Toggle data tables
function toggleDataTable(tableId) {
  const table = document.getElementById(tableId);
  const allTables = document.querySelectorAll('.data-table-container');
  
  allTables.forEach(t => {
    if (t.id !== tableId) {
      t.style.display = 'none';
    }
  });
  
  if (table.style.display === 'none') {
    table.style.display = 'block';
  } else {
    table.style.display = 'none';
  }
}

// Update export preview
function updateExportPreview() {
  const exportType = document.getElementById('exportType').value;
  const exportFormat = document.getElementById('exportFormat').value;
  const preview = document.getElementById('exportPreview');
  
  const formatNames = {
    'csv': 'CSV (Excel compatible)',
    'pdf': 'PDF Document',
    'detailed-pdf': 'Detailed PDF Report'
  };
  
  const typeNames = {
    'summary': 'Summary Report',
    'sales': 'Sales Details',
    'bookings': 'Bookings Details',
    'customers': 'Customers List',
    'all': 'Complete Report Package'
  };
  
  preview.innerHTML = `
    <div style="display: flex; justify-content: space-between;">
      <div>
        <p><strong>Export Type:</strong> ${typeNames[exportType]}</p>
        <p><strong>Format:</strong> ${formatNames[exportFormat]}</p>
      </div>
      <div>
        <p><strong>Estimated Size:</strong> ${getEstimatedSize(exportType, exportFormat)}</p>
        <p><strong>Includes:</strong> ${getIncludedData(exportType)}</p>
      </div>
    </div>
  `;
}

function getEstimatedSize(type, format) {
  const sizes = {
    'csv': '10-50 KB',
    'pdf': '100-500 KB',
    'detailed-pdf': '500 KB - 2 MB'
  };
  return sizes[format] || 'Unknown';
}

function getIncludedData(type) {
  const includes = {
    'summary': 'Summary metrics and charts',
    'sales': 'All sales transactions',
    'bookings': 'All booking records',
    'customers': 'Customer database',
    'all': 'Complete dataset'
  };
  return includes[type] || 'Selected data';
}

// Export report
async function exportReport() {
  try {
    const exportType = document.getElementById('exportType').value;
    const exportFormat = document.getElementById('exportFormat').value;
    const days = document.getElementById('reportRange').value;
    
    showNotification(`Preparing ${exportType} export...`, 'info');
    
    let url, filename, params;
    const dateStr = new Date().toISOString().split('T')[0];
    
    // Build parameters based on selection
    params = `type=${exportType}&format=${exportFormat}&days=${days}`;
    
    if (days === 'custom') {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      params += `&startDate=${startDate}&endDate=${endDate}`;
    }
    
    // Determine endpoint and filename
    if (exportFormat === 'csv') {
      url = `${ENDPOINTS.EXPORT_CSV}?${params}`;
      filename = `${exportType}_report_${dateStr}.csv`;
    } else if (exportFormat === 'pdf') {
      url = `${ENDPOINTS.EXPORT_PDF}?${params}`;
      filename = `${exportType}_summary_${dateStr}.pdf`;
    } else if (exportFormat === 'detailed-pdf') {
      url = `${ENDPOINTS.EXPORT_DETAILED_PDF}?${params}`;
      filename = `${exportType}_detailed_report_${dateStr}.pdf`;
    }
    
    // Make API request
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${AppState.authToken}`
      }
    });
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.message || `Export failed: ${response.statusText}`);
    }
    
    // Get blob and create download
    const blob = await response.blob();
    const downloadUrl = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(downloadUrl);
    
    showNotification(`${exportType} exported successfully as ${exportFormat.toUpperCase()}!`, 'success');
    
  } catch (error) {
    console.error('Export error:', error);
    showNotification(`Export failed: ${error.message}`, 'error');
  }
}

// Export all reports (complete package)
async function exportAllReports() {
  if (!confirm('This will export a complete report package with all data types. Continue?')) {
    return;
  }
  
  try {
    showNotification('Preparing complete report package...', 'info');
    
    const days = document.getElementById('reportRange').value;
    const dateStr = new Date().toISOString().split('T')[0];
    let params = `days=${days}`;
    
    if (days === 'custom') {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      params += `&startDate=${startDate}&endDate=${endDate}`;
    }
    
    // Request ZIP file with all reports
    const response = await fetch(`${ENDPOINTS.EXPORT_CSV}/complete?${params}`, {
      headers: {
        'Authorization': `Bearer ${AppState.authToken}`
      }
    });
    
    if (!response.ok) {
      throw new Error(`Export failed: ${response.statusText}`);
    }
    
    // Get blob and create download
    const blob = await response.blob();
    const downloadUrl = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `complete_report_package_${dateStr}.zip`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(downloadUrl);
    
    showNotification('Complete report package exported successfully!', 'success');
    
  } catch (error) {
    console.error('Export all error:', error);
    showNotification(`Export failed: ${error.message}`, 'error');
  }
}

      // ==================== ENHANCED ADMIN DASHBOARD ====================
     // Dynamic API URL configuration
      const API_BASE_URL = 
           //"http://localhost:5001/api";
           "https://olyshairi-e-commerce-hairspo-online-kgz2.onrender.com/api";

      console.log("ðŸŒ Using API Base URL:", API_BASE_URL);
      const ENDPOINTS = {
        ADMIN_LOGIN: `${API_BASE_URL}/admin/auth/login`,
        ADMIN_REGISTER: `${API_BASE_URL}/admin/auth/register`,
        ADMIN_PROFILE: `${API_BASE_URL}/admin/auth/profile`,
        PRODUCTS: `${API_BASE_URL}/admin/products`,
        PUBLIC_PRODUCTS: `${API_BASE_URL}/products`,
        ORDERS: `${API_BASE_URL}/admin/orders`,
        UPDATE_ORDER: `${API_BASE_URL}/admin/orders`, 
        BOOKINGS: `${API_BASE_URL}/bookings/all`,
        UPDATE_BOOKING_STATUS: `${API_BASE_URL}/bookings`,
        BOOKINGS_STATS: `${API_BASE_URL}/bookings/stats`,
        USERS: `${API_BASE_URL}/admin/users`,
        USER_DETAILS: `${API_BASE_URL}/admin/users`,
        USER_STATUS: `${API_BASE_URL}/admin/users`,
        ACTIVITIES: `${API_BASE_URL}/admin/activities/dashboard-stats`,
        RECENT_ACTIVITIES: `${API_BASE_URL}/admin/activities/recent-activities`,
        SALES_ANALYTICS: `${API_BASE_URL}/admin/activities/sales-analytics`,
        HEALTH: `${API_BASE_URL}/health`,
        ADMIN_HEALTH: `${API_BASE_URL}/admin/health`,
        DELETE_BOOKING: `${API_BASE_URL}/bookings`,
        DELETE_ORDER: `${API_BASE_URL}/admin/orders`,
        ORDER_DETAILS: `${API_BASE_URL}/admin/orders`,
       UPDATE_ORDER_STATUS: `${API_BASE_URL}/admin/orders/status`,
        RESTORE_BOOKING: `${API_BASE_URL}/bookings`,
        BOOKING_TRASH: `${API_BASE_URL}/bookings/trash`,
        BULK_DELETE_BOOKINGS: `${API_BASE_URL}/bookings/bulk-delete`,
        BULK_DELETE_ORDERS: `${API_BASE_URL}/admin/orders/bulk-delete`,
        ORDER_TRASH: `${API_BASE_URL}/admin/orders/trash`,
        RESTORE_ORDER: `${API_BASE_URL}/admin/orders`,
        SALES_REPORT: `${API_BASE_URL}/admin/reports/sales`,
        EXPORT_CSV: `${API_BASE_URL}/admin/reports/export/csv`,
        EXPORT_PDF: `${API_BASE_URL}/admin/reports/export/pdf`,
        EXPORT_DETAILED_PDF: `${API_BASE_URL}/admin/reports/export/detailed-pdf`,
          BOOKINGS_REPORT: `${API_BASE_URL}/admin/reports/bookings`,
            EXPORT_COMPLETE: `${API_BASE_URL}/admin/reports/export/complete`,
      };

      // ==================== ENHANCED STATE MANAGEMENT ====================
      const AppState = {
        currentUser: null,
        authToken: localStorage.getItem("adminToken"),
        isTokenVerified: false,
        products: [],
        orders: [],
        bookings: [],
        users: [],
        currentPage: 1,
        productsPerPage: 10,
        ordersPerPage: 10,
        bookingsPerPage: 10,
        dataCache: new Map(),
        apiRetryCount: new Map(),
        MAX_RETRIES: 3,
      };

      // ==================== ENHANCED UTILITY FUNCTIONS ====================

      // Safe data sanitization
      const SecurityUtils = {
        sanitizeInput: (input) => {
          if (typeof input !== "string") return input;
          const div = document.createElement("div");
          div.textContent = input;
          return div.innerHTML;
        },

        safeJSONParse: (jsonString) => {
          try {
            return JSON.parse(jsonString);
          } catch {
            return null;
          }
        },

        validateEmail: (email) => {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
        },
      };

      // Enhanced caching system
      const CacheManager = {
        set: (key, data, ttl = 300000) => {
          // 5 minutes default
          AppState.dataCache.set(key, {
            data,
            timestamp: Date.now(),
            ttl,
          });
        },

        get: (key) => {
          const cached = AppState.dataCache.get(key);
          if (!cached) return null;

          if (Date.now() - cached.timestamp > cached.ttl) {
            AppState.dataCache.delete(key);
            return null;
          }

          return cached.data;
        },

        clear: (pattern = null) => {
          if (pattern) {
            for (const key of AppState.dataCache.keys()) {
              if (key.includes(pattern)) {
                AppState.dataCache.delete(key);
              }
            }
          } else {
            AppState.dataCache.clear();
          }
        },
      };

      // ==================== ENHANCED API CLIENT ====================
      const ApiClient = {
        async request(url, options = {}) {
          const cacheKey = `api_${url}_${JSON.stringify(options)}`;
          const cached = CacheManager.get(cacheKey);

          // Return cached non-GET requests for better performance
          if (cached && (!options.method || options.method === "GET")) {
            console.log("ðŸ“¦ Returning cached data for:", url);
            return { ok: true, data: cached };
          }

          const defaultOptions = {
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              ...options.headers,
            },
            timeout: 30000,
          };

          const mergedOptions = { ...defaultOptions, ...options };

          // Add authorization if token exists
          if (
            AppState.authToken &&
            !url.includes("/auth/login") &&
            !url.includes("/auth/register")
          ) {
            mergedOptions.headers.Authorization = `Bearer ${AppState.authToken}`;
          }

          try {
            console.log("ðŸŒ API Request:", {
              url,
              method: mergedOptions.method || "GET",
            });

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);
            mergedOptions.signal = controller.signal;

            const response = await fetch(url, mergedOptions);
            clearTimeout(timeoutId);

            const data = await response.json().catch(() => null);

            if (response.ok) {
              // Cache successful GET responses
              if (!options.method || options.method === "GET") {
                CacheManager.set(cacheKey, data);
              }
              return { ok: true, data, response };
            } else {
              throw new Error(data?.error || `HTTP ${response.status}`);
            }
          } catch (error) {
            console.error("âŒ API Request Failed:", error.message);

            // Retry logic for network errors
            const retryCount = AppState.apiRetryCount.get(url) || 0;
            if (
              error.name === "AbortError" &&
              retryCount < AppState.MAX_RETRIES
            ) {
              console.log(
                `ðŸ”„ Retrying request (${retryCount + 1}/${
                  AppState.MAX_RETRIES
                })...`
              );
              AppState.apiRetryCount.set(url, retryCount + 1);
              await new Promise((resolve) =>
                setTimeout(resolve, 1000 * (retryCount + 1))
              );
              return this.request(url, options);
            }

            AppState.apiRetryCount.delete(url);
            return {
              ok: false,
              error: error.message,
              status: error.name === "AbortError" ? 408 : 500,
            };
          }
        },

        async authenticatedRequest(url, options = {}) {
          if (!AppState.authToken) {
            showNotification(
              "Authentication required. Please login again.",
              "error"
            );
            handleLogout();
            return { ok: false, error: "No authentication token" };
          }

          return this.request(url, options);
        },
      };

      // ==================== ENHANCED ERROR HANDLER ====================
      const ErrorHandler = {
        handleApiError(error, context = "") {
          console.error(`âŒ ${context} Error:`, error);

          const message = error.message || "An unexpected error occurred";
          let userMessage = message;
          let type = "error";

          if (error.status === 401) {
            userMessage = "Session expired. Please login again.";
            handleLogout();
          } else if (error.status === 403) {
            userMessage = "Access denied. Insufficient permissions.";
          } else if (error.status === 404) {
            userMessage = "Requested resource not found.";
            type = "warning";
          } else if (error.status === 408 || error.name === "AbortError") {
            userMessage = "Request timeout. Please check your connection.";
          } else if (error.status >= 500) {
            userMessage = "Server error. Please try again later.";
          }

          showNotification(userMessage, type);
          return { success: false, error: userMessage };
        },

        wrapAsync(fn, context = "") {
          return async (...args) => {
            try {
              return await fn(...args);
            } catch (error) {
              return this.handleApiError(error, context);
            }
          };
        },
      };

      // ==================== ENHANCED INITIALIZATION ====================
      document.addEventListener("DOMContentLoaded", function () {
        initializeApp();
      });

      async function initializeApp() {
        console.log("ðŸš€ Initializing Enhanced Admin Dashboard...");

        // Test API connectivity first
        const isApiReachable = await testApiConnectivity();

        if (!isApiReachable) {
          showNotification(
            "Cannot connect to server. Please ensure the backend is running.",
            "error"
          );
        }

        // Check if user is already logged in
        if (AppState.authToken) {
          await verifyTokenAndLoadDashboard();
        } else {
          showLogin();
        }

        setupEventListeners();
        setupPerformanceMonitoring();
      }

      // ==================== ENHANCED AUTHENTICATION ====================
      async function testApiConnectivity() {
        try {
          console.log("ðŸ§ª Testing API connectivity...");
          const result = await ApiClient.request(ENDPOINTS.HEALTH);
          return result.ok;
        } catch (error) {
          console.error("âŒ API server is not reachable:", error);
          return false;
        }
      }

      async function verifyTokenAndLoadDashboard() {
        if (!AppState.authToken) {
          console.log("âŒ No token found in localStorage");
          showLogin();
          return;
        }

        try {
          console.log("ðŸ” Verifying admin token...");
          const result = await ApiClient.authenticatedRequest(
            ENDPOINTS.ADMIN_PROFILE
          );

          if (result.ok) {
            AppState.currentUser = result.data.user;
            AppState.isTokenVerified = true;
            console.log("âœ… Token verified successfully");
            showDashboard();
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.log("âŒ Token verification failed:", error);
          localStorage.removeItem("adminToken");
          AppState.authToken = null;
          showNotification("Session expired. Please login again.", "error");
          showLogin();
        }
      }

      // ==================== ENHANCED UI MANAGEMENT ====================
      function showLogin() {
        document.getElementById("loginContainer").style.display = "flex";
        document.getElementById("registerContainer").style.display = "none";
        document.getElementById("dashboard").style.display = "none";
      }

      function showRegister() {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("registerContainer").style.display = "flex";
        document.getElementById("dashboard").style.display = "none";
      }

      function showDashboard() {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("registerContainer").style.display = "none";
        document.getElementById("dashboard").style.display = "block";

        // Update admin info
        if (AppState.currentUser) {
          const name = SecurityUtils.sanitizeInput(
            `${AppState.currentUser.firstName} ${AppState.currentUser.lastName}`
          );
          document.getElementById("adminName").textContent = name;
          document.getElementById("adminGreeting").textContent =
            SecurityUtils.sanitizeInput(AppState.currentUser.firstName);
          document.getElementById(
            "welcomeMessage"
          ).textContent = `Welcome, ${SecurityUtils.sanitizeInput(
            AppState.currentUser.firstName
          )}`;
        }

        loadDashboardData();
      }

      // ==================== ENHANCED SECTION MANAGEMENT ====================
      function switchSection(sectionId) {
        // Hide all sections with animation
        document.querySelectorAll(".content-section").forEach((section) => {
          section.classList.remove("active");
        });

        // Show the selected section
        const targetSection = document.getElementById(sectionId);
        targetSection.classList.add("active");

        // Update sidebar active state
        document.querySelectorAll(".sidebar-bubble").forEach((bubble) => {
          bubble.classList.remove("active");
          if (bubble.getAttribute("data-section") === sectionId) {
            bubble.classList.add("active");
          }
        });

        // Load section-specific data with debouncing
        clearTimeout(window.sectionLoadTimeout);
        window.sectionLoadTimeout = setTimeout(() => {
          loadSectionData(sectionId);
        }, 50);
      }

      async function loadSectionData(sectionId) {
        switch (sectionId) {
          case "reports":
            await loadReports();
            break;
          case "products":
            await loadProducts();
            break;
          case "orders":
            await loadOrders();
            break;
          case "bookings":
            await loadBookings();
            break;
          case "users":
            await loadUsers();
            break;
          default:
            // No data loading needed for other sections
            break;
        }
      }

      // ==================== ENHANCED DATA LOADING ====================
// ==================== ENHANCED DASHBOARD DATA FETCHING ====================
async function loadDashboardData() {
  try {
    console.log("ðŸ“Š Loading real dashboard data...");
    
    // Fetch all necessary data in parallel
    const [ordersResult, bookingsResult, salesStatsResult] = await Promise.allSettled([
      ApiClient.authenticatedRequest(ENDPOINTS.ORDERS),
      ApiClient.authenticatedRequest(ENDPOINTS.BOOKINGS),
      ApiClient.authenticatedRequest(`${ENDPOINTS.SALES_ANALYTICS}?days=1`) // Get today's sales
    ]);

    let orders = [];
    let bookings = [];
    let todaySales = 0;
    let todayBookingRevenue = 0;
    let newOrdersCount = 0;
    let pendingBookingsCount = 0;

    // Process orders data
    if (ordersResult.status === "fulfilled" && ordersResult.value.ok) {
      orders = ordersResult.value.data.orders || ordersResult.value.data || [];
      AppState.orders = orders;
      
      // Calculate today's sales
      const today = new Date().toISOString().split('T')[0];
      todaySales = orders
        .filter(order => {
          const orderDate = new Date(order.createdAt || order.orderDate || order.date).toISOString().split('T')[0];
          return orderDate === today && order.status !== 'cancelled';
        })
        .reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      
      // Count new orders (today's orders)
      newOrdersCount = orders.filter(order => {
        const orderDate = new Date(order.createdAt || order.orderDate || order.date).toISOString().split('T')[0];
        return orderDate === today && order.status !== 'cancelled';
      }).length;
      
      console.log(`ðŸ“¦ Found ${orders.length} total orders, ${newOrdersCount} new today, â‚¬${todaySales.toFixed(2)} in sales`);
    }

    // Process bookings data
    if (bookingsResult.status === "fulfilled" && bookingsResult.value.ok) {
      bookings = bookingsResult.value.data.bookings || bookingsResult.value.data || [];
      
      // Filter out deleted bookings
      bookings = bookings.filter(booking => 
        !booking.isDeleted && booking.status !== 'deleted'
      );
      
      AppState.bookings = bookings;
      
      // Calculate today's booking revenue and pending bookings
      const today = new Date().toISOString().split('T')[0];
      
      todayBookingRevenue = bookings
        .filter(booking => {
          const bookingDate = new Date(booking.createdAt || booking.date).toISOString().split('T')[0];
          return bookingDate === today && booking.status !== 'cancelled';
        })
        .reduce((sum, booking) => sum + (booking.totalPrice || (booking.wigCount * 15) || 0), 0);
      
      // Count pending bookings (status: pending)
      pendingBookingsCount = bookings.filter(booking => 
        booking.status === 'pending' || booking.status === 'confirmed'
      ).length;
      
      // Update recent bookings (last 5 non-deleted bookings)
      const recentBookings = bookings
        .slice(0, 5)
        .map(booking => ({
          ...booking,
          customerName: booking.customerName || 
                       (booking.userId ? `${booking.userId.firstName} ${booking.userId.lastName}` : 'Unknown'),
          createdDate: new Date(booking.createdAt).toLocaleDateString()
        }));
      
      updateRecentBookings(recentBookings);
      
      console.log(`ðŸ“… Found ${bookings.length} total bookings, ${pendingBookingsCount} pending, â‚¬${todayBookingRevenue.toFixed(2)} in revenue`);
    }

    // Get sales stats if available
    if (salesStatsResult.status === "fulfilled" && salesStatsResult.value.ok) {
      const stats = salesStatsResult.value.data;
      if (stats.totalSalesToday !== undefined) todaySales = stats.totalSalesToday;
      if (stats.bookingRevenue !== undefined) todayBookingRevenue = stats.bookingRevenue;
      if (stats.newOrdersCount !== undefined) newOrdersCount = stats.newOrdersCount;
      if (stats.pendingBookings !== undefined) pendingBookingsCount = stats.pendingBookings;
    }

    // Update dashboard with real data
    updateDashboardWithRealData({
      totalSalesToday: todaySales,
      newOrdersCount: newOrdersCount,
      pendingBookingsCount: pendingBookingsCount,
      bookingRevenue: todayBookingRevenue
    });

  } catch (error) {
    console.error("âŒ Error loading dashboard data:", error);
    ErrorHandler.handleApiError(error, "Dashboard data loading");
    
    // Fallback to showing zero/empty state
    updateDashboardWithRealData({
      totalSalesToday: 0,
      newOrdersCount: 0,
      pendingBookingsCount: 0,
      bookingRevenue: 0
    });
    updateRecentBookings([]);
  }
}

// ==================== UPDATE DASHBOARD WITH REAL DATA ====================
function updateDashboardWithRealData(stats) {
  // Update KPI cards
  document.getElementById("totalSales").textContent = `â‚¬${(stats.totalSalesToday || 0).toFixed(2)}`;
  document.getElementById("newOrders").textContent = stats.newOrdersCount || 0;
  document.getElementById("pendingBookings").textContent = stats.pendingBookingsCount || 0;
  document.getElementById("bookingRevenue").textContent = `â‚¬${(stats.bookingRevenue || 0).toFixed(2)}`;
  
  // Also update booking stats in bookings section
  const pendingElement = document.getElementById('pendingBookingsCount');
  if (pendingElement) {
    pendingElement.textContent = stats.pendingBookingsCount || 0;
  }
}

// ==================== ENHANCED RECENT BOOKINGS UPDATE ====================
function updateRecentBookings(recentBookings) {
  const container = document.getElementById("recentBookings");
  if (!container) {
    console.warn("âŒ Recent bookings container not found");
    return;
  }

  container.innerHTML = "";

  if (!recentBookings || recentBookings.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 20px;">
          <div style="display: flex; flex-direction: column; align-items: center; color: #666;">
            <i class="fas fa-calendar-times" style="font-size: 24px; margin-bottom: 10px;"></i>
            <span>No recent bookings</span>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  recentBookings.forEach((booking) => {
    const row = document.createElement("tr");
    
    // Get customer name safely
    const customerName = booking.customerName || 
                        (booking.userId ? `${booking.userId.firstName} ${booking.userId.lastName}` : 'Unknown');
    
    // Format status for display
    const status = booking.status || 'pending';
    const statusClass = `status-${status.replace('_', '-')}`;
    const statusDisplay = status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ');
    
    // Format date
    const createdDate = booking.createdDate || 
                       (booking.createdAt ? new Date(booking.createdAt).toLocaleDateString() : 'N/A');

    row.innerHTML = `
      <td>${SecurityUtils.sanitizeInput(customerName)}</td>
      <td>${booking.service || 'Wig Renovation'}</td>
      <td>${booking.wigCount || 0}</td>
      <td><span class="status-badge ${statusClass}">${statusDisplay}</span></td>
      <td>${createdDate}</td>
      <td>
        <button class="action-btn view-booking" data-id="${booking._id || booking.id}" title="View details">
          <i class="fas fa-eye"></i> View
        </button>
      </td>
    `;

    container.appendChild(row);
  });

  // Add event listeners to view buttons
  document.querySelectorAll('.view-booking').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const bookingId = e.target.closest('button').dataset.id;
      viewBookingDetails(bookingId);
    });
  });

  console.log(`âœ… Updated recent bookings with ${recentBookings.length} bookings`);
}

// ==================== ENHANCED BOOKINGS SECTION DATA ====================
async function loadBookings() {
  try {
    console.log('ðŸ”„ Loading bookings for bookings section...');
    
    const result = await ApiClient.authenticatedRequest(ENDPOINTS.BOOKINGS);

    if (result.ok) {
      // Filter out deleted bookings
      const allBookings = result.data.bookings || result.data || [];
      AppState.bookings = allBookings.filter(booking => 
        !booking.isDeleted && booking.status !== 'deleted'
      );
      
      // Update the bookings table
      renderBookings(AppState.bookings);
      
      // Update booking stats with real data
      updateBookingStatsFromBookings(AppState.bookings);
      
      // Also update the dashboard pending bookings count
      const pendingBookingsCount = AppState.bookings.filter(b => 
        b.status === 'pending' || b.status === 'confirmed'
      ).length;
      
      document.getElementById('pendingBookings').textContent = pendingBookingsCount;
      
      showNotification(`Loaded ${AppState.bookings.length} active bookings`, "success");
    } else {
      // If no bookings, show empty state
      AppState.bookings = [];
      renderBookings([]);
      updateBookingStatsFromBookings([]);
      showNotification('No bookings found', 'info');
    }
    
  } catch (error) {
    ErrorHandler.handleApiError(error, 'Bookings loading');
    // Set empty state on error
    AppState.bookings = [];
    renderBookings([]);
    updateBookingStatsFromBookings([]);
  }
}

// ==================== ENHANCED ORDERS SECTION DATA ====================
async function loadOrders() {
  try {
    console.log("ðŸ”„ Loading orders for orders section...");

    const result = await ApiClient.authenticatedRequest(ENDPOINTS.ORDERS);

    if (result.ok) {
      AppState.orders = result.data.orders || result.data || [];
      renderOrders(AppState.orders);
      updateOrderStats(AppState.orders);
      
      // Calculate and update dashboard new orders count
      const today = new Date().toISOString().split('T')[0];
      const newOrdersCount = AppState.orders.filter(order => {
        const orderDate = new Date(order.createdAt || order.orderDate || order.date).toISOString().split('T')[0];
        return orderDate === today && order.status !== 'cancelled';
      }).length;
      
      document.getElementById('newOrders').textContent = newOrdersCount;
      
      showNotification(`Loaded ${AppState.orders.length} orders`, "success");
    } else {
      // If no orders, show empty state
      AppState.orders = [];
      renderOrders([]);
      updateOrderStats([]);
      showNotification('No orders found', 'info');
    }
    
  } catch (error) {
    ErrorHandler.handleApiError(error, "Orders loading");
    // Set empty state on error
    AppState.orders = [];
    renderOrders([]);
    updateOrderStats([]);
  }
}

// ==================== REAL-TIME DATA REFRESH ====================
function setupRealTimeUpdates() {
  // Refresh dashboard data every 30 seconds
  setInterval(() => {
    if (AppState.isTokenVerified && document.getElementById("dashboard").style.display !== "none") {
      loadDashboardData();
    }
  }, 30000);
  
  // Refresh data when switching to dashboard section
  const dashboardTab = document.querySelector('.sidebar-bubble[data-section="dashboard"]');
  if (dashboardTab) {
    dashboardTab.addEventListener('click', () => {
      setTimeout(() => loadDashboardData(), 100);
    });
  }
  
  // Refresh when returning from other tabs
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && document.getElementById("dashboard").style.display !== "none") {
      loadDashboardData();
    }
  });
}

// ==================== INITIALIZE REAL-TIME UPDATES ====================
// Add this to your initializeApp function:
async function initializeApp() {
  console.log("ðŸš€ Initializing Enhanced Admin Dashboard...");

  // Test API connectivity first
  const isApiReachable = await testApiConnectivity();

  if (!isApiReachable) {
    showNotification(
      "Cannot connect to server. Please ensure the backend is running.",
      "error"
    );
  }

  // Check if user is already logged in
  if (AppState.authToken) {
    await verifyTokenAndLoadDashboard();
  } else {
    showLogin();
  }

  setupEventListeners();
  setupPerformanceMonitoring();
  setupRealTimeUpdates(); // Add this line
}

// ==================== ENHANCED VIEW BOOKING DETAILS ====================
async function viewBookingDetails(bookingId) {
  try {
    // First try to find booking in current state
    let booking = AppState.bookings.find(b => b._id === bookingId);
    
    if (!booking) {
      // Fetch booking details from API
      const result = await ApiClient.authenticatedRequest(`${ENDPOINTS.UPDATE_BOOKING_STATUS}/${bookingId}`);
      if (result.ok) {
        booking = result.data;
      } else {
        showNotification('Booking not found', 'error');
        return;
      }
    }

    // Create modal with booking details
    const customerName = booking.customerName || 
                        (booking.userId ? `${booking.userId.firstName} ${booking.userId.lastName}` : 'Unknown');
    
    const modalHTML = `
      <div class="modal-overlay" id="bookingModal">
        <div class="modal-content">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3>Booking Details</h3>
            <button onclick="closeModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--cream)">Ã—</button>
          </div>
          
          <div class="booking-details">
            <div class="detail-section">
              <h4>Customer Information</h4>
              <p><strong>Name:</strong> ${customerName}</p>
              <p><strong>Email:</strong> ${booking.customerEmail || (booking.userId?.email || 'N/A')}</p>
              <p><strong>Phone:</strong> ${booking.customerPhone || 'N/A'}</p>
            </div>
            
            <div class="detail-section">
              <h4>Service Details</h4>
              <p><strong>Service:</strong> ${booking.service || 'Wig Renovation'}</p>
              <p><strong>Number of Wigs:</strong> ${booking.wigCount || 0}</p>
              <p><strong>Total Price:</strong> â‚¬${booking.totalPrice || (booking.wigCount * 15 || 0).toFixed(2)}</p>
              <p><strong>Status:</strong> <span class="status-badge status-${booking.status.replace('_', '-')}">${booking.status}</span></p>
            </div>
            
            ${booking.notes ? `
            <div class="detail-section">
              <h4>Customer Notes</h4>
              <p>${booking.notes}</p>
            </div>
            ` : ''}
            
            <div class="detail-section">
              <h4>Timeline</h4>
              <p><strong>Created:</strong> ${new Date(booking.createdAt).toLocaleString()}</p>
              ${booking.estimatedCompletion ? `
              <p><strong>Estimated Completion:</strong> ${new Date(booking.estimatedCompletion).toLocaleString()}</p>
              ` : ''}
              ${booking.completedAt ? `
              <p><strong>Completed:</strong> ${new Date(booking.completedAt).toLocaleString()}</p>
              ` : ''}
            </div>
          </div>
          
          <div style="margin-top:20px;display:flex;gap:10px;">
            <button class="action-btn btn-danger" onclick="deleteBooking('${bookingId}'); closeModal();">
              <i class="fas fa-trash"></i> Delete Booking
            </button>
            <button class="action-btn" onclick="closeModal()">Close</button>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('bookingModal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
  } catch (error) {
    console.error('View booking error:', error);
    showNotification('Failed to load booking details', 'error');
  }
}

      function updateDashboardStats(stats) {
        document.getElementById("totalSales").textContent = `â‚¬${
          stats.totalSalesToday || 0
        }`;
        document.getElementById("newOrders").textContent =
          stats.newOrdersCount || 0;
        // Use the correct pending bookings count from the bookings stats
        const pendingElement = document.getElementById('pendingBookingsCount');
        if (pendingElement) {
          document.getElementById("pendingBookings").textContent = pendingElement.textContent || 0;
        } else {
          document.getElementById("pendingBookings").textContent = 0;
        }
        document.getElementById("bookingRevenue").textContent = `â‚¬${
          stats.bookingRevenue || 0
        }`;
      }

      function updateRecentBookings(bookings) {
        const container = document.getElementById("recentBookings");
        if (!container) {
          console.warn("âŒ Recent bookings container not found");
          return;
        }

        container.innerHTML = "";

        if (!bookings || bookings.length === 0) {
          container.innerHTML =
            '<tr><td colspan="6" style="text-align: center;">No recent bookings</td></tr>';
          return;
        }

        bookings.forEach((booking) => {
          const row = document.createElement("tr");
          const customerName = booking.customerName || 
                             (booking.userId ? `${booking.userId.firstName} ${booking.userId.lastName}` : 'Unknown');
          const statusClass = `status-${booking.status.replace('_', '-')}`;
          const createdDate = new Date(booking.createdAt).toLocaleDateString();

          row.innerHTML = `
                <td>${SecurityUtils.sanitizeInput(customerName)}</td>
                <td>${booking.service || 'Wig Renovation'}</td>
                <td>${booking.wigCount}</td>
                <td><span class="status-badge ${statusClass}">${booking.status}</span></td>
                <td>${createdDate}</td>
                <td>
                    <button class="action-btn view-booking" data-id="${booking._id}">View</button>
                </td>
            `;

          container.appendChild(row);
        });

        // Add event listeners
        document.querySelectorAll('.view-booking').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const bookingId = e.target.dataset.id;
            viewBookingDetails(bookingId);
          });
        });

        console.log(`âœ… Updated ${bookings.length} recent bookings`);
      }

      // ==================== ENHANCED BOOKINGS MANAGEMENT ====================
      async function loadBookings() {
        try {
          console.log('ðŸ”„ Loading bookings...');
          
          const [bookingsResult, statsResult] = await Promise.all([
            ApiClient.authenticatedRequest(ENDPOINTS.BOOKINGS),
            ApiClient.authenticatedRequest(ENDPOINTS.BOOKINGS_STATS)
          ]);

          if (bookingsResult.ok) {
            // Only show non-deleted bookings
            const allBookings = bookingsResult.data.bookings || [];
            AppState.bookings = allBookings.filter(booking => 
              !booking.isDeleted && booking.status !== 'deleted'
            );
            
            renderBookings(AppState.bookings);
          } else {
            // Fallback to mock data
            const mockBookings = getMockBookings();
            AppState.bookings = mockBookings;
            renderBookings(mockBookings);
            showNotification('Using demo bookings data', 'warning');
          }

          // Always update stats from the current bookings
          updateBookingStatsFromBookings(AppState.bookings);
          
        } catch (error) {
          ErrorHandler.handleApiError(error, 'Bookings loading');
        }
      }

      function renderBookings(bookings) {
        const tableBody = document.getElementById('bookingsTableBody');
        if (!tableBody) return;

        tableBody.innerHTML = '';

        if (!bookings || bookings.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="9" style="text-align: center;">
                <div style="padding: 30px;">
                  <i class="fas fa-calendar-times" style="font-size: 48px; color: var(--cream); margin-bottom: 15px;"></i>
                  <p>No bookings found</p>
                  <p style="font-size: 12px; color: #666;">All bookings have been deleted or there are no bookings yet.</p>
                </div>
              </td>
            </tr>
          `;
          
          // Force update stats to zero when no bookings
          updateBookingStatsFromBookings([]);
          return;
        }

        bookings.forEach((booking) => {
          const row = document.createElement('tr');
          const customerName = booking.customerName || 
                             (booking.userId ? `${booking.userId.firstName} ${booking.userId.lastName}` : 'Unknown');
          const customerEmail = booking.customerEmail || 
                              (booking.userId ? booking.userId.email : 'N/A');
          const statusClass = `status-${booking.status.replace('_', '-')}`;
          const createdDate = new Date(booking.createdAt).toLocaleDateString();
          
          // Add delete button for all bookings
          const deleteButton = `
            <button class="action-btn btn-danger delete-booking" data-id="${booking._id}" 
                    title="Delete this booking">
              <i class="fas fa-trash"></i>
            </button>
          `;

          row.innerHTML = `
            <td>#${booking._id.substring(0, 8)}...</td>
            <td>
              <div><strong>${SecurityUtils.sanitizeInput(customerName)}</strong></div>
              <small>${SecurityUtils.sanitizeInput(customerEmail)}</small>
            </td>
            <td>${booking.service || 'Wig Renovation'}</td>
            <td>${booking.wigCount}</td>
            <td>â‚¬${booking.totalPrice || (booking.wigCount * 15)}</td>
            <td><span class="status-badge ${statusClass}">${booking.status}</span></td>
            <td>${createdDate}</td>
            <td>
              <button class="action-btn view-booking" data-id="${booking._id}" title="View details">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn btn-warning update-booking-status" data-id="${booking._id}" title="Update status">
                <i class="fas fa-edit"></i>
              </button>
              ${deleteButton}
            </td>
          `;

          tableBody.appendChild(row);
        });

        // Add event listeners
        document.querySelectorAll('.view-booking').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const bookingId = e.target.closest('button').dataset.id;
            viewBookingDetails(bookingId);
          });
        });

        document.querySelectorAll('.update-booking-status').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const bookingId = e.target.closest('button').dataset.id;
            updateBookingStatus(bookingId);
          });
        });

        // Add delete event listeners
        document.querySelectorAll('.delete-booking').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const bookingId = e.target.closest('button').dataset.id;
            deleteBooking(bookingId);
          });
        });
      }

      // ==================== UPDATED STATS FUNCTIONS ====================
      function updateBookingStatsFromBookings(bookings) {
        if (!bookings || !Array.isArray(bookings)) {
          console.warn('No valid bookings array provided for stats');
          bookings = [];
        }
        
        const totalBookings = bookings.length;
        const pendingBookings = bookings.filter(b => b.status === 'pending').length;
        const inProgressBookings = bookings.filter(b => b.status === 'in_progress').length;
        const completedBookings = bookings.filter(b => b.status === 'completed').length;
        const cancelledBookings = bookings.filter(b => b.status === 'cancelled').length;
        
        console.log(`ðŸ“Š Booking Stats: Total=${totalBookings}, Pending=${pendingBookings}, InProgress=${inProgressBookings}, Completed=${completedBookings}`);
        
        // Update all stats elements
        const totalElement = document.getElementById('totalBookings');
        const pendingElement = document.getElementById('pendingBookingsCount');
        const inProgressElement = document.getElementById('inProgressBookings');
        const completedElement = document.getElementById('completedBookings');
        const pendingDashboardElement = document.getElementById('pendingBookings'); // Dashboard counter
        
        if (totalElement) totalElement.textContent = totalBookings;
        if (pendingElement) pendingElement.textContent = pendingBookings;
        if (inProgressElement) inProgressElement.textContent = inProgressBookings;
        if (completedElement) completedElement.textContent = completedBookings;
        
        // Also update dashboard counter
        if (pendingDashboardElement) pendingDashboardElement.textContent = pendingBookings;
      }

      // ==================== ENHANCED DELETE BOOKING FUNCTION ====================
      async function deleteBooking(bookingId) {
        // Find the booking to get customer name for confirmation
        const booking = AppState.bookings.find(b => b._id === bookingId);
        const customerName = booking ? 
          (booking.customerName || 
           (booking.userId ? `${booking.userId.firstName} ${booking.userId.lastName}` : 'Unknown')) : 
          'this booking';

        if (!confirm(`Are you sure you want to delete booking for ${customerName}? This action cannot be undone.`)) {
          return;
        }

        try {
          const result = await ApiClient.authenticatedRequest(
            `${ENDPOINTS.DELETE_BOOKING}/${bookingId}`,
            {
              method: "DELETE",
            }
          );

          if (result.ok) {
            showNotification("Booking deleted successfully!", "success");
            
            // FIX: Remove the booking from AppState.bookings array
            AppState.bookings = AppState.bookings.filter(b => b._id !== bookingId);
            
            // FIX: Update the display immediately
            renderBookings(AppState.bookings);
            
            // FIX: Update the stats immediately with the filtered array
            updateBookingStatsFromBookings(AppState.bookings);
            
            // FIX: Update recent bookings in dashboard
            const recentBookingsContainer = document.getElementById('recentBookings');
            if (recentBookingsContainer) {
              // Remove the deleted booking from recent bookings
              const recentBookingRows = recentBookingsContainer.querySelectorAll('tr');
              recentBookingRows.forEach(row => {
                const viewBtn = row.querySelector('.view-booking');
                if (viewBtn && viewBtn.dataset.id === bookingId) {
                  row.remove();
                }
              });
              
              // If no bookings left, show message
              if (recentBookingsContainer.children.length === 0) {
                recentBookingsContainer.innerHTML = 
                  '<tr><td colspan="6" style="text-align: center;">No recent bookings</td></tr>';
              }
            }
            
            // Refresh dashboard stats
            if (typeof loadDashboardData === 'function') {
              setTimeout(loadDashboardData, 300);
            }
          } else {
            throw new Error(result.error || "Failed to delete booking");
          }
        } catch (error) {
          console.error("Delete booking error:", error);
          showNotification("Failed to delete booking", "error");
        }
      }

      // ==================== ADD DELETE ALL FUNCTIONALITY ====================
      async function deleteAllBookings() {
        if (!confirm("Are you sure you want to delete ALL bookings? This action cannot be undone!")) {
          return;
        }

        try {
          showNotification("Deleting all bookings...", "info");
          
          // Clear all bookings from state
          AppState.bookings = [];
          
          // Update UI
          renderBookings([]);
          
          // Update recent bookings
          const recentBookingsContainer = document.getElementById('recentBookings');
          if (recentBookingsContainer) {
            recentBookingsContainer.innerHTML = 
              '<tr><td colspan="6" style="text-align: center;">No recent bookings</td></tr>';
          }
          
          showNotification("All bookings deleted successfully!", "success");
          
          // Refresh dashboard
          if (typeof loadDashboardData === 'function') {
            loadDashboardData();
          }
        } catch (error) {
          console.error("Delete all bookings error:", error);
          showNotification("Failed to delete all bookings", "error");
        }
      }

      // ==================== ADD DELETE ALL BUTTON TO UI ====================
      function addDeleteAllButton() {
        // Add this to your bookings section HTML or create dynamically
        const bookingsHeader = document.querySelector('#bookings .section-header');
        if (bookingsHeader && !document.getElementById('deleteAllBookingsBtn')) {
          const deleteAllBtn = document.createElement('button');
          deleteAllBtn.id = 'deleteAllBookingsBtn';
          deleteAllBtn.className = 'action-btn btn-danger';
          deleteAllBtn.style.marginLeft = '10px';
          deleteAllBtn.innerHTML = '<i class="fas fa-trash"></i> Delete All';
          deleteAllBtn.onclick = deleteAllBookings;
          
          bookingsHeader.appendChild(deleteAllBtn);
        }
      }

      // ==================== INITIALIZE THE BUTTON ====================
      // Call this function after the page loads
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(addDeleteAllButton, 1000);
      });

      // ==================== EMERGENCY FIX FOR STATS RESET ====================
      function forceResetBookingStats() {
        console.log('ðŸ”„ Force resetting booking stats...');
        
        // Reset all counters to zero
        const totalElement = document.getElementById('totalBookings');
        const pendingElement = document.getElementById('pendingBookingsCount');
        const inProgressElement = document.getElementById('inProgressBookings');
        const completedElement = document.getElementById('completedBookings');
        const pendingDashboardElement = document.getElementById('pendingBookings');
        
        if (totalElement) totalElement.textContent = '0';
        if (pendingElement) pendingElement.textContent = '0';
        if (inProgressElement) inProgressElement.textContent = '0';
        if (completedElement) completedElement.textContent = '0';
        if (pendingDashboardElement) pendingDashboardElement.textContent = '0';
        
        // Clear AppState
        AppState.bookings = [];
        
        // Clear table
        const tableBody = document.getElementById('bookingsTableBody');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="9" style="text-align: center; padding: 30px;">
                <i class="fas fa-calendar-times" style="font-size: 48px; color: var(--cream);"></i>
                <p>All bookings have been deleted</p>
              </td>
            </tr>
          `;
        }
        
        showNotification('Booking stats reset to zero', 'success');
      }

      function getMockBookings(limit = null) {
        const mockBookings = [
          {
            _id: 'booking_1',
            customerName: 'Sarah Johnson',
            customerEmail: 'sarah@example.com',
            service: 'Wig Renovation',
            wigCount: 2,
            totalPrice: 30,
            status: 'pending',
            createdAt: new Date(),
            estimatedCompletion: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
            notes: 'Please handle with care, sentimental value'
          },
          {
            _id: 'booking_2',
            customerName: 'Maria Rodriguez',
            customerEmail: 'maria@example.com',
            service: 'Wig Renovation',
            wigCount: 1,
            totalPrice: 15,
            status: 'confirmed',
            createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
            estimatedCompletion: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000)
          },
          {
            _id: 'booking_3',
            customerName: 'David Smith',
            customerEmail: 'david@example.com',
            service: 'Wig Renovation',
            wigCount: 3,
            totalPrice: 45,
            status: 'in_progress',
            createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
            estimatedCompletion: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
            notes: 'Urgent - needed for event'
          },
          {
            _id: 'booking_4',
            customerName: 'Lisa Chen',
            customerEmail: 'lisa@example.com',
            service: 'Wig Renovation',
            wigCount: 1,
            totalPrice: 15,
            status: 'completed',
            createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000),
            estimatedCompletion: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000)
          }
        ];
        
        return limit ? mockBookings.slice(0, limit) : mockBookings;
      }

      async function viewBookingDetails(bookingId) {
        try {
          const booking = AppState.bookings.find(b => b._id === bookingId);
          if (!booking) {
            showNotification('Booking not found', 'error');
            return;
          }

          const customerName = booking.customerName || 
                             (booking.userId ? `${booking.userId.firstName} ${booking.userId.lastName}` : 'Unknown');
          
          const modalHTML = `
            <div class="modal-overlay">
              <div class="modal-content">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                  <h3>Booking Details</h3>
                  <button onclick="closeModal()" style="background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>
                </div>
                
                <div class="booking-details">
                  <div class="detail-section">
                    <h4>Customer Information</h4>
                    <p><strong>Name:</strong> ${customerName}</p>
                    <p><strong>Email:</strong> ${booking.customerEmail || (booking.userId?.email || 'N/A')}</p>
                    <p><strong>Phone:</strong> ${booking.customerPhone || 'N/A'}</p>
                  </div>
                  
                  <div class="detail-section">
                    <h4>Service Details</h4>
                    <p><strong>Service:</strong> ${booking.service || 'Wig Renovation'}</p>
                    <p><strong>Number of Wigs:</strong> ${booking.wigCount}</p>
                    <p><strong>Total Price:</strong> â‚¬${booking.totalPrice || (booking.wigCount * 15)}</p>
                    <p><strong>Status:</strong> <span class="status-badge status-${booking.status.replace('_', '-')}">${booking.status}</span></p>
                  </div>
                  
                  ${booking.notes ? `
                  <div class="detail-section">
                    <h4>Customer Notes</h4>
                    <p>${booking.notes}</p>
                  </div>
                  ` : ''}
                  
                  <div class="detail-section">
                    <h4>Timeline</h4>
                    <p><strong>Created:</strong> ${new Date(booking.createdAt).toLocaleString()}</p>
                    ${booking.estimatedCompletion ? `
                    <p><strong>Estimated Completion:</strong> ${new Date(booking.estimatedCompletion).toLocaleString()}</p>
                    ` : ''}
                  </div>
                </div>
                
                <div style="margin-top:20px;display:flex;gap:10px;">
                  <button class="action-btn btn-danger" onclick="deleteBooking('${bookingId}'); closeModal();">Delete Booking</button>
                  <button class="action-btn" onclick="closeModal()">Close</button>
                </div>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', modalHTML);
        } catch (error) {
          console.error('View booking error:', error);
          showNotification('Failed to load booking details', 'error');
        }
      }

      async function updateBookingStatus(bookingId) {
        try {
          const booking = AppState.bookings.find(b => b._id === bookingId);
          if (!booking) {
            showNotification('Booking not found', 'error');
            return;
          }

          const newStatus = prompt('Enter new status (pending, confirmed, in_progress, completed, cancelled):', booking.status);
          
          if (!newStatus || !['pending', 'confirmed', 'in_progress', 'completed', 'cancelled'].includes(newStatus)) {
            showNotification('Invalid status', 'error');
            return;
          }

          let estimatedCompletion = booking.estimatedCompletion;
          if (newStatus === 'confirmed' && !estimatedCompletion) {
            const completionDate = prompt('Enter estimated completion date (YYYY-MM-DD):');
            if (completionDate) {
              estimatedCompletion = new Date(completionDate);
            }
          }

          const result = await ApiClient.authenticatedRequest(
            `${ENDPOINTS.UPDATE_BOOKING_STATUS}/${bookingId}/status`,
            {
              method: 'PUT',
              body: JSON.stringify({
                status: newStatus,
                estimatedCompletion: estimatedCompletion || undefined
              })
            }
          );

          if (result.ok) {
            showNotification('Booking status updated successfully', 'success');
            loadBookings(); // Refresh the list
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('Update booking status error:', error);
          showNotification('Failed to update booking status', 'error');
        }
      }

      function closeModal() {
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
      }

      // ==================== ENHANCED ORDERS MANAGEMENT ====================
      async function loadOrders() {
        console.log("ðŸ”„ Loading orders...");

        const result = await ApiClient.authenticatedRequest(ENDPOINTS.ORDERS);

        if (result.ok) {
          AppState.orders = result.data.orders || [];
          renderOrders(AppState.orders);
          updateOrderStats(AppState.orders);
          showNotification(
            `Loaded ${AppState.orders.length} orders`,
            "success"
          );
        } else {
          // Fallback to mock data
          console.log("ðŸ”„ Using mock orders data");
          const mockOrders = getMockOrders();
          renderOrders(mockOrders);
          updateOrderStats(mockOrders);
          showNotification("Using demo orders data", "warning");
        }
      }

      function renderOrders(ordersToRender) {
        const tableBody = document.getElementById("ordersTableBody");
        if (!tableBody) return;

        tableBody.innerHTML = "";

        if (!ordersToRender || ordersToRender.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="7" style="text-align: center;">No orders found</td></tr>';
          return;
        }

        ordersToRender.forEach((order) => {
          const row = document.createElement("tr");
          const statusClass = `status-${
            order.status?.toLowerCase() || "pending"
          }`;
          const orderDate = order.orderDate
            ? new Date(order.orderDate).toLocaleDateString()
            : "N/A";

          row.innerHTML = `
                <td>#${SecurityUtils.sanitizeInput(
                  order.orderNumber || "N/A"
                )}</td>
                <td>${SecurityUtils.sanitizeInput(
                  order.customerName || "Unknown"
                )}</td>
                <td><span class="status-badge ${statusClass}">${SecurityUtils.sanitizeInput(
            order.status || "pending"
          )}</span></td>
                <td>â‚¬${(order.totalAmount || 0).toFixed(2)}</td>
                <td>${orderDate}</td>
                <td>${order.itemCount || 0}</td>
                <td>
                    <button class="action-btn view-order" data-id="${
                      order._id || order.id
                    }">View</button>
                    <button class="action-btn btn-warning update-status" data-id="${
                      order._id || order.id
                    }">Update</button>
                </td>
            `;

          tableBody.appendChild(row);
        });

        document.querySelectorAll(".view-order").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const orderId = e.target.dataset.id;
            viewOrder(orderId);
          });
        });

        document.querySelectorAll(".update-status").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const orderId = e.target.dataset.id;
            updateOrderStatus(orderId);
          });
        });
      }

      function updateOrderStats(orders) {
        const totalOrders = orders.length;
        const pendingOrders = orders.filter(
          (order) => order.status === "pending"
        ).length;
        const processingOrders = orders.filter(
          (order) => order.status === "processing"
        ).length;
        const completedOrders = orders.filter(
          (order) => order.status === "delivered"
        ).length;

        document.getElementById("totalOrders").textContent = totalOrders;
        document.getElementById("pendingOrders").textContent = pendingOrders;
        document.getElementById("processingOrders").textContent =
          processingOrders;
        document.getElementById("completedOrders").textContent =
          completedOrders;
      }

      function getMockOrders() {
        return [
          {
            orderNumber: "OL-" + Date.now(),
            customerName: "Demo Customer",
            status: "processing",
            totalAmount: 89.99,
            orderDate: new Date(),
            itemCount: 2,
            paymentStatus: "paid",
          },
          {
            orderNumber: "OL-" + (Date.now() - 1000000),
            customerName: "Test User",
            status: "delivered",
            totalAmount: 149.99,
            orderDate: new Date(Date.now() - 86400000),
            itemCount: 3,
            paymentStatus: "paid",
          },
        ];
      }

      function viewOrder(orderId) {
        showNotification("View order functionality coming soon", "info");
      }

      function updateOrderStatus(orderId) {
        showNotification(
          "Update order status functionality coming soon",
          "info"
        );
      }

      function refreshOrders() {
        CacheManager.clear("orders");
        loadOrders();
      }

      // ==================== ENHANCED PRODUCTS MANAGEMENT ====================
      async function loadProducts(page = 1) {
        try {
          console.log("ðŸ”„ Loading products...");
          AppState.currentPage = page;

          const result = await ApiClient.authenticatedRequest(
            `${ENDPOINTS.PRODUCTS}?page=${page}&limit=${AppState.productsPerPage}`
          );

          if (result.ok) {
            AppState.products = result.data.products || result.data;
            renderProducts(AppState.products);
            if (result.data.pagination) {
              renderPagination(result.data.pagination, "products");
            }
          } else {
            // Fallback to public endpoint
            const publicResult = await ApiClient.request(
              ENDPOINTS.PUBLIC_PRODUCTS
            );
            if (publicResult.ok) {
              AppState.products = publicResult.data;
              renderProducts(AppState.products);
              showNotification("Using public products data", "warning");
            } else {
              throw new Error("Failed to load products");
            }
          }
        } catch (error) {
          ErrorHandler.handleApiError(error, "Products loading");
        }
      }

      function renderProducts(productsToRender) {
        const tableBody = document.getElementById("productsTableBody");
        if (!tableBody) return;

        tableBody.innerHTML = "";

        if (!productsToRender || productsToRender.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="6" style="text-align: center;">No products found</td></tr>';
          return;
        }

        productsToRender.forEach((product) => {
          const row = document.createElement("tr");
          const statusClass =
            product.stock < 10 ? "status-low" : "status-delivered";
          const statusText = product.stock < 10 ? "Low Stock" : "In Stock";

          row.innerHTML = `
                <td>${SecurityUtils.sanitizeInput(product.name)}</td>
                <td>${SecurityUtils.sanitizeInput(product.category)}</td>
                <td>â‚¬${product.price?.toFixed(2) || "0.00"}</td>
                <td>${product.stock}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="action-btn btn-warning edit-product" data-id="${
                      product._id || product.id
                    }">Edit</button>
                    <button class="action-btn btn-danger delete-product" data-id="${
                      product._id || product.id
                    }">Delete</button>
                </td>
            `;

          tableBody.appendChild(row);
        });

        // Add event listeners to action buttons
        document.querySelectorAll(".edit-product").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const productId = e.target.dataset.id;
            editProduct(productId);
          });
        });

        document.querySelectorAll(".delete-product").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const productId = e.target.dataset.id;
            deleteProduct(productId);
          });
        });
      }

      // ==================== ENHANCED PRODUCT EDITING ====================
      async function editProduct(productId) {
        try {
          // Find product in current state or fetch from API
          let product = AppState.products.find(p => p._id === productId);
          
          if (!product) {
            // Try to fetch product details from API
            const result = await ApiClient.authenticatedRequest(`${ENDPOINTS.PRODUCTS}/${productId}`);
            if (result.ok) {
              product = result.data;
            } else {
              showNotification('Product not found', 'error');
              return;
            }
          }

          // Create edit modal
          const modalHTML = `
            <div class="modal-overlay">
              <div class="modal-content">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                  <h3>Edit Product</h3>
                  <button onclick="closeModal()" style="background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>
                </div>
                
                <form id="editProductForm">
                  <input type="hidden" id="editProductId" value="${productId}">
                  
                  <div class="form-group">
                    <label for="editProductName">Product Name</label>
                    <input
                      type="text"
                      id="editProductName"
                      class="form-control"
                      value="${SecurityUtils.sanitizeInput(product.name)}"
                      required
                    />
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductDescription">Description</label>
                    <textarea
                      id="editProductDescription"
                      class="form-control"
                      rows="3"
                      required
                    >${SecurityUtils.sanitizeInput(product.description || '')}</textarea>
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductPrice">Price (â‚¬)</label>
                    <input
                      type="number"
                      id="editProductPrice"
                      class="form-control"
                      step="0.01"
                      value="${product.price || 0}"
                      required
                    />
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductOldPrice">Old Price (Optional)</label>
                    <input
                      type="number"
                      id="editProductOldPrice"
                      class="form-control"
                      step="0.01"
                      value="${product.oldPrice || ''}"
                    />
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductStock">Stock Quantity</label>
                    <input
                      type="number"
                      id="editProductStock"
                      class="form-control"
                      value="${product.stock || 0}"
                      required
                    />
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductCategory">Category</label>
                    <select id="editProductCategory" class="form-control" required>
                      <option value="">Select Category</option>
                      <option value="brazilian" ${product.category === 'brazilian' ? 'selected' : ''}>Brazilian</option>
                      <option value="peruvian" ${product.category === 'peruvian' ? 'selected' : ''}>Peruvian</option>
                      <option value="malaysian" ${product.category === 'malaysian' ? 'selected' : ''}>Malaysian</option>
                      <option value="indian" ${product.category === 'indian' ? 'selected' : ''}>Indian</option>
                      <option value="accessories" ${product.category === 'accessories' ? 'selected' : ''}>Accessories</option>
                      <option value="extensions" ${product.category === 'extensions' ? 'selected' : ''}>Extensions</option>
                      <option value="wigs" ${product.category === 'wigs' ? 'selected' : ''}>Wigs</option>
                      <option value="closures" ${product.category === 'closures' ? 'selected' : ''}>Closures</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductType">Type</label>
                    <input
                      type="text"
                      id="editProductType"
                      class="form-control"
                      value="${SecurityUtils.sanitizeInput(product.type || '')}"
                      required
                    />
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductLength">Length</label>
                    <input 
                      type="text" 
                      id="editProductLength" 
                      class="form-control" 
                      value="${SecurityUtils.sanitizeInput(product.length || '')}"
                    />
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductTexture">Texture</label>
                    <input 
                      type="text" 
                      id="editProductTexture" 
                      class="form-control" 
                      value="${SecurityUtils.sanitizeInput(product.texture || '')}"
                    />
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductColor">Color</label>
                    <input 
                      type="text" 
                      id="editProductColor" 
                      class="form-control" 
                      value="${SecurityUtils.sanitizeInput(product.color || '')}"
                    />
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductQuality">Quality</label>
                    <input
                      type="text"
                      id="editProductQuality"
                      class="form-control"
                      value="${SecurityUtils.sanitizeInput(product.quality || 'Premium')}"
                    />
                  </div>
                  
                  <div class="form-group">
                    <label>
                      <input type="checkbox" id="editProductActive" ${product.isActive !== false ? 'checked' : ''}>
                      Product is Active
                    </label>
                  </div>
                  
                  <div class="form-group">
                    <label for="editProductImages">Update Product Images</label>
                    <input
                      type="file"
                      id="editProductImages"
                      class="form-control"
                      accept="image/*"
                      multiple
                    />
                    <small>Select new images to replace existing ones</small>
                  </div>
                  
                  ${product.images && product.images.length > 0 ? `
                  <div class="form-group">
                    <label>Current Images</label>
                    <div class="image-preview-container" id="currentImagesPreview">
                      ${product.images.map((img, index) => `
                        <div class="image-preview">
                          <img src="${img}" alt="Product Image ${index + 1}">
                          <button type="button" class="remove-image" onclick="removeProductImage('${productId}', '${img}')">Ã—</button>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  ` : ''}
                  
                  <div style="margin-top:20px;display:flex;gap:10px;">
                    <button type="submit" class="action-btn" id="updateProductBtn">
                      Update Product
                    </button>
                    <button type="button" class="action-btn btn-danger" onclick="closeModal()">
                      Cancel
                    </button>
                  </div>
                </form>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', modalHTML);
          
          // Add form submit handler
          document.getElementById('editProductForm').addEventListener('submit', handleEditProductSubmit);
        } catch (error) {
          console.error('Edit product error:', error);
          showNotification('Failed to load product edit form', 'error');
        }
      }

      async function handleEditProductSubmit(e) {
        e.preventDefault();
        
        const productId = document.getElementById('editProductId').value;
        const updateProductBtn = document.getElementById('updateProductBtn');
        const originalText = updateProductBtn.textContent;

        // Show loading state
        updateProductBtn.textContent = "Updating...";
        updateProductBtn.disabled = true;

        try {
          const formData = new FormData();

          // Add text fields
          formData.append("name", document.getElementById("editProductName").value);
          formData.append("description", document.getElementById("editProductDescription").value);
          formData.append("price", document.getElementById("editProductPrice").value);
          formData.append("stock", document.getElementById("editProductStock").value);
          formData.append("category", document.getElementById("editProductCategory").value);
          formData.append("type", document.getElementById("editProductType").value);
          formData.append("length", document.getElementById("editProductLength").value);
          formData.append("texture", document.getElementById("editProductTexture").value);
          formData.append("color", document.getElementById("editProductColor").value);
          formData.append("quality", document.getElementById("editProductQuality").value);
          formData.append("isActive", document.getElementById("editProductActive").checked ? "true" : "false");

          const oldPrice = document.getElementById("editProductOldPrice").value;
          if (oldPrice) {
            formData.append("oldPrice", oldPrice);
          }

          // Add new image files
          const imageFiles = document.getElementById("editProductImages").files;
          for (let i = 0; i < imageFiles.length; i++) {
            formData.append("images", imageFiles[i]);
          }

          const response = await fetch(`${ENDPOINTS.PRODUCTS}/${productId}`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${AppState.authToken}`,
            },
            body: formData,
          });

          if (response.ok) {
            showNotification("Product updated successfully!", "success");
            closeModal();
            loadProducts(AppState.currentPage);
          } else {
            const error = await response.json();
            showNotification(error.error || "Error updating product", "error");
          }
        } catch (error) {
          console.error("Error updating product:", error);
          showNotification("Error updating product", "error");
        } finally {
          // Reset button state
          updateProductBtn.textContent = originalText;
          updateProductBtn.disabled = false;
        }
      }

      async function removeProductImage(productId, imageUrl) {
        if (!confirm("Are you sure you want to remove this image?")) {
          return;
        }

        try {
          const result = await ApiClient.authenticatedRequest(
            `${ENDPOINTS.PRODUCTS}/${productId}/images`,
            {
              method: "DELETE",
              body: JSON.stringify({ imageUrl })
            }
          );

          if (result.ok) {
            showNotification("Image removed successfully", "success");
            // Refresh the product edit form
            closeModal();
            editProduct(productId);
          } else {
            throw new Error(result.error || "Failed to remove image");
          }
        } catch (error) {
          console.error("Remove product image error:", error);
          showNotification("Failed to remove image", "error");
        }
      }

      async function handleAddProduct(e) {
        e.preventDefault();

        const saveProductBtn = document.getElementById("saveProductBtn");
        const originalText = saveProductBtn.textContent;

        // Show loading state
        saveProductBtn.textContent = "Saving...";
        saveProductBtn.disabled = true;

        try {
          const formData = new FormData();

          // Add text fields
          formData.append("name", document.getElementById("productName").value);
          formData.append(
            "description",
            document.getElementById("productDescription").value
          );
          formData.append(
            "price",
            document.getElementById("productPrice").value
          );
          formData.append(
            "stock",
            document.getElementById("productStock").value
          );
          formData.append(
            "category",
            document.getElementById("productCategory").value
          );
          formData.append("type", document.getElementById("productType").value);
          formData.append(
            "length",
            document.getElementById("productLength").value
          );
          formData.append(
            "texture",
            document.getElementById("productTexture").value
          );
          formData.append(
            "color",
            document.getElementById("productColor").value
          );
          formData.append(
            "quality",
            document.getElementById("productQuality").value
          );
          formData.append("isActive", "true");

          const oldPrice = document.getElementById("productOldPrice").value;
          if (oldPrice) {
            formData.append("oldPrice", oldPrice);
          }

          // Add image files
          const imageFiles = document.getElementById("productImages").files;
          for (let i = 0; i < imageFiles.length; i++) {
            formData.append("images", imageFiles[i]);
          }

          const response = await fetch(ENDPOINTS.PRODUCTS, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${AppState.authToken}`,
            },
            body: formData,
          });

          if (response.ok) {
            showNotification("Product added successfully!", "success");
            document.getElementById("addProductForm").style.display = "none";
            document.getElementById("productForm").reset();
            loadProducts(AppState.currentPage);
          } else {
            const error = await response.json();
            showNotification(error.error || "Error adding product", "error");
          }
        } catch (error) {
          console.error("Error adding product:", error);
          showNotification("Error adding product", "error");
        } finally {
          // Reset button state
          saveProductBtn.textContent = originalText;
          saveProductBtn.disabled = false;
        }
      }

      async function deleteProduct(productId) {
        if (!confirm("Are you sure you want to delete this product? This action cannot be undone.")) {
          return;
        }

        try {
          const response = await ApiClient.authenticatedRequest(
            `${ENDPOINTS.PRODUCTS}/${productId}`,
            {
              method: "DELETE",
            }
          );

          if (response.ok) {
            showNotification("Product deleted successfully!", "success");
            loadProducts(AppState.currentPage);
          } else {
            showNotification("Error deleting product", "error");
          }
        } catch (error) {
          console.error("Error deleting product:", error);
          showNotification("Error deleting product", "error");
        }
      }

      // Add to admindashboard.html in the script section
function previewMultipleImages(input) {
  const previewContainer = document.getElementById('imagePreviewContainer');
  const previewGrid = document.getElementById('imagePreviews');
  
  // Clear previous previews
  previewGrid.innerHTML = '';
  
  if (input.files && input.files.length > 0) {
    previewContainer.style.display = 'block';
    
    for (let i = 0; i < input.files.length; i++) {
      const file = input.files[i];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview-item';
        previewDiv.innerHTML = `
          <div class="image-preview">
            <img src="${e.target.result}" alt="Preview ${i + 1}">
            <div class="image-preview-info">
              <span>Image ${i + 1}</span>
              ${i === 0 ? '<span class="main-image-badge">Main</span>' : ''}
            </div>
            <button type="button" class="remove-preview" onclick="removeImagePreview(${i})">Ã—</button>
          </div>
        `;
        previewGrid.appendChild(previewDiv);
      };
      
      reader.readAsDataURL(file);
    }
  } else {
    previewContainer.style.display = 'none';
  }
}

function removeImagePreview(index) {
  const input = document.getElementById('productImages');
  const dt = new DataTransfer();
  const files = Array.from(input.files);
  
  // Remove file from files array
  files.splice(index, 1);
  
  // Update file input
  files.forEach(file => dt.items.add(file));
  input.files = dt.files;
  
  // Refresh preview
  previewMultipleImages(input);
}

      // ==================== ENHANCED REPORTS & CHARTS - UPDATED ====================
async function loadReports() {
  try {
    console.log("ðŸ“Š Loading reports...");
    
    const days = document.getElementById("reportRange").value;
    const result = await ApiClient.authenticatedRequest(
      `${ENDPOINTS.SALES_ANALYTICS}?days=${days}`
    );

    if (result.ok && result.data) {
      displayReportSummary(result.data);
    } else {
      displayReportSummary({
        totalSales: 0,
        totalOrders: 0,
        totalBookings: 0,
        averageOrderValue: 0,
        period: `${days} days`
      });
      showNotification("Using demo report data", "warning");
    }
  } catch (error) {
    ErrorHandler.handleApiError(error, "Reports loading");
    displayReportSummary({
      totalSales: 0,
      totalOrders: 0,
      totalBookings: 0,
      averageOrderValue: 0,
      period: "selected period"
    });
  }
}

function displayReportSummary(data) {
  const summaryContainer = document.getElementById("reportSummary");
  
  if (!data || Object.keys(data).length === 0) {
    summaryContainer.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <p>No data available for the selected period.</p>
      </div>
    `;
    return;
  }

  // Calculate additional metrics
  const totalRevenue = (data.sales?.totalSales || 0) + (data.bookings?.bookingRevenue || 0);
  const orderPercentage = totalRevenue > 0 ? ((data.sales?.totalSales || 0) / totalRevenue * 100).toFixed(1) : 0;
  const bookingPercentage = totalRevenue > 0 ? ((data.bookings?.bookingRevenue || 0) / totalRevenue * 100).toFixed(1) : 0;
  
  summaryContainer.innerHTML = `
    <div class="kpi-grid">
      <div class="kpi-card">
        <h3>Total Revenue</h3>
        <div class="value">â‚¬${totalRevenue.toFixed(2)}</div>
      </div>
      <div class="kpi-card">
        <h3>Total Orders</h3>
        <div class="value">${data.sales?.totalOrders || 0}</div>
      </div>
      <div class="kpi-card">
        <h3>Total Bookings</h3>
        <div class="value">${data.bookings?.totalBookings || 0}</div>
      </div>
      <div class="kpi-card">
        <h3>New Customers</h3>
        <div class="value">${data.customers?.newCustomers || 0}</div>
      </div>
    </div>
    
    <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div class="dashboard-card">
        <h4>Revenue Breakdown</h4>
        <div style="margin-top: 15px;">
          <p><strong>Product Sales:</strong> â‚¬${data.sales?.totalSales?.toFixed(2) || 0} (${orderPercentage}%)</p>
          <div style="height: 10px; background: #f0f0f0; border-radius: 5px; margin: 5px 0 15px 0;">
            <div style="height: 100%; width: ${orderPercentage}%; background: var(--cream); border-radius: 5px;"></div>
          </div>
          
          <p><strong>Booking Revenue:</strong> â‚¬${data.bookings?.bookingRevenue?.toFixed(2) || 0} (${bookingPercentage}%)</p>
          <div style="height: 10px; background: #f0f0f0; border-radius: 5px; margin: 5px 0 15px 0;">
            <div style="height: 100%; width: ${bookingPercentage}%; background: #c8b4a8; border-radius: 5px;"></div>
          </div>
        </div>
      </div>
      
      <div class="dashboard-card">
        <h4>Performance Metrics</h4>
        <div style="margin-top: 15px;">
          <p><strong>Avg Order Value:</strong> â‚¬${data.sales?.averageOrderValue?.toFixed(2) || 0}</p>
          <p><strong>Avg Booking Value:</strong> â‚¬${data.bookings?.averageBookingValue?.toFixed(2) || 0}</p>
          <p><strong>Report Period:</strong> Last ${data.period || '30'} days</p>
          <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
        </div>
      </div>
    </div>
    
    ${data.sales?.dailyData && data.sales.dailyData.length > 0 ? `
    <div class="dashboard-card" style="margin-top: 20px;">
      <h4>Daily Sales Trend</h4>
      <div style="height: 200px; margin-top: 15px; display: flex; align-items: flex-end; gap: 10px; padding: 10px; border: 1px solid var(--light-bg); border-radius: 8px;">
        ${data.sales.dailyData.map(day => {
          const maxAmount = Math.max(...data.sales.dailyData.map(d => d.amount));
          const height = maxAmount > 0 ? (day.amount / maxAmount * 150) : 0;
          return `
            <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
              <div style="width: 30px; height: ${height}px; background: var(--cream); border-radius: 4px 4px 0 0;"></div>
              <div style="font-size: 10px; margin-top: 5px; transform: rotate(-45deg);">${day.date.split('-')[2]}/${day.date.split('-')[1]}</div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
    ` : ''}
  `;
}

function generateReport() {
  loadReports();
}

async function exportReport(format) {
  try {
    const days = document.getElementById("reportRange").value;
    let url;
    let filename;
    
    switch(format) {
      case 'csv':
        // You can modify this to include different report types
        url = `${ENDPOINTS.EXPORT_CSV}?days=${days}&type=summary`;
        filename = `sales_report_${days}_days_${new Date().toISOString().split('T')[0]}.csv`;
        break;
        
      case 'pdf':
        url = `${ENDPOINTS.EXPORT_PDF}?days=${days}`;
        filename = `sales_report_${days}_days_${new Date().toISOString().split('T')[0]}.pdf`;
        break;
        
      case 'detailed-pdf':
        url = `${ENDPOINTS.EXPORT_DETAILED_PDF}?days=${days}`;
        filename = `detailed_report_${days}_days_${new Date().toISOString().split('T')[0]}.pdf`;
        break;
        
      default:
        showNotification('Invalid export format', 'error');
        return;
    }
    
    // Show loading notification
    const loadingNotification = showNotification(`Generating ${format.toUpperCase()} report...`, 'info');
    
    // Make the API request
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${AppState.authToken}`
      }
    });
    
    if (!response.ok) {
      throw new Error(`Export failed: ${response.statusText}`);
    }
    
    // Get the blob data
    const blob = await response.blob();
    
    // Create download link
    const downloadUrl = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Clean up
    window.URL.revokeObjectURL(downloadUrl);
    
    showNotification(`${format.toUpperCase()} report downloaded successfully!`, 'success');
    
  } catch (error) {
    console.error('Export error:', error);
    showNotification(`Failed to export ${format.toUpperCase()}: ${error.message}`, 'error');
  }
}

      // ==================== ENHANCED USERS MANAGEMENT ====================
      async function loadUsers() {
        try {
          console.log("ðŸ”„ Loading users...");
          
          const result = await ApiClient.authenticatedRequest(ENDPOINTS.USERS);
          
          if (result.ok) {
            AppState.users = result.data.users || result.data;
            renderUsers(AppState.users);
            showNotification(`Loaded ${AppState.users.length} users`, "success");
          } else {
            // Fallback to mock users
            const mockUsers = getMockUsers();
            renderUsers(mockUsers);
            showNotification("Using demo users data", "warning");
          }
        } catch (error) {
          ErrorHandler.handleApiError(error, "Users loading");
        }
      }

      function renderUsers(users) {
        const tableBody = document.getElementById("usersTableBody");
        if (!tableBody) return;

        tableBody.innerHTML = "";

        if (!users || users.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No users found</td></tr>';
          return;
        }

        users.forEach((user) => {
          const row = document.createElement("tr");
          const lastActive = user.lastActive ? new Date(user.lastActive).toLocaleDateString() : 'Never';
          const statusClass = user.isSuspended ? 'status-cancelled' : 'status-completed';
          const statusText = user.isSuspended ? 'Suspended' : 'Active';
          
          row.innerHTML = `
            <td>${SecurityUtils.sanitizeInput(user.firstName || user.name || '')} ${SecurityUtils.sanitizeInput(user.lastName || '')}</td>
            <td>${SecurityUtils.sanitizeInput(user.email)}</td>
            <td>${user.role || 'Customer'}</td>
            <td>${user.orderCount || 0}</td>
            <td>${user.bookingCount || 0}</td>
            <td>${lastActive}</td>
            <td>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            <td>
              <button class="action-btn view-user" data-id="${user._id || user.id}">View</button>
              <button class="action-btn btn-warning edit-user" data-id="${user._id || user.id}">Edit</button>
              <button class="action-btn ${user.isSuspended ? 'btn-success' : 'btn-danger'} suspend-user" data-id="${user._id || user.id}" data-status="${user.isSuspended ? 'active' : 'suspended'}">
                ${user.isSuspended ? 'Activate' : 'Suspend'}
              </button>
            </td>
          `;

          tableBody.appendChild(row);
        });

        // Add event listeners
        document.querySelectorAll('.view-user').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const userId = e.target.dataset.id;
            viewUserDetails(userId);
          });
        });

        document.querySelectorAll('.edit-user').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const userId = e.target.dataset.id;
            editUser(userId);
          });
        });

        document.querySelectorAll('.suspend-user').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const userId = e.target.dataset.id;
            const action = e.target.dataset.status;
            toggleUserSuspension(userId, action);
          });
        });
      }

      function getMockUsers() {
        return [
          {
            _id: 'user_1',
            firstName: 'John',
            lastName: 'Doe',
            email: 'john@example.com',
            role: 'Customer',
            orderCount: 3,
            bookingCount: 1,
            lastActive: new Date(),
            isSuspended: false,
            phone: '+1234567890',
            address: '123 Main St, City, Country'
          },
          {
            _id: 'user_2',
            firstName: 'Jane',
            lastName: 'Smith',
            email: 'jane@example.com',
            role: 'Customer',
            orderCount: 5,
            bookingCount: 2,
            lastActive: new Date(Date.now() - 86400000),
            isSuspended: true,
            phone: '+0987654321',
            address: '456 Oak Ave, Town, Country'
          },
          // Add more mock users from the image
          {
            _id: 'user_3',
            name: 'Olys Shop',
            email: 'olys@shop.com',
            role: 'admin',
            orderCount: 0,
            bookingCount: 0,
            lastActive: null,
            isSuspended: false
          },
          {
            _id: 'user_4',
            name: 'Ange Boyz',
            email: 'angeboyz27@gmail.com',
            role: 'customer',
            orderCount: 0,
            bookingCount: 0,
            lastActive: null,
            isSuspended: false
          },
          {
            _id: 'user_5',
            name: 'Jaja jaja',
            email: 'pokam.jafercine@yahoo.com',
            role: 'customer',
            orderCount: 0,
            bookingCount: 0,
            lastActive: null,
            isSuspended: false
          },
          {
            _id: 'user_6',
            name: 'REMY STEPHANE ETOA',
            email: 'etoaremy@icloud.com',
            role: 'admin',
            orderCount: 0,
            bookingCount: 0,
            lastActive: null,
            isSuspended: false
          },
          {
            _id: 'user_7',
            name: 'Grace Ange',
            email: 'grace@gmail.com',
            role: 'admin',
            orderCount: 0,
            bookingCount: 0,
            lastActive: null,
            isSuspended: false
          },
          {
            _id: 'user_8',
            name: 'CHESSEU NJIPDI TERTULLIEN',
            email: 'olyshair@gmail.com',
            role: 'admin',
            orderCount: 0,
            bookingCount: 0,
            lastActive: null,
            isSuspended: false
          },
          {
            _id: 'user_9',
            name: 'remy stephane',
            email: 'remystephaneetoactoa@gmail.com',
            role: 'customer',
            orderCount: 0,
            bookingCount: 0,
            lastActive: null,
            isSuspended: false
          },
          {
            _id: 'user_10',
            name: 'David Obin',
            email: 'davidobin2@gmail.com',
            role: 'customer',
            orderCount: 0,
            bookingCount: 0,
            lastActive: null,
            isSuspended: false
          }
        ];
      }

      async function viewUserDetails(userId) {
        try {
          // Find user in current state or fetch from API
          let user = AppState.users.find(u => u._id === userId);
          
          if (!user) {
            // Try to fetch user details from API
            const result = await ApiClient.authenticatedRequest(`${ENDPOINTS.USERS}/${userId}`);
            if (result.ok) {
              user = result.data;
            } else {
              showNotification('User not found', 'error');
              return;
            }
          }

          // Parse name if it's a combined field
          let firstName = user.firstName || '';
          let lastName = user.lastName || '';
          
          if (!firstName && user.name) {
            const nameParts = user.name.split(' ');
            firstName = nameParts[0] || '';
            lastName = nameParts.slice(1).join(' ') || '';
          }

          const modalHTML = `
            <div class="modal-overlay">
              <div class="modal-content">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                  <h3>User Details</h3>
                  <button onclick="closeModal()" style="background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>
                </div>
                
                <div class="user-details">
                  <div class="detail-section">
                    <h4>Personal Information</h4>
                    <p><strong>Name:</strong> ${firstName} ${lastName}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Role:</strong> ${user.role}</p>
                    <p><strong>Status:</strong> <span class="status-badge ${user.isSuspended ? 'status-cancelled' : 'status-completed'}">${user.isSuspended ? 'Suspended' : 'Active'}</span></p>
                  </div>
                  
                  <div class="detail-section">
                    <h4>Contact Information</h4>
                    <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
                    <p><strong>Address:</strong> ${user.address || 'Not provided'}</p>
                  </div>
                  
                  <div class="detail-section">
                    <h4>Activity Summary</h4>
                    <p><strong>Total Orders:</strong> ${user.orderCount || 0}</p>
                    <p><strong>Total Bookings:</strong> ${user.bookingCount || 0}</p>
                    <p><strong>Last Active:</strong> ${user.lastActive ? new Date(user.lastActive).toLocaleString() : 'Never'}</p>
                    <p><strong>Member Since:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'Unknown'}</p>
                  </div>
                  
                  ${user.notes ? `
                  <div class="detail-section">
                    <h4>Admin Notes</h4>
                    <p>${user.notes}</p>
                  </div>
                  ` : ''}
                </div>
                
                <div style="margin-top:20px;display:flex;gap:10px;">
                  <button class="action-btn btn-warning" onclick="editUser('${userId}'); closeModal();">Edit User</button>
                  <button class="action-btn ${user.isSuspended ? 'btn-success' : 'btn-danger'}" onclick="toggleUserSuspension('${userId}', '${user.isSuspended ? 'active' : 'suspended'}'); closeModal();">
                    ${user.isSuspended ? 'Activate User' : 'Suspend User'}
                  </button>
                  <button class="action-btn" onclick="closeModal()">Close</button>
                </div>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', modalHTML);
        } catch (error) {
          console.error('View user error:', error);
          showNotification('Failed to load user details', 'error');
        }
      }

      async function editUser(userId) {
        try {
          // Find user in current state or fetch from API
          let user = AppState.users.find(u => u._id === userId);
          
          if (!user) {
            // Try to fetch user details from API
            const result = await ApiClient.authenticatedRequest(`${ENDPOINTS.USERS}/${userId}`);
            if (result.ok) {
              user = result.data;
            } else {
              showNotification('User not found', 'error');
              return;
            }
          }

          // Parse name if it's a combined field
          let firstName = user.firstName || '';
          let lastName = user.lastName || '';
          
          if (!firstName && user.name) {
            const nameParts = user.name.split(' ');
            firstName = nameParts[0] || '';
            lastName = nameParts.slice(1).join(' ') || '';
          }

          const modalHTML = `
            <div class="modal-overlay">
              <div class="modal-content">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                  <h3>Edit User</h3>
                  <button onclick="closeModal()" style="background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>
                </div>
                
                <form id="editUserForm">
                  <input type="hidden" id="editUserId" value="${userId}">
                  
                  <div class="form-group">
                    <label for="editFirstName">First Name</label>
                    <input type="text" id="editFirstName" class="form-control" value="${firstName}" required>
                  </div>
                  
                  <div class="form-group">
                    <label for="editLastName">Last Name</label>
                    <input type="text" id="editLastName" class="form-control" value="${lastName}" required>
                  </div>
                  
                  <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" class="form-control" value="${user.email}" required>
                  </div>
                  
                  <div class="form-group">
                    <label for="editPhone">Phone</label>
                    <input type="tel" id="editPhone" class="form-control" value="${user.phone || ''}">
                  </div>
                  
                  <div class="form-group">
                    <label for="editAddress">Address</label>
                    <textarea id="editAddress" class="form-control" rows="3">${user.address || ''}</textarea>
                  </div>
                  
                  <div class="form-group">
                    <label for="editRole">Role</label>
                    <select id="editRole" class="form-control">
                      <option value="customer" ${user.role === 'customer' ? 'selected' : ''}>Customer</option>
                      <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="editNotes">Admin Notes</label>
                    <textarea id="editNotes" class="form-control" rows="3">${user.notes || ''}</textarea>
                  </div>
                  
                  <div class="form-group">
                    <label>
                      <input type="checkbox" id="editIsSuspended" ${user.isSuspended ? 'checked' : ''}>
                      Suspend User Account
                    </label>
                    <small style="display:block;color:#666;">Suspended users cannot log in or place orders</small>
                  </div>
                  
                  <div style="margin-top:20px;display:flex;gap:10px;">
                    <button type="submit" class="action-btn">Save Changes</button>
                    <button type="button" class="action-btn btn-danger" onclick="closeModal()">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', modalHTML);
          
          // Add form submit handler
          document.getElementById('editUserForm').addEventListener('submit', handleEditUserSubmit);
        } catch (error) {
          console.error('Edit user error:', error);
          showNotification('Failed to load user edit form', 'error');
        }
      }

     async function handleEditUserSubmit(e) {
  e.preventDefault();
  
  const userId = document.getElementById('editUserId').value;
  const firstName = document.getElementById('editFirstName').value;
  const lastName = document.getElementById('editLastName').value;
  const email = document.getElementById('editEmail').value;
  const phone = document.getElementById('editPhone').value;
  const address = document.getElementById('editAddress').value;
  const role = document.getElementById('editRole').value;
  const notes = document.getElementById('editNotes').value;
  const isSuspended = document.getElementById('editIsSuspended').checked;
  
  try {
    const result = await ApiClient.authenticatedRequest(
      `${ENDPOINTS.USER_DETAILS}/${userId}`,  // Use correct endpoint
      {
        method: 'PUT',
        body: JSON.stringify({
          firstName,
          lastName,
          email,
          phone,
          address,
          role,
          notes,
          isSuspended
        })
      }
    );
    
    if (result.ok) {
      showNotification('User updated successfully', 'success');
      closeModal();
      loadUsers(); // Refresh the user list
    } else {
      throw new Error(result.error || 'Failed to update user');
    }
  } catch (error) {
    console.error('Update user error:', error);
    showNotification('Failed to update user', 'error');
  }
}

async function toggleUserSuspension(userId, action) {
  const isSuspending = action === 'suspended';
  const confirmMessage = isSuspending 
    ? 'Are you sure you want to suspend this user? They will not be able to log in or place orders.'
    : 'Are you sure you want to activate this user?';
  
  if (!confirm(confirmMessage)) {
    return;
  }
  
  try {
    const result = await ApiClient.authenticatedRequest(
      `${ENDPOINTS.USER_STATUS}/${userId}/status`,  // Correct endpoint
      {
        method: 'PUT',
        body: JSON.stringify({
          isSuspended: isSuspending,
          reason: isSuspending ? 'Suspended by admin' : null
        })
      }
    );
    
    if (result.ok) {
      showNotification(`User ${isSuspending ? 'suspended' : 'activated'} successfully`, 'success');
      loadUsers(); // Refresh the user list
    } else {
      throw new Error(result.error || `Failed to ${isSuspending ? 'suspend' : 'activate'} user`);
    }
  } catch (error) {
    console.error('Toggle user suspension error:', error);
    showNotification(`Failed to ${isSuspending ? 'suspend' : 'activate'} user`, 'error');
  }
}
      // ==================== ENHANCED EVENT HANDLERS ====================
      async function handleLogin(e) {
        e.preventDefault();

        const email = SecurityUtils.sanitizeInput(
          document.getElementById("loginEmail").value
        );
        const password = document.getElementById("loginPassword").value;

        if (!SecurityUtils.validateEmail(email)) {
          showNotification("Please enter a valid email address", "error");
          return;
        }

        const loginBtn = document.getElementById("loginBtn");
        const loginBtnText = document.getElementById("loginBtnText");
        const loginLoading = document.getElementById("loginLoading");

        // Show loading state
        loginBtnText.textContent = "Logging in...";
        loginLoading.style.display = "inline-block";
        loginBtn.disabled = true;

        try {
          console.log("ðŸ” Attempting admin login...");
          const result = await ApiClient.request(ENDPOINTS.ADMIN_LOGIN, {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });

          if (result.ok && result.data.token) {
            // Save token and user info
            AppState.authToken = result.data.token;
            localStorage.setItem("adminToken", AppState.authToken);
            AppState.currentUser = result.data.user;
            AppState.isTokenVerified = true;

            console.log("âœ… Login successful, token saved");
            showNotification("Login successful!", "success");
            showDashboard();
          } else {
            throw new Error(result.error || "Login failed");
          }
        } catch (error) {
          ErrorHandler.handleApiError(error, "Login");
        } finally {
          // Reset button state
          loginBtnText.textContent = "Login";
          loginLoading.style.display = "none";
          loginBtn.disabled = false;
        }
      }

      async function handleRegister(e) {
        e.preventDefault();

        const firstName = SecurityUtils.sanitizeInput(
          document.getElementById("registerFirstName").value
        );
        const lastName = SecurityUtils.sanitizeInput(
          document.getElementById("registerLastName").value
        );
        const email = SecurityUtils.sanitizeInput(
          document.getElementById("registerEmail").value
        );
        const password = document.getElementById("registerPassword").value;
        const phoneNumber = SecurityUtils.sanitizeInput(
          document.getElementById("registerPhone").value
        );

        if (!SecurityUtils.validateEmail(email)) {
          showNotification("Please enter a valid email address", "error");
          return;
        }

        const registerBtn = document.getElementById("registerBtn");
        const registerBtnText = document.getElementById("registerBtnText");
        const registerLoading = document.getElementById("registerLoading");

        // Show loading state
        registerBtnText.textContent = "Registering...";
        registerLoading.style.display = "inline-block";
        registerBtn.disabled = true;

        try {
          const result = await ApiClient.request(ENDPOINTS.ADMIN_REGISTER, {
            method: "POST",
            body: JSON.stringify({
              firstName,
              lastName,
              email,
              password,
              phoneNumber,
            }),
          });

          if (result.ok) {
            showNotification(
              "Registration successful! Please login.",
              "success"
            );
            showLogin();
            document.getElementById("registerForm").reset();
          } else {
            throw new Error(result.error || "Registration failed");
          }
        } catch (error) {
          ErrorHandler.handleApiError(error, "Registration");
        } finally {
          // Reset button state
          registerBtnText.textContent = "Register";
          registerLoading.style.display = "none";
          registerBtn.disabled = false;
        }
      }

      function handleLogout() {
        console.log("ðŸšª Logging out admin...");
        localStorage.removeItem("adminToken");
        AppState.authToken = null;
        AppState.currentUser = null;
        AppState.isTokenVerified = false;
        CacheManager.clear();
        showNotification("Logged out successfully", "success");
        showLogin();
      }

      // ==================== ENHANCED PERFORMANCE MONITORING ====================
      function setupPerformanceMonitoring() {
        // Monitor memory usage
        if (performance.memory) {
          setInterval(() => {
            const used = performance.memory.usedJSHeapSize;
            const limit = performance.memory.jsHeapSizeLimit;
            const percentage = (used / limit) * 100;

            if (percentage > 80) {
              console.warn(
                "âš ï¸ High memory usage detected:",
                percentage.toFixed(2) + "%"
              );
              CacheManager.clear();
            }
          }, 30000);
        }
      }

      // ==================== ENHANCED UTILITY FUNCTIONS ====================
      function showNotification(message, type = "info") {
        const notificationContainer = document.getElementById(
          "notificationContainer"
        );
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = SecurityUtils.sanitizeInput(message);

        notificationContainer.appendChild(notification);

        // Show notification with animation
        setTimeout(() => {
          notification.classList.add("show");
        }, 100);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }, 5000);
      }

      function debounce(func, wait, immediate = false) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            timeout = null;
            if (!immediate) func(...args);
          };
          const callNow = immediate && !timeout;
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
          if (callNow) func(...args);
        };
      }

      // ==================== ENHANCED EVENT LISTENER SETUP ====================
      function setupEventListeners() {
        // Login/Register forms
        document
          .getElementById("loginForm")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("registerForm")
          .addEventListener("submit", handleRegister);
        document
          .getElementById("showRegister")
          .addEventListener("click", showRegister);
        document
          .getElementById("showLogin")
          .addEventListener("click", showLogin);
        document
          .getElementById("logoutBtn")
          .addEventListener("click", handleLogout);

        // Product management
        const addProductBtn = document.getElementById("addProductBtn");
        const cancelAddProduct = document.getElementById("cancelAddProduct");
        const productForm = document.getElementById("productForm");

        if (addProductBtn) {
          addProductBtn.addEventListener("click", () => {
            document.getElementById("addProductForm").style.display = "block";
          });
        }

        if (cancelAddProduct) {
          cancelAddProduct.addEventListener("click", () => {
            document.getElementById("addProductForm").style.display = "none";
            productForm.reset();
          });
        }

        if (productForm) {
          productForm.addEventListener("submit", handleAddProduct);
        }

        // Search functionality with enhanced debouncing
        const productSearch = document.getElementById("productSearch");
        if (productSearch) {
          productSearch.addEventListener(
            "input",
            debounce(filterProducts, 500)
          );
        }

        const orderSearch = document.getElementById("orderSearch");
        if (orderSearch) {
          orderSearch.addEventListener("input", debounce(filterOrders, 500));
        }

        const bookingSearch = document.getElementById("bookingSearch");
        if (bookingSearch) {
          bookingSearch.addEventListener("input", debounce(filterBookings, 500));
        }

        const userSearch = document.getElementById("userSearch");
        if (userSearch) {
          userSearch.addEventListener("input", debounce(filterUsers, 500));
        }

        // Report range change
        const reportRange = document.getElementById("reportRange");
        if (reportRange) {
          reportRange.addEventListener("change", debounce(loadReports, 300));
        }

        // Section navigation
        setupSectionNavigation();

        // Window unload cleanup
        window.addEventListener("beforeunload", () => {
          CacheManager.clear();
        });
      }

      function setupSectionNavigation() {
        const sidebarBubbles = document.querySelectorAll(".sidebar-bubble");

        sidebarBubbles.forEach((bubble) => {
          bubble.addEventListener("click", () => {
            const sectionId = bubble.getAttribute("data-section");
            switchSection(sectionId);
          });
        });
      }

      // Search and filter functions
      function filterProducts() {
        const searchTerm = document.getElementById("productSearch").value.toLowerCase();
        if (!searchTerm) {
          renderProducts(AppState.products);
          return;
        }
        const filteredProducts = AppState.products.filter(product =>
          product.name.toLowerCase().includes(searchTerm) ||
          product.category.toLowerCase().includes(searchTerm)
        );
        renderProducts(filteredProducts);
      }

      function filterOrders() {
        const searchTerm = document.getElementById("orderSearch").value.toLowerCase();
        if (!searchTerm) {
          renderOrders(AppState.orders);
          return;
        }
        const filteredOrders = AppState.orders.filter(order =>
          order.orderNumber.toLowerCase().includes(searchTerm) ||
          order.customerName.toLowerCase().includes(searchTerm)
        );
        renderOrders(filteredOrders);
      }

      function filterBookings() {
        const searchTerm = document.getElementById("bookingSearch").value.toLowerCase();
        if (!searchTerm) {
          renderBookings(AppState.bookings);
          return;
        }
        const filteredBookings = AppState.bookings.filter(booking =>
          booking.customerName.toLowerCase().includes(searchTerm) ||
          booking.status.toLowerCase().includes(searchTerm)
        );
        renderBookings(filteredBookings);
      }

      function filterUsers() {
        const searchTerm = document.getElementById("userSearch").value.toLowerCase();
        if (!searchTerm) {
          renderUsers(AppState.users);
          return;
        }
        const filteredUsers = AppState.users.filter(user => {
          const userName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase() || user.name.toLowerCase();
          return userName.includes(searchTerm) ||
                 user.email.toLowerCase().includes(searchTerm) ||
                 user.role.toLowerCase().includes(searchTerm);
        });
        renderUsers(filteredUsers);
      }

      // ==================== ADD MISSING FUNCTIONS ====================

      // Pagination function
      function renderPagination(pagination, type) {
        const paginationContainer = document.getElementById(`${type}Pagination`);
        if (!paginationContainer || !pagination) return;

        const { totalPages, currentPage, hasNext, hasPrev } = pagination;
        
        let paginationHTML = '';
        
        if (hasPrev) {
          paginationHTML += `<button class="action-btn" onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}(${currentPage - 1})">Previous</button>`;
        }
        
        paginationHTML += ` <span style="margin: 0 15px;">Page ${currentPage} of ${totalPages}</span> `;
        
        if (hasNext) {
          paginationHTML += `<button class="action-btn" onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}(${currentPage + 1})">Next</button>`;
        }
        
        paginationContainer.innerHTML = paginationHTML;
      }

      // ==================== KEEP EXISTING UI CONTROLS ====================
      const modeToggle = document.querySelector(".mode-toggle");
      const body = document.body;

      modeToggle.addEventListener("click", () => {
        body.classList.toggle("dark-mode");
        localStorage.setItem(
          "theme",
          body.classList.contains("dark-mode") ? "dark" : "light"
        );
      });

      // Check for saved user preference
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        body.classList.add("dark-mode");
      }

      // User profile dropdown
      const userProfile = document.querySelector(".user-profile");
      const dropdownMenu = document.querySelector(".dropdown-menu");

      userProfile.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (!userProfile.contains(e.target)) {
          dropdownMenu.classList.remove("show");
        }
      });

      // Header scroll effect
      window.addEventListener("scroll", function () {
        const header = document.querySelector("header");
        if (window.scrollY > 100) {
          header.style.boxShadow = "0 2px 10px rgba(0, 0, 0, 0.1)";
          header.style.padding = "15px 40px";
        } else {
          header.style.boxShadow = "";
          header.style.padding = "20px 40px";
        }
      });

      // System Diagnostics
      async function runDiagnostics() {
        const results = document.getElementById("diagnosticResults");
        results.innerHTML = "Running diagnostics...";

        let diagnosticLog = "";

        try {
          // Test 1: Backend connection
          diagnosticLog += "1. Testing backend connection... ";
          const testResponse = await ApiClient.request(ENDPOINTS.HEALTH);
          if (testResponse.ok) {
            diagnosticLog += "âœ… SUCCESS\n";
          } else {
            diagnosticLog += "âŒ FAILED\n";
          }

          // Test 2: Bookings API
          diagnosticLog += "2. Testing bookings API... ";
          const bookingsResult = await ApiClient.authenticatedRequest(
            ENDPOINTS.BOOKINGS
          );
          if (bookingsResult.ok) {
            diagnosticLog += `âœ… SUCCESS (${bookingsResult.data.bookings?.length || 0} bookings)\n`;
          } else {
            diagnosticLog += "âŒ FAILED\n";
          }

          // Test 3: Check authentication
          diagnosticLog += "3. Checking authentication... ";
          const token = localStorage.getItem("adminToken");
          if (token) {
            diagnosticLog += "âœ… Token exists\n";
          } else {
            diagnosticLog += "âŒ No token found\n";
          }

          // Test 4: Check current user
          diagnosticLog += "4. Current user state... ";
          if (AppState.currentUser) {
            diagnosticLog += `âœ… ${AppState.currentUser.firstName} ${AppState.currentUser.lastName}\n`;
          } else {
            diagnosticLog += "âŒ No user data\n";
          }
        } catch (error) {
          diagnosticLog += `âŒ Error: ${error.message}\n`;
        }

        results.innerHTML = `<pre>${diagnosticLog}</pre>`;
      }

      // ==================== ADDITIONAL FUNCTIONS ====================
      async function exportReportWithType(format) {
        const days = document.getElementById("reportRange").value;
        const exportType = document.getElementById("exportType").value;
        
        await exportReport(format, exportType, days);
      }

      async function exportReport(format, type = 'summary', days = 30) {
        try {
          let url;
          let filename;
          const date = new Date().toISOString().split('T')[0];
          
          switch(format) {
            case 'csv':
              url = `${ENDPOINTS.EXPORT_CSV}?days=${days}&type=${type}`;
              filename = `${type}_report_${days}_days_${date}.csv`;
              break;
              
            case 'pdf':
              url = `${ENDPOINTS.EXPORT_PDF}?days=${days}&type=${type}`;
              filename = `${type}_summary_${days}_days_${date}.pdf`;
              break;
              
            case 'detailed-pdf':
              url = `${ENDPOINTS.EXPORT_DETAILED_PDF}?days=${days}`;
              filename = `detailed_report_${days}_days_${date}.pdf`;
              break;
              
            default:
              showNotification('Invalid export format', 'error');
              return;
          }
          
          // Show loading notification
          showNotification(`Generating ${type} ${format.toUpperCase()} report...`, 'info');
          
          // Make the API request
          const response = await fetch(url, {
            headers: {
              'Authorization': `Bearer ${AppState.authToken}`
            }
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Export failed: ${response.statusText}`);
          }
          
          // Get the blob data
          const blob = await response.blob();
          
          // Create download link
          const downloadUrl = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Clean up
          window.URL.revokeObjectURL(downloadUrl);
          
          showNotification(`${format.toUpperCase()} report downloaded successfully!`, 'success');
          
        } catch (error) {
          console.error('Export error:', error);
          showNotification(`Failed to export ${format.toUpperCase()}: ${error.message}`, 'error');
        }
      }

      // ==================== FIX CURRENT ISSUE ====================
      // To fix your current issue where bookings count shows 14 but all are deleted:
      // Run this in browser console:
      // forceResetBookingStats();
      // OR manually reset the counters:
      // document.getElementById('totalBookings').textContent = '0';
      // document.getElementById('pendingBookingsCount').textContent = '0';
      // document.getElementById('inProgressBookings').textContent = '0';
      // document.getElementById('completedBookings').textContent = '0';
      // document.getElementById('pendingBookings').textContent = '0';
// ==================== ORDER MANAGEMENT MODULE ====================

// Order state
const OrderState = {
  orders: [],
  filteredOrders: [],
  selectedOrders: new Set(),
  currentPage: 1,
  ordersPerPage: 10,
  totalPages: 1,
  searchTerm: '',
  statusFilter: 'all',
  isSelectAll: false
};

// Initialize orders section
async function initializeOrders() {
  setupOrderEventListeners();
  await loadOrders();
}

// Setup order event listeners
function setupOrderEventListeners() {
  // Search input
  const orderSearch = document.getElementById('orderSearch');
  if (orderSearch) {
    orderSearch.addEventListener('input', debounce(() => {
      OrderState.searchTerm = orderSearch.value.toLowerCase();
      filterAndRenderOrders();
    }, 300));
  }
  
  // Status filter
  const statusFilter = document.getElementById('orderStatusFilter');
  if (statusFilter) {
    statusFilter.addEventListener('change', () => {
      OrderState.statusFilter = statusFilter.value;
      filterAndRenderOrders();
    });
  }
  
  // Orders per page
  const ordersPerPage = document.getElementById('ordersPerPage');
  if (ordersPerPage) {
    ordersPerPage.addEventListener('change', () => {
      OrderState.ordersPerPage = parseInt(ordersPerPage.value);
      OrderState.currentPage = 1;
      renderOrders();
    });
  }
}

// Load orders from API
async function loadOrders() {
  try {
    showNotification('Loading orders...', 'info');
    
    const result = await ApiClient.authenticatedRequest(ENDPOINTS.ORDERS);
    
    if (result.ok) {
      OrderState.orders = result.data.orders || result.data || [];
      
      // Process order data
      OrderState.orders.forEach(order => {
        order.formattedDate = new Date(order.createdAt || order.orderDate || order.date).toLocaleDateString();
        order.formattedTime = new Date(order.createdAt || order.orderDate || order.date).toLocaleTimeString();
        order.statusClass = `status-${(order.status || 'pending').toLowerCase().replace('_', '-')}`;
        order.selected = false;
      });
      
      filterAndRenderOrders();
      updateOrderStats();
      
      showNotification(`Loaded ${OrderState.orders.length} orders`, 'success');
    } else {
      showNotification('Failed to load orders', 'error');
      renderOrders(); // Will show empty state
    }
    
  } catch (error) {
    console.error('Load orders error:', error);
    ErrorHandler.handleApiError(error, 'Orders loading');
    renderOrders(); // Will show empty state
  }
}

// Filter and render orders
function filterAndRenderOrders() {
  // Apply filters
  OrderState.filteredOrders = OrderState.orders.filter(order => {
    // Search filter
    const searchMatch = !OrderState.searchTerm || 
      (order.orderNumber && order.orderNumber.toLowerCase().includes(OrderState.searchTerm)) ||
      (order.customerName && order.customerName.toLowerCase().includes(OrderState.searchTerm)) ||
      (order.customerEmail && order.customerEmail.toLowerCase().includes(OrderState.searchTerm));
    
    // Status filter
    const statusMatch = OrderState.statusFilter === 'all' || 
      order.status === OrderState.statusFilter;
    
    return searchMatch && statusMatch;
  });
  
  // Update pagination
  OrderState.totalPages = Math.ceil(OrderState.filteredOrders.length / OrderState.ordersPerPage);
  if (OrderState.currentPage > OrderState.totalPages && OrderState.totalPages > 0) {
    OrderState.currentPage = OrderState.totalPages;
  }
  
  renderOrders();
  updatePaginationControls();
}

// Render orders table
function renderOrders() {
  const tableBody = document.getElementById('ordersTableBody');
  if (!tableBody) return;
  
  tableBody.innerHTML = '';
  
  if (OrderState.filteredOrders.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align: center; padding: 40px;">
          <div style="display: flex; flex-direction: column; align-items: center; color: #666;">
            <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No orders found</p>
            ${OrderState.searchTerm || OrderState.statusFilter !== 'all' ? 
              '<p style="font-size: 12px;">Try changing your search or filter criteria</p>' : 
              '<p style="font-size: 12px;">No orders have been placed yet</p>'
            }
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  // Calculate pagination slice
  const startIndex = (OrderState.currentPage - 1) * OrderState.ordersPerPage;
  const endIndex = Math.min(startIndex + OrderState.ordersPerPage, OrderState.filteredOrders.length);
  const currentOrders = OrderState.filteredOrders.slice(startIndex, endIndex);
  
  currentOrders.forEach(order => {
    const row = document.createElement('tr');
    row.dataset.orderId = order._id || order.id;
    
    const isSelected = OrderState.selectedOrders.has(order._id || order.id);
    const statusText = order.status ? order.status.charAt(0).toUpperCase() + order.status.slice(1) : 'Pending';
    const paymentStatus = order.paymentStatus || 'pending';
    const paymentClass = paymentStatus === 'paid' ? 'status-delivered' : 
                        paymentStatus === 'pending' ? 'status-pending' : 'status-cancelled';
    
    row.innerHTML = `
      <td>
        <input type="checkbox" class="order-checkbox" 
               data-order-id="${order._id || order.id}"
               ${isSelected ? 'checked' : ''}
               onchange="toggleOrderSelection('${order._id || order.id}', this.checked)">
      </td>
      <td>
        <strong>${order.orderNumber || 'N/A'}</strong>
        ${order.isGuestOrder ? '<br><small style="color: #666;">Guest Order</small>' : ''}
      </td>
      <td>
        <div><strong>${order.customerName || 'Unknown'}</strong></div>
        <small>${order.customerEmail || 'N/A'}</small>
      </td>
      <td>
        <span class="status-badge ${order.statusClass}">${statusText}</span>
      </td>
      <td><strong>â‚¬${(order.totalAmount || 0).toFixed(2)}</strong></td>
      <td>
        <div>${order.formattedDate}</div>
        <small>${order.formattedTime}</small>
      </td>
      <td>${order.itemsCount || order.items?.length || 0}</td>
      <td>
        <span class="status-badge ${paymentClass}">${paymentStatus}</span>
      </td>
      <td>
        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
          <button class="action-btn view-order" 
                  data-order-id="${order._id || order.id}"
                  title="View order details">
            <i class="fas fa-eye"></i>
          </button>
          <button class="action-btn btn-warning update-order-status" 
                  data-order-id="${order._id || order.id}"
                  title="Update order status">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn btn-danger delete-order" 
                  data-order-id="${order._id || order.id}"
                  title="Delete order">
            <i class="fas fa-trash"></i>
          </button>
          ${order.shippingLabel ? `
          <button class="action-btn btn-success print-label" 
                  data-order-id="${order._id || order.id}"
                  title="Print shipping label">
            <i class="fas fa-print"></i>
          </button>
          ` : ''}
        </div>
      </td>
    `;
    
    tableBody.appendChild(row);
  });
  
  // Add event listeners to action buttons
  addOrderActionListeners();
  
  // Update count display
  document.getElementById('ordersCount').textContent = 
    `Showing ${startIndex + 1}-${endIndex} of ${OrderState.filteredOrders.length} orders`;
}

// Add event listeners to order action buttons
function addOrderActionListeners() {
  // View order
  document.querySelectorAll('.view-order').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const orderId = e.target.closest('button').dataset.orderId;
      viewOrder(orderId);
    });
  });
  
  // Update status
  document.querySelectorAll('.update-order-status').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const orderId = e.target.closest('button').dataset.orderId;
      updateOrderStatus(orderId);
    });
  });
  
  // Delete order
  document.querySelectorAll('.delete-order').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const orderId = e.target.closest('button').dataset.orderId;
      deleteOrder(orderId);
    });
  });
  
  // Print label
  document.querySelectorAll('.print-label').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const orderId = e.target.closest('button').dataset.orderId;
      printShippingLabel(orderId);
    });
  });
}

// Update order statistics
function updateOrderStats() {
  const totalOrders = OrderState.orders.length;
  const pendingOrders = OrderState.orders.filter(order => 
    order.status === 'pending' || order.status === 'confirmed'
  ).length;
  const processingOrders = OrderState.orders.filter(order => 
    order.status === 'processing' || order.status === 'shipped'
  ).length;
  const completedOrders = OrderState.orders.filter(order => 
    order.status === 'delivered' || order.status === 'completed'
  ).length;
  const cancelledOrders = OrderState.orders.filter(order => 
    order.status === 'cancelled'
  ).length;

  document.getElementById('totalOrders').textContent = totalOrders;
  document.getElementById('pendingOrders').textContent = pendingOrders;
  document.getElementById('processingOrders').textContent = processingOrders;
  document.getElementById('completedOrders').textContent = completedOrders;
}

// Update pagination controls
function updatePaginationControls() {
  const prevBtn = document.getElementById('prevPageBtn');
  const nextBtn = document.getElementById('nextPageBtn');
  const currentPageSpan = document.getElementById('currentPage');
  
  if (prevBtn && nextBtn && currentPageSpan) {
    prevBtn.disabled = OrderState.currentPage <= 1;
    nextBtn.disabled = OrderState.currentPage >= OrderState.totalPages;
    currentPageSpan.textContent = `Page ${OrderState.currentPage} of ${OrderState.totalPages}`;
  }
}

// Change orders page
function changeOrdersPage(direction) {
  const newPage = OrderState.currentPage + direction;
  if (newPage >= 1 && newPage <= OrderState.totalPages) {
    OrderState.currentPage = newPage;
    renderOrders();
    updatePaginationControls();
  }
}

// Refresh orders
function refreshOrders() {
  OrderState.selectedOrders.clear();
  updateSelectedCount();
  loadOrders();
}

// ==================== VIEW ORDER DETAILS ====================
async function viewOrder(orderId) {
  try {
    showNotification('Loading order details...', 'info');
    
    // Fetch order details from API
    const result = await ApiClient.authenticatedRequest(`${ENDPOINTS.ORDER_DETAILS}/${orderId}`);
    
    if (result.ok) {
      const order = result.data.order || result.data;
      showOrderDetailsModal(order);
    } else {
      throw new Error(result.error || 'Failed to load order details');
    }
    
  } catch (error) {
    console.error('View order error:', error);
    showNotification('Failed to load order details', 'error');
  }
}

// Show order details modal
function showOrderDetailsModal(order) {
  // Create modal HTML
  const modalHTML = `
    <div class="modal-overlay" id="orderDetailsModal">
      <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--cream);">
          <h3 style="margin: 0;">Order Details - ${order.orderNumber || 'N/A'}</h3>
          <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--cream);">&times;</button>
        </div>
        
        <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
          <!-- Order Header -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <h4>Customer Information</h4>
              <div class="detail-section">
                <p><strong>Name:</strong> ${order.customerName || 'Unknown'}</p>
                <p><strong>Email:</strong> ${order.customerEmail || 'N/A'}</p>
                <p><strong>Phone:</strong> ${order.customerPhone || 'N/A'}</p>
                <p><strong>Customer Type:</strong> ${order.isGuestOrder ? 'Guest' : 'Registered User'}</p>
              </div>
            </div>
            
            <div>
              <h4>Order Summary</h4>
              <div class="detail-section">
                <p><strong>Order Status:</strong> <span class="status-badge status-${order.status?.toLowerCase().replace('_', '-')}">${order.status || 'Pending'}</span></p>
                <p><strong>Payment Status:</strong> <span class="status-badge status-${order.paymentStatus || 'pending'}">${order.paymentStatus || 'Pending'}</span></p>
                <p><strong>Order Date:</strong> ${new Date(order.createdAt || order.orderDate).toLocaleString()}</p>
                <p><strong>Order ID:</strong> ${order._id || order.id}</p>
              </div>
            </div>
          </div>
          
          <!-- Shipping & Billing -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <h4>Shipping Address</h4>
              <div class="detail-section" style="background: var(--light-bg); padding: 15px; border-radius: 8px;">
                ${formatAddress(order.shippingAddress)}
              </div>
            </div>
            
            <div>
              <h4>Billing Address</h4>
              <div class="detail-section" style="background: var(--light-bg); padding: 15px; border-radius: 8px;">
                ${formatAddress(order.billingAddress || order.shippingAddress)}
              </div>
            </div>
          </div>
          
          <!-- Order Items -->
          <div style="margin-bottom: 20px;">
            <h4>Order Items</h4>
            <div class="detail-section">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: var(--light-bg);">
                    <th style="padding: 10px; text-align: left;">Product</th>
                    <th style="padding: 10px; text-align: center;">Quantity</th>
                    <th style="padding: 10px; text-align: right;">Price</th>
                    <th style="padding: 10px; text-align: right;">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  ${formatOrderItems(order.items || [])}
                </tbody>
                <tfoot style="border-top: 2px solid var(--cream);">
                  ${formatOrderTotals(order)}
                </tfoot>
              </table>
            </div>
          </div>
          
          <!-- Order Timeline -->
          <div style="margin-bottom: 20px;">
            <h4>Order Timeline</h4>
            <div class="detail-section">
              ${formatOrderTimeline(order.timeline || [])}
            </div>
          </div>
          
          <!-- Notes -->
          ${order.notes ? `
          <div style="margin-bottom: 20px;">
            <h4>Order Notes</h4>
            <div class="detail-section" style="background: #fff3cd; padding: 15px; border-radius: 8px;">
              <p>${order.notes}</p>
            </div>
          </div>
          ` : ''}
          
          <!-- Shipping Info -->
          ${order.shippingInfo ? `
          <div style="margin-bottom: 20px;">
            <h4>Shipping Information</h4>
            <div class="detail-section">
              <p><strong>Shipping Method:</strong> ${order.shippingInfo.method || 'Standard'}</p>
              <p><strong>Tracking Number:</strong> ${order.shippingInfo.trackingNumber || 'Not available'}</p>
              <p><strong>Estimated Delivery:</strong> ${order.shippingInfo.estimatedDelivery || 'Not specified'}</p>
            </div>
          </div>
          ` : ''}
        </div>
        
        <!-- Action Buttons -->
        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--cream); display: flex; gap: 10px; justify-content: flex-end;">
          <button class="action-btn btn-warning" onclick="updateOrderStatus('${order._id || order.id}'); closeModal();">
            <i class="fas fa-edit"></i> Update Status
          </button>
          <button class="action-btn btn-success" onclick="printInvoice('${order._id || order.id}')">
            <i class="fas fa-print"></i> Print Invoice
          </button>
          <button class="action-btn" onclick="closeModal()">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal
  const existingModal = document.getElementById('orderDetailsModal');
  if (existingModal) existingModal.remove();
  
  // Add new modal
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Format address for display
function formatAddress(address) {
  if (!address) return '<p>No address provided</p>';
  
  return `
    <p><strong>${address.fullName || ''}</strong></p>
    <p>${address.street || ''}</p>
    ${address.apartment ? `<p>${address.apartment}</p>` : ''}
    <p>${address.city || ''}, ${address.state || ''} ${address.zipCode || ''}</p>
    <p>${address.country || ''}</p>
    <p><strong>Phone:</strong> ${address.phone || 'N/A'}</p>
  `;
}

// Format order items for display
function formatOrderItems(items) {
  if (!items || items.length === 0) {
    return '<tr><td colspan="4" style="text-align: center; padding: 20px;">No items found</td></tr>';
  }
  
  return items.map(item => `
    <tr style="border-bottom: 1px solid var(--light-bg);">
      <td style="padding: 10px;">
        <div><strong>${item.name || 'Unknown Product'}</strong></div>
        ${item.variant ? `<small>${item.variant}</small><br>` : ''}
        ${item.sku ? `<small>SKU: ${item.sku}</small>` : ''}
      </td>
      <td style="padding: 10px; text-align: center;">${item.quantity || 1}</td>
      <td style="padding: 10px; text-align: right;">â‚¬${(item.price || 0).toFixed(2)}</td>
      <td style="padding: 10px; text-align: right;">â‚¬${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</td>
    </tr>
  `).join('');
}

// Format order totals
function formatOrderTotals(order) {
  const subtotal = order.subtotal || order.totalAmount || 0;
  const shipping = order.shippingCost || 0;
  const tax = order.taxAmount || 0;
  const discount = order.discountAmount || 0;
  const total = order.totalAmount || 0;
  
  return `
    <tr>
      <td colspan="3" style="padding: 10px; text-align: right;"><strong>Subtotal:</strong></td>
      <td style="padding: 10px; text-align: right;">â‚¬${subtotal.toFixed(2)}</td>
    </tr>
    ${shipping > 0 ? `
    <tr>
      <td colspan="3" style="padding: 10px; text-align: right;"><strong>Shipping:</strong></td>
      <td style="padding: 10px; text-align: right;">â‚¬${shipping.toFixed(2)}</td>
    </tr>
    ` : ''}
    ${tax > 0 ? `
    <tr>
      <td colspan="3" style="padding: 10px; text-align: right;"><strong>Tax:</strong></td>
      <td style="padding: 10px; text-align: right;">â‚¬${tax.toFixed(2)}</td>
    </tr>
    ` : ''}
    ${discount > 0 ? `
    <tr>
      <td colspan="3" style="padding: 10px; text-align: right;"><strong>Discount:</strong></td>
      <td style="padding: 10px; text-align: right;">-â‚¬${discount.toFixed(2)}</td>
    </tr>
    ` : ''}
    <tr style="font-weight: bold; font-size: 1.1em;">
      <td colspan="3" style="padding: 10px; text-align: right;"><strong>Total:</strong></td>
      <td style="padding: 10px; text-align: right;">â‚¬${total.toFixed(2)}</td>
    </tr>
    ${order.paymentMethod ? `
    <tr>
      <td colspan="3" style="padding: 10px; text-align: right;"><strong>Payment Method:</strong></td>
      <td style="padding: 10px; text-align: right;">${order.paymentMethod}</td>
    </tr>
    ` : ''}
  `;
}

// Format order timeline
function formatOrderTimeline(timeline) {
  if (!timeline || timeline.length === 0) {
    return '<p>No timeline events</p>';
  }
  
  return timeline.map(event => `
    <div class="timeline-item ${event.status || ''}" style="margin-bottom: 10px; padding-left: 20px; position: relative;">
      <div style="position: absolute; left: 0; top: 5px; width: 10px; height: 10px; background: var(--cream); border-radius: 50%;"></div>
      <div><strong>${event.action || event.status}</strong></div>
      <div style="font-size: 12px; color: #666;">${new Date(event.timestamp || event.date).toLocaleString()}</div>
      ${event.note ? `<div style="font-size: 12px; margin-top: 5px;">${event.note}</div>` : ''}
    </div>
  `).join('');
}

// ==================== UPDATE ORDER STATUS ====================
async function updateOrderStatus(orderId, skipConfirm = false) {
  try {
    // Find the order
    const order = OrderState.orders.find(o => o._id === orderId || o.id === orderId);
    if (!order) {
      showNotification('Order not found', 'error');
      return;
    }
    
    // Get available status options based on current status
    const availableStatuses = getAvailableStatuses(order.status);
    
    // Create status update modal
    const modalHTML = `
      <div class="modal-overlay" id="updateStatusModal">
        <div class="modal-content" style="max-width: 500px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Update Order Status</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--cream);">&times;</button>
          </div>
          
          <div style="margin-bottom: 20px;">
            <p><strong>Order:</strong> ${order.orderNumber || order._id}</p>
            <p><strong>Current Status:</strong> <span class="status-badge status-${order.status?.toLowerCase().replace('_', '-')}">${order.status || 'Pending'}</span></p>
          </div>
          
          <div class="form-group">
            <label for="newOrderStatus">New Status</label>
            <select id="newOrderStatus" class="form-control" style="margin-bottom: 10px;">
              ${availableStatuses.map(status => `
                <option value="${status.value}">${status.label}</option>
              `).join('')}
            </select>
          </div>
          
          <div class="form-group">
            <label for="statusNotes">Notes (Optional)</label>
            <textarea id="statusNotes" class="form-control" rows="3" 
                      placeholder="Add notes about this status update..."></textarea>
          </div>
          
          ${availableStatuses.find(s => s.value === 'shipped') ? `
          <div class="form-group" id="shippingInfoSection" style="display: none;">
            <label for="trackingNumber">Tracking Number</label>
            <input type="text" id="trackingNumber" class="form-control" placeholder="Enter tracking number">
            
            <label for="shippingCarrier" style="margin-top: 10px;">Shipping Carrier</label>
            <select id="shippingCarrier" class="form-control">
              <option value="">Select Carrier</option>
              <option value="fedex">FedEx</option>
              <option value="ups">UPS</option>
              <option value="usps">USPS</option>
              <option value="dhl">DHL</option>
              <option value="other">Other</option>
            </select>
          </div>
          ` : ''}
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="notifyCustomer" checked>
              Notify customer about this update
            </label>
          </div>
          
          <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button class="action-btn btn-danger" onclick="closeModal()">
              Cancel
            </button>
            <button class="action-btn" id="confirmUpdateBtn" onclick="confirmOrderStatusUpdate('${orderId}')">
              Update Status
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal
    const existingModal = document.getElementById('updateStatusModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show/hide shipping info based on selected status
    const statusSelect = document.getElementById('newOrderStatus');
    const shippingSection = document.getElementById('shippingInfoSection');
    
    if (statusSelect && shippingSection) {
      statusSelect.addEventListener('change', function() {
        shippingSection.style.display = this.value === 'shipped' ? 'block' : 'none';
      });
    }
    
  } catch (error) {
    console.error('Update order status error:', error);
    showNotification('Failed to update order status', 'error');
  }
}

// Get available statuses based on current status
function getAvailableStatuses(currentStatus) {
  const allStatuses = [
    { value: 'pending', label: 'Pending', color: 'warning' },
    { value: 'confirmed', label: 'Confirmed', color: 'info' },
    { value: 'processing', label: 'Processing', color: 'info' },
    { value: 'shipped', label: 'Shipped', color: 'success' },
    { value: 'delivered', label: 'Delivered', color: 'success' },
    { value: 'cancelled', label: 'Cancelled', color: 'danger' },
    { value: 'refunded', label: 'Refunded', color: 'danger' }
  ];
  
  // Define allowed transitions
  const transitions = {
    'pending': ['confirmed', 'processing', 'cancelled'],
    'confirmed': ['processing', 'cancelled'],
    'processing': ['shipped', 'cancelled'],
    'shipped': ['delivered'],
    'delivered': ['refunded'],
    'cancelled': [],
    'refunded': []
  };
  
  const allowed = transitions[currentStatus] || ['confirmed', 'processing', 'shipped', 'delivered', 'cancelled'];
  
  return allStatuses.filter(status => allowed.includes(status.value));
}

// Confirm and execute order status update
async function confirmOrderStatusUpdate(orderId) {
  try {
    const newStatus = document.getElementById('newOrderStatus').value;
    const notes = document.getElementById('statusNotes').value;
    const notifyCustomer = document.getElementById('notifyCustomer')?.checked || false;
    const trackingNumber = document.getElementById('trackingNumber')?.value || null;
    const shippingCarrier = document.getElementById('shippingCarrier')?.value || null;
    
    if (!newStatus) {
      showNotification('Please select a status', 'error');
      return;
    }
    
    // Show loading
    const confirmBtn = document.getElementById('confirmUpdateBtn');
    const originalText = confirmBtn.textContent;
    confirmBtn.textContent = 'Updating...';
    confirmBtn.disabled = true;
    
    // Prepare update data - match the format expected by adminOrders.js
    const updateData = {
      status: newStatus,
      notes: notes || undefined
      // The notifyCustomer and trackingInfo might need to be handled differently
      // Check what your backend expects
    };
    
    // Send update request - FIXED ENDPOINT
    const result = await ApiClient.authenticatedRequest(
      `${ENDPOINTS.ORDERS}/${orderId}/status`, // Use the correct endpoint
      {
        method: 'PUT',
        body: JSON.stringify(updateData)
      }
    );
    
    if (result.ok) {
      showNotification('Order status updated successfully!', 'success');
      closeModal();
      
      // Refresh orders list
      await loadOrders();
      
      // If there's an open order details modal, refresh it
      const orderModal = document.getElementById('orderDetailsModal');
      if (orderModal) {
        await viewOrder(orderId);
      }
    } else {
      throw new Error(result.error || 'Failed to update order status');
    }
    
  } catch (error) {
    console.error('Confirm status update error:', error);
    showNotification(`Failed to update order status: ${error.message}`, 'error');
  } finally {
    // Reset button
    const confirmBtn = document.getElementById('confirmUpdateBtn');
    if (confirmBtn) {
      confirmBtn.textContent = 'Update Status';
      confirmBtn.disabled = false;
    }
  }
}

// ==================== BULK ORDER ACTIONS ====================

// Toggle order selection
function toggleOrderSelection(orderId, isSelected) {
  if (isSelected) {
    OrderState.selectedOrders.add(orderId);
  } else {
    OrderState.selectedOrders.delete(orderId);
    document.getElementById('selectAllCheckbox').checked = false;
    OrderState.isSelectAll = false;
  }
  
  updateSelectedCount();
}

// Toggle select all orders
function toggleSelectAllOrders(checkbox) {
  OrderState.isSelectAll = checkbox.checked;
  const checkboxes = document.querySelectorAll('.order-checkbox');
  
  checkboxes.forEach(cb => {
    cb.checked = checkbox.checked;
    const orderId = cb.dataset.orderId;
    
    if (checkbox.checked) {
      OrderState.selectedOrders.add(orderId);
    } else {
      OrderState.selectedOrders.delete(orderId);
    }
  });
  
  updateSelectedCount();
}

// Update selected count display
function updateSelectedCount() {
  const count = OrderState.selectedOrders.size;
  document.getElementById('selectedCount').textContent = `${count} order${count !== 1 ? 's' : ''} selected`;
}

// Bulk update order status
async function bulkUpdateOrderStatus() {
  if (OrderState.selectedOrders.size === 0) {
    showNotification('Please select at least one order', 'warning');
    return;
  }
  
  // Create bulk update modal
  const modalHTML = `
    <div class="modal-overlay" id="bulkUpdateModal">
      <div class="modal-content" style="max-width: 500px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">Bulk Update Order Status</h3>
          <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--cream);">&times;</button>
        </div>
        
        <div style="margin-bottom: 20px;">
          <p>Update status for <strong>${OrderState.selectedOrders.size} selected orders</strong></p>
        </div>
        
        <div class="form-group">
          <label for="bulkOrderStatus">New Status</label>
          <select id="bulkOrderStatus" class="form-control" style="margin-bottom: 10px;">
            <option value="confirmed">Confirmed</option>
            <option value="processing">Processing</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="bulkStatusNotes">Notes (Optional)</label>
          <textarea id="bulkStatusNotes" class="form-control" rows="3" 
                    placeholder="Add notes about this status update..."></textarea>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="bulkNotifyCustomer" checked>
            Notify customers about this update
          </label>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
          <button class="action-btn btn-danger" onclick="closeModal()">
            Cancel
          </button>
          <button class="action-btn" id="confirmBulkUpdateBtn" onclick="confirmBulkOrderStatusUpdate()">
            Update ${OrderState.selectedOrders.size} Orders
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal
  const existingModal = document.getElementById('bulkUpdateModal');
  if (existingModal) existingModal.remove();
  
  // Add new modal
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Confirm bulk order status update
async function confirmBulkOrderStatusUpdate() {
  try {
    const newStatus = document.getElementById('bulkOrderStatus').value;
    const notes = document.getElementById('bulkStatusNotes').value;
    const notifyCustomer = document.getElementById('bulkNotifyCustomer')?.checked || false;
    
    if (!newStatus) {
      showNotification('Please select a status', 'error');
      return;
    }
    
    // Show loading
    const confirmBtn = document.getElementById('confirmBulkUpdateBtn');
    const originalText = confirmBtn.textContent;
    confirmBtn.textContent = 'Updating...';
    confirmBtn.disabled = true;
    
    // You need individual updates for bulk since your backend doesn't have bulk status update
    // Or you need to implement bulk status update endpoint
    
    // For now, update one by one
    let successCount = 0;
    const orderIds = Array.from(OrderState.selectedOrders);
    
    for (const orderId of orderIds) {
      try {
        const updateData = {
          status: newStatus,
          notes: notes || undefined
        };
        
        const result = await ApiClient.authenticatedRequest(
          `${ENDPOINTS.ORDERS}/${orderId}/status`,
          {
            method: 'PUT',
            body: JSON.stringify(updateData)
          }
        );
        
        if (result.ok) {
          successCount++;
        }
      } catch (error) {
        console.error(`Failed to update order ${orderId}:`, error);
      }
    }
    
    showNotification(`Updated ${successCount} out of ${orderIds.length} orders successfully!`, 'success');
    closeModal();
    
    // Clear selection
    OrderState.selectedOrders.clear();
    updateSelectedCount();
    document.getElementById('selectAllCheckbox').checked = false;
    
    // Refresh orders list
    await loadOrders();
    
  } catch (error) {
    console.error('Bulk update error:', error);
    showNotification(`Failed to update orders: ${error.message}`, 'error');
  } finally {
    // Reset button
    const confirmBtn = document.getElementById('confirmBulkUpdateBtn');
    if (confirmBtn) {
      confirmBtn.textContent = `Update ${OrderState.selectedOrders.size} Orders`;
      confirmBtn.disabled = false;
    }
  }
}

// ==================== DELETE ORDER ====================
async function deleteOrder(orderId, skipConfirm = false) {
  try {
    // Find the order
    const order = OrderState.orders.find(o => o._id === orderId || o.id === orderId);
    if (!order) {
      showNotification('Order not found', 'error');
      return;
    }
    
    // Confirm deletion
    if (!skipConfirm) {
      const confirmDelete = confirm(`Are you sure you want to delete order ${order.orderNumber || orderId}? This action cannot be undone.`);
      if (!confirmDelete) return;
    }
    
    showNotification('Deleting order...', 'info');
    
    // Send delete request
    const result = await ApiClient.authenticatedRequest(
      `${ENDPOINTS.DELETE_ORDER}/${orderId}`,
      {
        method: 'DELETE'
      }
    );
    
    if (result.ok) {
      showNotification('Order deleted successfully!', 'success');
      
      // Remove from selection if selected
      OrderState.selectedOrders.delete(orderId);
      updateSelectedCount();
      
      // Refresh orders list
      await loadOrders();
      
      // Close any open modals
      closeModal();
    } else {
      throw new Error(result.error || 'Failed to delete order');
    }
    
  } catch (error) {
    console.error('Delete order error:', error);
    showNotification('Failed to delete order', 'error');
  }
}

// Bulk delete orders
async function bulkDeleteOrders() {
  if (OrderState.selectedOrders.size === 0) {
    showNotification('Please select at least one order', 'warning');
    return;
  }
  
  const confirmDelete = confirm(`Are you sure you want to delete ${OrderState.selectedOrders.size} selected orders? This action cannot be undone.`);
  if (!confirmDelete) return;
  
  try {
    showNotification(`Deleting ${OrderState.selectedOrders.size} orders...`, 'info');
    
    // Send bulk delete request
    const result = await ApiClient.authenticatedRequest(
      ENDPOINTS.BULK_DELETE_ORDERS,
      {
        method: 'DELETE',
        body: JSON.stringify({
          orderIds: Array.from(OrderState.selectedOrders)
        })
      }
    );
    
    if (result.ok) {
      showNotification(`Deleted ${OrderState.selectedOrders.size} orders successfully!`, 'success');
      
      // Clear selection
      OrderState.selectedOrders.clear();
      updateSelectedCount();
      document.getElementById('selectAllCheckbox').checked = false;
      
      // Refresh orders list
      await loadOrders();
    } else {
      throw new Error(result.error || 'Failed to delete orders');
    }
    
  } catch (error) {
    console.error('Bulk delete error:', error);
    showNotification('Failed to delete orders', 'error');
  }
}

// ==================== UTILITY FUNCTIONS ====================

// Print invoice
function printInvoice(orderId) {
  showNotification('Invoice printing feature coming soon', 'info');
}

// Print shipping label
function printShippingLabel(orderId) {
  showNotification('Shipping label printing feature coming soon', 'info');
}

// Close modal
function closeModal() {
  const modals = document.querySelectorAll('.modal-overlay');
  modals.forEach(modal => modal.remove());
}
    </script>
    <script src="language-config.js"></script>
  </body>
</html>