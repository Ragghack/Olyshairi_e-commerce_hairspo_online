<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- üñºÔ∏è Favicon (shows in browser tab) -->
    <link rel="icon" type="image/png" href="/images/Logo Version Transparente-01.png">
    <!-- Optional for Apple/Android homescreens -->
    <link rel="apple-touch-icon" href="/images/Logo Version Transparente-01.png">

    <!-- üîç Google Structured Data (shows logo in search results) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "url": "https://www.olyshair.com",
      "logo": "https://www.olyshair.com/images/Logo%20Version%20Transparente-01.png"
    }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OLYS HAIR - Customer Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --cream: #392625;
        --white: #ffffff;
        --dark-gray: #1e1e1e;
        --light-bg: #f8f5f2;
        --text-dark: #1e1e1e;
        --text-light: #ffffff;
        --card-bg: #ffffff;
        --shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        --accent: #c8a97e;
        --success: #4caf50;
        --warning: #ff9800;
        --info: #2196f3;
      }

      .dark-mode {
        --cream: #c8b4a8;
        --white: #1e1e1e;
        --dark-gray: #f8f5f2;
        --light-bg: #2d2d2d;
        --text-dark: #f8f5f2;
        --text-light: #1e1e1e;
        --card-bg: #181212;
        --shadow: 0 5px 15px rgba(182, 131, 131, 0.2);
        --accent: #d4b896;
      }

      body {
        font-family: "Montserrat", sans-serif;
        background-color: var(--white);
        color: var(--text-dark);
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      h1,
      h2,
      h3,
      h4 {
        font-family: "Playfair Display", serif;
        font-weight: 600;
        color: var(--cream);
      }

      /* Header */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background-color: var(--white);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
        box-shadow: var(--shadow);
      }

      .logo-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 120px;
        height: 50px;
        background-color: var(--white);
        border-radius: 10px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .logo {
        max-width: 100px;
        max-height: 40px;
        display: block;
        margin: 0 auto;
        object-fit: contain;
      }

      /* Mobile Menu Toggle */
      .mobile-menu-toggle {
        display: none;
        flex-direction: column;
        justify-content: space-between;
        width: 30px;
        height: 21px;
        cursor: pointer;
      }

      .mobile-menu-toggle span {
        display: block;
        height: 3px;
        width: 100%;
        background-color: var(--cream);
        border-radius: 3px;
        transition: all 0.3s ease;
      }

      .mobile-menu-toggle.active span:nth-child(1) {
        transform: translateY(9px) rotate(45deg);
      }

      .mobile-menu-toggle.active span:nth-child(2) {
        opacity: 0;
      }

      .mobile-menu-toggle.active span:nth-child(3) {
        transform: translateY(-9px) rotate(-45deg);
      }

      .header-icons {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .header-icons i {
        font-size: 18px;
        color: var(--cream);
        cursor: pointer;
      }

      .user-profile {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .user-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background-color: var(--cream);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-weight: bold;
        font-size: 14px;
      }

      .username {
        display: block;
        font-size: 14px;
        font-weight: 500;
      }

      .dropdown-menu {
        position: absolute;
        top: 45px;
        right: 0;
        background-color: var(--white);
        border-radius: 8px;
        box-shadow: var(--shadow);
        width: 180px;
        padding: 12px;
        display: none;
        z-index: 1001;
      }

      .dropdown-menu.show {
        display: block;
      }

      .dropdown-menu a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        text-decoration: none;
        color: var(--text-dark);
        border-radius: 4px;
        font-size: 14px;
      }

      .dropdown-menu a:hover {
        background-color: var(--light-bg);
      }

      /* Dark/Light Mode Toggle */
      .mode-toggle {
        position: relative;
        width: 50px;
        height: 25px;
        background-color: var(--light-bg);
        border-radius: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 0 4px;
      }

      .toggle-circle {
        position: absolute;
        width: 18px;
        height: 18px;
        background-color: var(--cream);
        border-radius: 50%;
        transition: all 0.3s ease;
        left: 4px;
      }

      .dark-mode .toggle-circle {
        left: 28px;
      }

      .mode-toggle i {
        font-size: 12px;
        z-index: 2;
      }

      .fa-sun {
        color: var(--cream);
        margin-right: auto;
      }

      .fa-moon {
        color: var(--cream);
        margin-left: auto;
      }

      /* Dashboard Layout */
      .dashboard-container {
        display: flex;
        flex-direction: column;
        margin-top: 90px;
        min-height: calc(100vh - 90px);
      }

      /* Mobile Navigation Menu */
      .mobile-nav {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--white);
        z-index: 999;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding-top: 80px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        overflow-y: auto;
      }

      .mobile-nav.active {
        transform: translateX(0);
      }

      .mobile-nav-links {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 20px;
      }

      .mobile-nav-bubble {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        border-radius: 10px;
        background-color: var(--card-bg);
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        color: var(--text-dark);
      }

      .mobile-nav-bubble:hover,
      .mobile-nav-bubble.active {
        background-color: var(--cream);
        color: var(--white);
        transform: translateX(5px);
      }

      .mobile-nav-bubble i {
        margin-right: 15px;
        font-size: 18px;
        width: 20px;
        text-align: center;
      }

      .mobile-nav-close {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 1.5rem;
        color: var(--cream);
        cursor: pointer;
      }

      /* Sidebar */
      .sidebar {
        width: 100%;
        background-color: var(--light-bg);
        padding: 15px;
        display: flex;
        overflow-x: auto;
        gap: 10px;
        border-bottom: 1px solid var(--light-bg);
      }

      .sidebar-bubble {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-radius: 10px;
        background-color: var(--card-bg);
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: fit-content;
      }

      .sidebar-bubble:hover,
      .sidebar-bubble.active {
        background-color: var(--cream);
        color: var(--white);
      }

      .sidebar-bubble i {
        margin-right: 10px;
        font-size: 16px;
      }

      /* Main Content */
      .dashboard-content {
        flex: 1;
        padding: 20px;
      }

      .content-section {
        display: none;
      }

      .content-section.active {
        display: block;
      }

      /* Welcome Banner */
      .welcome-banner {
        background: linear-gradient(
          135deg,
          rgba(57, 38, 37, 0.85),
          rgba(200, 169, 126, 0.85)
        );
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        color: var(--white);
        box-shadow: var(--shadow);
      }

      .welcome-banner h1 {
        color: var(--white);
        margin-bottom: 8px;
        font-size: 1.5rem;
      }

      .points-display {
        display: inline-block;
        background-color: var(--white);
        color: var(--cream);
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 600;
        margin: 10px 0;
        font-size: 0.9rem;
      }

      .quick-shortcuts {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .shortcut-btn {
        padding: 8px 15px;
        background-color: var(--white);
        color: var(--cream);
        border-radius: 8px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        flex: 1;
        min-width: 120px;
        justify-content: center;
      }

      .shortcut-btn:hover {
        background-color: var(--dark-gray);
        color: var(--white);
        transform: translateY(-2px);
      }

      /* Dashboard Sections */
      .dashboard-section {
        margin-bottom: 25px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .section-header h2 {
        font-size: 1.3rem;
      }

      .view-all {
        color: var(--cream);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .card-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .dashboard-card {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 15px;
        box-shadow: var(--shadow);
      }

      /* Stats */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 15px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--light-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        color: var(--cream);
        font-size: 16px;
      }

      .stat-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--cream);
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 12px;
        color: var(--text-dark);
      }

      /* Loading States */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 15px;
        color: var(--cream);
        font-size: 0.9rem;
      }

      .loading-spinner {
        width: 18px;
        height: 18px;
        border: 2px solid var(--light-bg);
        border-top: 2px solid var(--cream);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Empty States */
      .empty-state {
        text-align: center;
        padding: 30px 15px;
        color: var(--cream);
      }

      .empty-state i {
        font-size: 36px;
        margin-bottom: 10px;
        opacity: 0.7;
      }

      .empty-state p {
        margin-bottom: 15px;
        font-size: 0.9rem;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: var(--cream);
        font-size: 0.9rem;
      }

      .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--light-bg);
        border-radius: 8px;
        background-color: var(--card-bg);
        color: var(--text-dark);
        font-family: "Montserrat", sans-serif;
        font-size: 0.9rem;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--cream);
      }

      .action-btn {
        padding: 10px 20px;
        background-color: var(--cream);
        color: var(--white);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s;
        width: 100%;
      }

      .action-btn:hover {
        background-color: var(--accent);
      }

      /* Profile Section */
      .profile-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--light-bg);
      }

      .profile-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background-color: var(--cream);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 28px;
        margin-right: 15px;
      }

      /* Order Table */
      .order-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
      }

      .order-table th,
      .order-table td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid var(--light-bg);
      }

      .order-table th {
        font-weight: 600;
        color: var(--cream);
        font-size: 0.8rem;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
        display: inline-block;
      }

      .status-delivered {
        background-color: #e6f7ee;
        color: #0c9770;
      }

      .status-processing {
        background-color: #fef5e7;
        color: #e58e02;
      }

      .status-shipped {
        background-color: #e6f0ff;
        color: #2d6bdb;
      }

      .status-pending {
        background-color: #f5f5f5;
        color: #6c757d;
      }

      /* Booking Status Badges */
      .status-pending {
        background-color: #fef5e7;
        color: #e58e02;
      }

      .status-confirmed {
        background-color: #e6f0ff;
        color: #2d6bdb;
      }

      .status-in-progress {
        background-color: #e6f7ff;
        color: #1890ff;
      }

      .status-completed {
        background-color: #e6f7ee;
        color: #0c9770;
      }

      .status-cancelled {
        background-color: #ffe6e6;
        color: #d9534f;
      }

      /* Wishlist and Cart Items */
      .wishlist-item,
      .cart-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--light-bg);
      }

      .item-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        margin-right: 12px;
        background-color: var(--light-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .item-image i {
        font-size: 20px;
        color: var(--cream);
      }

      .item-details {
        flex: 1;
        min-width: 0;
      }

      .item-details h4 {
        font-size: 0.9rem;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .item-price {
        color: var(--cream);
        font-weight: 600;
        margin: 3px 0;
        font-size: 0.9rem;
      }

      .item-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .item-actions .action-btn {
        width: auto;
        padding: 6px 10px;
        font-size: 0.8rem;
      }

      /* Booking Cards */
      .booking-card {
        margin-bottom: 12px;
        padding: 12px;
        border-left: 4px solid var(--cream);
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: var(--shadow);
      }

      .booking-date {
        font-weight: 600;
        color: var(--cream);
        font-size: 0.9rem;
      }

      .booking-service {
        margin: 4px 0;
        font-size: 0.9rem;
      }

      /* Notifications */
      .notification-item {
        padding: 12px;
        border-left: 4px solid var(--cream);
        margin-bottom: 12px;
        background-color: var(--light-bg);
        border-radius: 8px;
      }

      .notification-unread {
        border-left: 4px solid var(--accent);
      }

      .notification-time {
        font-size: 11px;
        color: var(--cream);
        margin-top: 4px;
      }

      /* Floating Bubbles */
      .floating-bubbles {
        position: fixed;
        right: 15px;
        bottom: 80px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1200;
      }

      .bubble-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: var(--cream);
        color: var(--white);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .bubble-btn span {
        display: none;
        position: absolute;
        right: 60px;
        background: var(--dark-gray);
        color: var(--white);
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
      }

      .bubble-btn:hover {
        background-color: var(--accent);
        transform: scale(1.05);
      }

      .bubble-btn:hover span {
        display: block;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .mobile-menu-toggle {
          display: flex;
        }

        .username {
          display: none;
        }

        .dashboard-container {
          margin-top: 80px;
        }

        .sidebar {
          display: none;
        }

        .dashboard-content {
          padding: 15px;
        }

        .stats-container {
          grid-template-columns: repeat(2, 1fr);
        }

        .quick-shortcuts {
          flex-direction: column;
        }

        .shortcut-btn {
          width: 100%;
        }

        .order-table {
          display: block;
          overflow-x: auto;
        }

        .floating-bubbles {
          bottom: 70px;
          right: 10px;
        }

        .bubble-btn {
          width: 45px;
          height: 45px;
          font-size: 16px;
        }
      }

      @media (max-width: 480px) {
        header {
          padding: 12px 15px;
        }

        .logo-container {
          width: 100px;
          height: 40px;
        }

        .dashboard-container {
          margin-top: 70px;
        }

        .dashboard-content {
          padding: 10px;
        }

        .welcome-banner {
          padding: 15px;
        }

        .welcome-banner h1 {
          font-size: 1.3rem;
        }

        .stats-container {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .stat-card {
          padding: 12px;
        }

        .dashboard-card {
          padding: 12px;
        }

        .item-actions {
          flex-direction: column;
          gap: 5px;
        }

        .item-actions .action-btn {
          width: 100%;
        }
      }

      @media (min-width: 769px) {
        .dashboard-container {
          flex-direction: row;
          margin-top: 100px;
        }

        .sidebar {
          width: 250px;
          flex-direction: column;
          padding: 20px;
          position: fixed;
          height: calc(100vh - 100px);
          overflow-y: auto;
          border-bottom: none;
        }

        .dashboard-content {
          margin-left: 250px;
          padding: 25px;
        }

        .sidebar-bubble {
          margin-bottom: 8px;
          padding: 12px 15px;
        }

        .card-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .stats-container {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      @media (min-width: 1024px) {
        .card-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      .item-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.item-image {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  overflow: hidden;
  margin-right: 12px;
  background-color: var(--light-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
/* Order Timeline Styles */
.order-timeline {
    position: relative;
    padding: 20px 0;
}

.order-timeline::before {
    content: '';
    position: absolute;
    top: 40px;
    left: 50px;
    right: 50px;
    height: 2px;
    background-color: var(--light-bg);
    z-index: 1;
}

.order-timeline .timeline-step {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
}

.timeline-step.completed .timeline-icon {
    background-color: var(--cream);
    color: white;
    transform: scale(1.1);
}

.timeline-step.current .timeline-icon {
    box-shadow: 0 0 0 4px rgba(200, 169, 126, 0.3);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(200, 169, 126, 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(200, 169, 126, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(200, 169, 126, 0);
    }
}

/* Modal Styles for Order Details */
.order-details-modal .modal-content {
    max-width: 900px;
}

.order-items-table {
    width: 100%;
    border-collapse: collapse;
}

.order-items-table th {
    background-color: var(--light-bg);
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: var(--cream);
}

.order-items-table td {
    padding: 12px;
    border-bottom: 1px solid var(--light-bg);
}

.order-items-table tfoot td {
    border-top: 2px solid var(--cream);
    font-weight: bold;
}

/* Enhanced notification styles */
.notification-item {
    padding: 15px;
    border-left: 4px solid var(--cream);
    margin-bottom: 15px;
    background-color: var(--card-bg);
    border-radius: 8px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    position: relative;
}

.notification-unread {
    border-left: 4px solid #ff6b6b;
    background-color: rgba(255, 107, 107, 0.05);
}

.notification-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.notification-time {
    font-size: 12px;
    color: var(--cream);
    margin-top: 8px;
    opacity: 0.8;
}

/* Email resend button styles */
.email-resend-btn {
    background: linear-gradient(135deg, var(--cream), #d4b896);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.email-resend-btn:hover {
    background: linear-gradient(135deg, #d4b896, var(--cream));
    transform: translateY(-2px);
}

/* Notification groups */
.notification-group {
    margin-bottom: 30px;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Notification badge animation */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.notification-badge.pulse {
    animation: pulse 1s ease infinite;
}

/* Add to your existing CSS */
.notification-item {
    padding: 15px;
    border-left: 4px solid var(--cream);
    margin-bottom: 15px;
    background-color: var(--card-bg);
    border-radius: 8px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    position: relative;
}

.notification-unread {
    border-left: 4px solid #ff6b6b;
    background-color: rgba(255, 107, 107, 0.05);
}

.notification-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.notification-time {
    font-size: 12px;
    color: var(--cream);
    margin-top: 8px;
    opacity: 0.8;
}
    </style>
  </head>
<body>
    <!-- Header -->
    <header>
      <!-- Add to header-icons section -->
<div class="notification-badge-container" style="position: relative;">
    <i class="fas fa-bell" title="Notifications"></i>
    <span class="notification-badge" id="notificationBadge" 
          style="position: absolute; top: -5px; right: -5px; background: #ff4757; 
                 color: white; border-radius: 50%; width: 18px; height: 18px; 
                 font-size: 10px; display: flex; align-items: center; 
                 justify-content: center; display: none;">
        0
    </span>
</div>
      <div class="logo-container">
        <span>
          <img
            src="images/Logo Version Transparente-01.png"
            alt="OLYS HAIR Logo"
            class="logo"
          />
        </span>
      </div>
      
      <!-- Mobile Menu Toggle -->
      <div class="mobile-menu-toggle" id="mobileMenuToggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
      
      <div class="header-icons">
        <!--<i class="fas fa-search"  title="Search"></i>-->
        <i class="fas fa-shopping-bag"  title="Cart"></i>
        <div class="user-profile">
          <div class="user-avatar" id="user-avatar">U</div>
          <span class="username" id="username" data-translate="">User</span>
          <div class="dropdown-menu">
            <a href="#" data-section="profile">
              <i class="fas fa-user"></i> <span data-translate="myProfile">My Profile</span>
            </a>
            <a href="#" data-section="settings">
              <i class="fas fa-cog"></i> <span data-translate="settings">Settings</span>
            </a>
            <a href="#" id="logout-btn">
              <i class="fas fa-sign-out-alt"></i> <span data-translate="logout">Logout</span>
            </a>
          </div>
        </div>
        <div class="mode-toggle">
          <i class="fas fa-sun"></i>
          <i class="fas fa-moon"></i>
          <div class="toggle-circle"></div>
        </div>
      </div>
    </header>

    <!-- Mobile Navigation Menu -->
    <div class="mobile-nav" id="mobileNav">
      <div class="mobile-nav-close" id="mobileNavClose">
        <i class="fas fa-times"></i>
      </div>
      <div class="mobile-nav-links">
        <a href="#" class="mobile-nav-bubble active" data-section="dashboard">
          <i class="fas fa-home"></i>
          <span data-translate="dashboard">Dashboard</span>
        </a>
        <a href="#" class="mobile-nav-bubble" data-section="cart">
          <i class="fas fa-shopping-cart"></i>
          <span data-translate="myCart">My Cart</span>
        </a>
        <a href="#" class="mobile-nav-bubble" data-section="wishlist">
          <i class="fas fa-heart"></i>
          <span data-translate="wishlist">Wishlist</span>
        </a>
        <a href="#" class="mobile-nav-bubble" data-section="orders">
          <i class="fas fa-box"></i>
          <span data-translate="myOrders">My Orders</span>
        </a>
        <a href="#" class="mobile-nav-bubble" data-section="bookings">
          <i class="fas fa-calendar-alt"></i>
          <span data-translate="bookings">Bookings</span>
        </a>
       <a href="#" class="mobile-nav-bubble" data-section="notifications">
          <i class="fas fa-bell"></i>
          <span data-translate="notifications">Notifications</span>
        </a>
        <a href="#" class="mobile-nav-bubble" data-section="settings">
          <i class="fas fa-cog"></i>
          <span data-translate="settings">Settings</span>
        </a>
        <a href="index.html" class="mobile-nav-bubble">
          <i class="fas fa-home"></i>
          <span data-translate="home">Home</span>
        </a>
        <a href="shop.html" class="mobile-nav-bubble">
          <i class="fas fa-shopping-bag"></i>
          <span data-translate="shop">Shop</span>
        </a>
        <a href="book.html" class="mobile-nav-bubble">
          <i class="fas fa-calendar-plus"></i>
          <span data-translate="bookService">Book Service</span>
        </a>
      </div>
    </div>

    <!-- Floating Bubbles -->
    <div class="floating-bubbles">
      <div class="bubble-btn" onclick="window.location.href='index.html'">
        <i class="fas fa-home"></i>
        <span data-translate="home">Home</span>
      </div>
      <div class="bubble-btn" onclick="window.location.href='shop.html'">
        <i class="fas fa-shopping-bag"></i>
        <span data-translate="shop">Shop</span>
      </div>
      <div class="bubble-btn" onclick="window.location.href='book.html'">
        <i class="fas fa-calendar-plus"></i>
        <span data-translate="bookService">Book Service</span>
      </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
      <!-- Sidebar Navigation -->
      <div class="sidebar">
        <div class="sidebar-bubble active" data-section="dashboard">
          <i class="fas fa-home"></i>
          <span data-translate="dashboard">Dashboard</span>
        </div>
        <div class="sidebar-bubble" data-section="cart">
          <i class="fas fa-shopping-cart"></i>
          <span data-translate="myCart">My Cart</span>
        </div>
        <div class="sidebar-bubble" data-section="wishlist">
          <i class="fas fa-heart"></i>
          <span data-translate="wishlist">Wishlist</span>
        </div>
        <div class="sidebar-bubble" data-section="orders">
          <i class="fas fa-box"></i>
          <span data-translate="myOrders">My Orders</span>
        </div>
        <div class="sidebar-bubble" data-section="bookings">
          <i class="fas fa-calendar-alt"></i>
          <span data-translate="bookings">Bookings</span>
        </div>
        <div class="sidebar-bubble" data-section="notifications">
          <i class="fas fa-bell"></i>
          <span data-translate="notifications">Notifications</span>
        </div>
        <div class="sidebar-bubble" data-section="settings">
          <i class="fas fa-cog"></i>
          <span data-translate="settings">Settings</span>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="dashboard-content">
        
        <!-- Dashboard Section -->
        <div class="content-section active" id="dashboard">
          
          <!-- Welcome Banner -->
          <div class="welcome-banner">
            <h1 id="welcome-message" data-translate="welcomeBack">Welcome back!</h1>
            <p id="welcome-subtitle" data-translate="readyToDiscover">
              Ready to discover your next favorite hair product?
            </p>
            <div class="points-display">
              <i class="fas fa-gem"></i>
              <span id="loyalty-points">0</span> <span data-translate="loyaltyPoints">Loyalty Points</span>
            </div>
            <div class="quick-shortcuts">
              <div class="shortcut-btn" onclick="window.location.href='shop.html'">
                <i class="fas fa-shopping-bag"></i>
                <span data-translate="shopNewArrivals">Shop New Arrivals</span>
              </div>
              <div class="shortcut-btn" onclick="window.location.href='book.html'">
                <i class="fas fa-calendar-plus"></i>
                <span data-translate="bookWigService">Book Wig Service</span>
              </div>
              <div class="shortcut-btn" data-section="orders">
                <i class="fas fa-box-open"></i>
                <span data-translate="trackOrders">Track Orders</span>
              </div>
            </div>
          </div>

          <!-- Stats Overview -->
          <div class="stats-container" id="stats-container">
            <div class="loading">
              <div class="loading-spinner"></div>
              <span data-translate="loadingStatistics">Loading statistics...</span>
            </div>
          </div>

          <!-- Recent Orders Section -->
          <div class="dashboard-section">
            <div class="section-header">
              <h2 data-translate="recentOrders">Recent Orders</h2>
              <a href="#" class="view-all" data-section="orders" data-translate="viewAll">View All</a>
            </div>
            <div class="dashboard-card">
              <div id="recent-orders-container">
                <div class="loading">
                  <div class="loading-spinner"></div>
                  <span data-translate="loadingRecentOrders">Loading recent orders...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Wishlist and Cart Section -->
          <div class="card-grid">
            
            <!-- Wishlist -->
            <div class="dashboard-section">
              <div class="section-header">
                <h2 data-translate="wishlist">Wishlist</h2>
                <a href="#" class="view-all" data-section="wishlist" data-translate="viewAll">View All</a>
              </div>
              <div class="dashboard-card">
                <div id="wishlist-preview-container">
                  <div class="loading">
                    <div class="loading-spinner"></div>
                    <span data-translate="loadingWishlist">Loading wishlist...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cart -->
            <div class="dashboard-section">
              <div class="section-header">
                <h2 data-translate="cart">Cart</h2>
                <a href="#" class="view-all" data-section="cart" data-translate="viewCart">View Cart</a>
              </div>
              <div class="dashboard-card">
                <div id="cart-preview-container">
                  <div class="loading">
                    <div class="loading-spinner"></div>
                    <span data-translate="loadingCart">Loading cart...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Upcoming Bookings -->
          <div class="dashboard-section">
            <div class="section-header">
              <h2 data-translate="upcomingBookings">Upcoming Bookings</h2>
              <a href="#" class="view-all" data-section="bookings" data-translate="viewAll">View All</a>
            </div>
            <div class="dashboard-card">
              <div id="upcoming-bookings-container">
                <div class="loading">
                  <div class="loading-spinner"></div>
                  <span data-translate="loadingBookings">Loading upcoming bookings...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Notifications -->
          <div class="dashboard-section">
            <div class="section-header">
              <h2 data-translate="notifications">Notifications</h2>
              <a href="#" class="view-all" data-section="notifications" data-translate="viewAll">View All</a>
            </div>
            <div class="dashboard-card">
              <div id="notifications-preview-container">
                <div class="loading">
                  <div class="loading-spinner"></div>
                  <span data-translate="loadingNotifications">Loading notifications...</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cart Section -->
        <div class="content-section" id="cart">
          <div class="section-header">
            <h2 data-translate="myCart">My Cart</h2>
          </div>
          <div class="dashboard-card">
            <div id="cart-full-container">
              <div class="loading">
                <div class="loading-spinner"></div>
                <span data-translate="loadingCart">Loading cart...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Wishlist Section -->
        <div class="content-section" id="wishlist">
          <div class="section-header">
            <h2 data-translate="myWishlist">My Wishlist</h2>
          </div>
          <div class="card-grid" id="wishlist-full-container">
            <div class="loading">
              <div class="loading-spinner"></div>
              <span data-translate="loadingWishlist">Loading wishlist...</span>
            </div>
          </div>
        </div>

        <!-- Orders Section -->
        <div class="content-section" id="orders">
          <div class="section-header">
            <h2 data-translate="orderHistory">Order History</h2>
          </div>
          <div class="dashboard-card">
            <div id="orders-full-container">
              <div class="loading">
                <div class="loading-spinner"></div>
                <span data-translate="loadingOrderHistory">Loading order history...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Bookings Section -->
        <div class="content-section" id="bookings">
          <div class="section-header">
            <h2 data-translate="myWigServiceBookings">My Wig Service Bookings</h2>
            <button class="action-btn" onclick="window.location.href='book.html'" style="width: auto;">
              <i class="fas fa-calendar-plus"></i> <span data-translate="bookNewService">Book New Service</span>
            </button>
          </div>
          <div class="dashboard-card">
            <div id="bookings-full-container">
              <div class="loading">
                <div class="loading-spinner"></div>
                <span data-translate="loadingAppointments">Loading appointments...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Notifications Section -->
        <div class="content-section" id="notifications">
          <div class="section-header">
            <h2 data-translate="notifications">Notifications</h2>
            <button class="action-btn" id="mark-all-read" style="width: auto;">
              <span data-translate="markAllAsRead">Mark All as Read</span>
            </button>
          </div>
          <div class="dashboard-card">
            <div id="notifications-full-container">
              <div class="loading">
                <div class="loading-spinner"></div>
                <span data-translate="loadingNotifications">Loading notifications...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Section -->
        <div class="content-section" id="settings">
          <div class="section-header">
            <h2 data-translate="accountSettings">Account Settings</h2>
          </div>
          
          <!-- Profile Information -->
          <div class="dashboard-card">
            <div class="profile-header">
              <div class="profile-avatar" id="settings-avatar">U</div>
              <div class="profile-info">
                <h2 id="settings-name">User</h2>
                <p id="settings-membership" data-translate="memberSince">Member since ...</p>
              </div>
            </div>

            <div class="form-group">
              <label for="name" data-translate="fullName">Full Name</label>
              <input type="text" id="name" class="form-control" data-translate="enterFullName" placeholder="Enter your full name" />
            </div>

            <div class="form-group">
              <label for="email" data-translate="emailAddress">Email Address</label>
              <input type="email" id="email" class="form-control" data-translate="enterEmail" placeholder="Enter your email" />
            </div>

            <div class="form-group">
              <label for="phone" data-translate="phoneNumber">Phone Number</label>
              <input type="tel" id="phone" class="form-control" data-translate="enterPhone" placeholder="Enter your phone number" />
            </div>

            <div class="form-group">
              <label for="address" data-translate="address">Address</label>
              <textarea id="address" class="form-control" rows="3" data-translate="enterAddress" placeholder="Enter your address"></textarea>
            </div>

            <button class="action-btn" id="save-profile" data-translate="saveChanges">Save Changes</button>
          </div>

          <!-- Security Settings -->
          <div class="dashboard-card" style="margin-top: 20px">
            <h3 style="margin-bottom: 15px" data-translate="securitySettings">Security Settings</h3>

            <div class="form-group">
              <label for="current-password" data-translate="currentPassword">Current Password</label>
              <input type="password" id="current-password" class="form-control" data-translate="enterCurrentPassword" placeholder="Enter current password" />
            </div>

            <div class="form-group">
              <label for="new-password" data-translate="newPassword">New Password</label>
              <input type="password" id="new-password" class="form-control" data-translate="enterNewPassword" placeholder="Enter new password" />
            </div>

            <div class="form-group">
              <label for="confirm-password" data-translate="confirmPassword">Confirm New Password</label>
              <input type="password" id="confirm-password" class="form-control" data-translate="confirmNewPassword" placeholder="Confirm new password" />
            </div>

            <button class="action-btn" id="update-password" data-translate="updatePassword">
              Update Password
            </button>
          </div>

          <!-- Notification Preferences -->
          <div class="dashboard-card" style="margin-top: 20px">
            <h3 style="margin-bottom: 15px" data-translate="notificationPreferences">Notification Preferences</h3>

            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
              <label for="email-notifications" style="margin-bottom: 0" data-translate="emailNotifications">Email Notifications</label>
              <input type="checkbox" id="email-notifications" />
            </div>

            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
              <label for="sms-notifications" style="margin-bottom: 0" data-translate="smsNotifications">SMS Notifications</label>
              <input type="checkbox" id="sms-notifications" />
            </div>

            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
              <label for="promotional-emails" style="margin-bottom: 0" data-translate="promotionalEmails">Promotional Emails</label>
              <input type="checkbox" id="promotional-emails" />
            </div>

            <button class="action-btn" id="save-preferences" data-translate="savePreferences">
              Save Preferences
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ADD THIS SCRIPT TAG AT THE END -->
  <script src="language-config.js"></script>
     <script>



      // Add this to your customer dashboard JavaScript
      function showWhatsAppBookingAction(booking) {
        const message = encodeURIComponent(
          `Bonjour OLYS HAIR,

Je suis le client ${booking.customerName} (R√©f√©rence: ${booking.booking_id}).

Je souhaite:
- Suivre l'√©tat de ma r√©servation
- Poser une question sur le service
- Modifier ma r√©servation

Merci.`
        );

        return `https://wa.me/${WHATSAPP_NUMBER}?text=${message}`;
      }
      // API Configuration
     //Dynamic API URL configuration
      const API_BASE_URL =
         // "http://localhost:5001/api" ;
           "https://olyshairi-e-commerce-hairspo-online-kgz2.onrender.com/api";

      console.log("üåê Using API Base URL:", API_BASE_URL);
      const ENDPOINTS = {
        AUTH_PROFILE: `${API_BASE_URL}/auth/profile`,
        ORDERS: `${API_BASE_URL}/orders`,
        WISHLIST: `${API_BASE_URL}/wishlist`,
        CART: `${API_BASE_URL}/cart`,
        BOOKINGS: `${API_BASE_URL}/bookings`,
        LOYALTY: `${API_BASE_URL}/loyalty`,
        NOTIFICATIONS: `${API_BASE_URL}/notifications`,
        HEALTH: `${API_BASE_URL}/health`,
      };

      let userData = null;
      let authToken = localStorage.getItem("token") || "";
      let cart = JSON.parse(localStorage.getItem("olysHairCart")) || []; // ADD THIS - Same as shop

      // DOM Elements
      const modeToggle = document.querySelector(".mode-toggle");
      const body = document.body;
      const userProfile = document.querySelector(".user-profile");
      const dropdownMenu = document.querySelector(".dropdown-menu");
      const sidebarBubbles = document.querySelectorAll(".sidebar-bubble");
      const mobileNavBubbles = document.querySelectorAll(".mobile-nav-bubble");
      const contentSections = document.querySelectorAll(".content-section");
      const quickShortcuts = document.querySelectorAll(".shortcut-btn");
      const viewAllLinks = document.querySelectorAll(".view-all");
      const logoutBtn = document.getElementById("logout-btn");
      const mobileMenuToggle = document.getElementById("mobileMenuToggle");
      const mobileNav = document.getElementById("mobileNav");
      const mobileNavClose = document.getElementById("mobileNavClose");

// Initialize the dashboard
document.addEventListener("DOMContentLoaded", function () {
    initializeDashboard();
    initializeMobileMenu();
    loadCartFromBackend();
    initializeCounts();
    
    // Initialize notification badge
    updateNotificationBadge();
});
      // Initialize counts on page load
function initializeCounts() {
    const cart = JSON.parse(localStorage.getItem('olysHairCart')) || [];
    const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
    
    updateCartCount();
    updateOrderCount(orders.length);
}

      // Initialize mobile menu
      function initializeMobileMenu() {
        if (mobileMenuToggle && mobileNav) {
          mobileMenuToggle.addEventListener('click', function() {
            mobileMenuToggle.classList.toggle('active');
            mobileNav.classList.toggle('active');
            document.body.style.overflow = mobileNav.classList.contains('active') ? 'hidden' : '';
          });

          mobileNavClose.addEventListener('click', function() {
            mobileMenuToggle.classList.remove('active');
            mobileNav.classList.remove('active');
            document.body.style.overflow = '';
          });

          // Close mobile menu when clicking on a link
          mobileNavBubbles.forEach(link => {
            link.addEventListener('click', function() {
              mobileMenuToggle.classList.remove('active');
              mobileNav.classList.remove('active');
              document.body.style.overflow = '';
            });
          });
        }
      }

      // API Functions
      async function apiCall(endpoint, options = {}) {
        const url = endpoint.startsWith('http') ? endpoint : `${API_BASE_URL}${endpoint}`;
        const headers = {
          Authorization: `Bearer ${authToken}`,
          "Content-Type": "application/json",
          ...options.headers,
        };

        try {
          const response = await fetch(url, { ...options, headers });

          if (response.status === 401) {
            redirectToLogin();
            return null;
          }

          if (!response.ok) {
            const errorText = await response.text();
            console.error(`API Error ${response.status}:`, errorText);
            throw new Error(`API error: ${response.status} - ${errorText}`);
          }

          return await response.json();
        } catch (error) {
          console.error("API call failed:", error);
          throw error;
        }
      }

      // Initialize dashboard
      async function initializeDashboard() {
        console.log("üöÄ Initializing dashboard...");

        // Check authentication
        if (!authToken) {
          console.error("‚ùå No authentication token found");
          redirectToLogin();
          return;
        }

        try {
          console.log("üì° Loading user data...");
          userData = await fetchUserData();

          if (!userData) {
            throw new Error("No user data received");
          }

          updateUserInterface();
          await loadDashboardData();

          console.log("‚úÖ Dashboard initialized successfully");
        } catch (error) {
          console.error("‚ùå Failed to initialize dashboard:", error);
          showError("Failed to load dashboard data");
        }
      }

      async function fetchUserData() {
        try {
          console.log("üîê Fetching user profile...");
          const data = await apiCall("/auth/profile");
          console.log("‚úÖ User data received:", data.user);
          return data.user;
        } catch (error) {
          console.error("‚ùå Error fetching user data:", error);
          throw error;
        }
      }

      // Update all API response handlers to use the new format
// Enhanced fetchOrders function in customerdashboard.html
// Enhanced fetchOrders with server sync
async function fetchOrders(limit = null) {
    try {
        // First check localStorage
        const localOrders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
        
        // Try to sync with server for updated statuses
        let serverOrders = [];
        try {
            const response = await apiCall("/orders");
            if (response && response.orders) {
                serverOrders = response.orders;
                
                // Merge server data with local data
                const mergedOrders = mergeOrders(localOrders, serverOrders);
                
                // Save merged orders back to localStorage
                localStorage.setItem('olysHairOrders', JSON.stringify(mergedOrders));
                
                // Use merged orders for display
                const sortedOrders = mergedOrders.sort((a, b) => 
                    new Date(b.orderDate || b.createdAt) - new Date(a.orderDate || a.createdAt)
                );
                
                return limit ? sortedOrders.slice(0, limit) : sortedOrders;
            }
        } catch (apiError) {
            console.log('Could not fetch from server, using local data:', apiError);
        }
        
        // If server fetch failed, use local data
        if (localOrders.length > 0) {
            const sortedOrders = localOrders.sort((a, b) => 
                new Date(b.orderDate || b.createdAt) - new Date(a.orderDate || a.createdAt)
            );
            return limit ? sortedOrders.slice(0, limit) : sortedOrders;
        }
        
        return [];
        
    } catch (error) {
        console.error("‚ùå Error fetching orders:", error);
        return [];
    }
}

// Function to merge local and server orders
function mergeOrders(localOrders, serverOrders) {
    const merged = [...localOrders];
    
    serverOrders.forEach(serverOrder => {
        const localIndex = merged.findIndex(localOrder => 
            localOrder.orderNumber === serverOrder.orderNumber || 
            localOrder._id === serverOrder._id
        );
        
        if (localIndex !== -1) {
            // Update local order with server data (preserve some local fields)
            merged[localIndex] = {
                ...merged[localIndex],
                status: serverOrder.status,
                trackingNumber: serverOrder.trackingNumber || merged[localIndex].trackingNumber,
                shippingCarrier: serverOrder.shippingCarrier || merged[localIndex].shippingCarrier,
                estimatedDelivery: serverOrder.estimatedDelivery || merged[localIndex].estimatedDelivery,
                cancellationReason: serverOrder.cancellationReason,
                updatedAt: serverOrder.updatedAt,
                statusHistory: serverOrder.statusHistory || merged[localIndex].statusHistory
            };
        } else {
            // Add new order from server
            merged.push(serverOrder);
        }
    });
    
    return merged;
}

      // Fix the fetchWishlist function
      async function fetchWishlist(limit = null) {
        try {
          console.log("üìã Fetching wishlist...");
          const data = await apiCall("/wishlist");

          // Handle different response formats
          if (Array.isArray(data)) {
            return limit ? data.slice(0, limit) : data;
          } else if (data.wishlist && Array.isArray(data.wishlist)) {
            return limit ? data.wishlist.slice(0, limit) : data.wishlist;
          } else if (data.items && Array.isArray(data.items)) {
            return limit ? data.items.slice(0, limit) : data.items;
          } else {
            console.warn("‚ö†Ô∏è Unexpected wishlist format:", data);
            return [];
          }
        } catch (error) {
          console.error("‚ùå Error fetching wishlist:", error);
          return [];
        }
      }

      // FIXED: Fetch cart function - same as shop
      async function fetchCart() {
        try {
          console.log("üõí Fetching cart from backend...");
          const response = await fetch(`${API_BASE_URL}/cart`, {
            headers: {
              "Authorization": `Bearer ${authToken}`,
              "Content-Type": "application/json"
            }
          });

          if (!response.ok) {
            // If 404 or other error, return empty cart
            if (response.status === 404) {
              return { items: [] };
            }
            throw new Error(`Failed to fetch cart: ${response.status}`);
          }

          const data = await response.json();
          console.log("‚úÖ Cart data received:", data);
          
          // Store cart data in local variable - SAME AS SHOP
          if (data.cart && data.cart.items) {
            cart = data.cart.items.map((item) => ({
              productId: item.productId?._id || item.productId,
              name: item.name || item.productId?.name || "Unknown Product",
              price: item.price || item.productId?.price || 0,
              image: item.image || item.productId?.images?.[0]?.url || "images/placeholder-product.jpg",
              quantity: item.quantity,
              maxStock: item.productId?.stock || 999,
            }));
            
            // Save to localStorage as backup - SAME AS SHOP
            localStorage.setItem("olysHairCart", JSON.stringify(cart));
          }
          
          return data.cart || { items: [] };
        } catch (error) {
          console.error("‚ùå Error fetching cart:", error);
          // Return empty cart as fallback
          return { items: [] };
        }
      }

      // BOOKINGS FUNCTIONS - UPDATED
      async function fetchBookings(limit = null) {
        try {
          console.log("üìÖ Fetching bookings...");
          const data = await apiCall("/bookings");

          // Handle different response formats
          if (Array.isArray(data)) {
            return limit ? data.slice(0, limit) : data;
          } else if (data.bookings && Array.isArray(data.bookings)) {
            return limit ? data.bookings.slice(0, limit) : data.bookings;
          } else if (data.data && Array.isArray(data.data)) {
            return limit ? data.data.slice(0, limit) : data.data;
          } else {
            console.warn("‚ö†Ô∏è Unexpected bookings format:", data);
            return getMockBookings(limit);
          }
        } catch (error) {
          console.error("‚ùå Error fetching bookings:", error);
          return getMockBookings(limit);
        }
      }

      function getMockBookings(limit = null) {
        const mockBookings = [
          {
            _id: '1',
            service: 'Wig Renovation',
            wigCount: 2,
            totalPrice: 30,
            status: 'pending',
            createdAt: new Date(),
            estimatedCompletion: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
            notes: 'Please handle with care'
          },
          {
            _id: '2',
            service: 'Wig Renovation',
            wigCount: 1,
            totalPrice: 15,
            status: 'confirmed',
            createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
            estimatedCompletion: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000)
          }
        ];
        
        return limit ? mockBookings.slice(0, limit) : mockBookings;
      }

      async function fetchNotifications(limit = null) {
        const data = await apiCall(
          limit ? `/notifications?limit=${limit}` : "/notifications"
        );
        return data.notifications || [];
      }

      async function fetchLoyaltyPoints() {
        const data = await apiCall("/loyalty");
        return data || { points: 0 };
      }

      // UI Update Functions
      function updateUserInterface() {
        if (!userData) return;

        console.log("üé® Updating UI with user data:", userData);

        // Update user info
        const userInitials =
          (userData.firstName?.charAt(0) || "") +
            (userData.lastName?.charAt(0) || "") || "U";
        document.getElementById("user-avatar").textContent = userInitials;
        document.getElementById("username").textContent =
          userData.firstName || "User";
        document.getElementById(
          "welcome-message"
        ).textContent = `Welcome back, ${userData.firstName || "User"}!`;
        document.getElementById("settings-avatar").textContent = userInitials;
        document.getElementById("settings-name").textContent = `${
          userData.firstName || ""
        } ${userData.lastName || ""}`.trim();

        // Format membership date
        if (userData.memberSince) {
          const memberSince = new Date(userData.memberSince).toLocaleDateString(
            "en-US",
            {
              year: "numeric",
              month: "long",
            }
          );
          document.getElementById(
            "settings-membership"
          ).textContent = `Member since ${memberSince}`;
        }

        // Update form fields
        document.getElementById("name").value = `${userData.firstName || ""} ${
          userData.lastName || ""
        }`.trim();
        document.getElementById("email").value = userData.email || "";
        document.getElementById("phone").value = userData.phoneNumber || "";
        document.getElementById("address").value = userData.address || "";
      }

async function loadDashboardData() {
    try {
        // Load all dashboard data in parallel
        const [loyaltyData, orders, wishlist, cartData, bookings, notifications] =
            await Promise.all([
                fetchLoyaltyPoints(),
                fetchOrders(3),
                fetchWishlist(2),
                fetchCart(),
                fetchBookings(5), // Increase limit for filtering
                fetchNotifications(5), // Increase limit for filtering
            ]);

        // Update loyalty points
        if (loyaltyData && loyaltyData.points !== undefined) {
            document.getElementById("loyalty-points").textContent =
                loyaltyData.points;
        }

        // Update stats
        updateStats(orders, wishlist, cartData, bookings);

        // Update recent orders
        renderRecentOrders(orders);

        // Update wishlist preview
        renderWishlistPreview(wishlist);

        // Update cart preview
        renderCartPreview(cartData);

        // Update upcoming bookings - IMPORTANT: Filter for upcoming only
        renderUpcomingBookings(bookings);

        // Update notifications preview
        renderNotificationsPreview(notifications);
        
        // Update notification badge
        updateNotificationBadge();
    } catch (error) {
        console.error("Failed to load dashboard data:", error);
        // Use mock data as fallback for better UX
        useMockData();
    }
}

      function updateStats(orders, wishlist, cartData, bookings) {
        const statsContainer = document.getElementById("stats-container");

        const stats = {
          orders: orders?.length || 0,
          wishlist: wishlist?.length || 0,
          cart: cartData?.items?.length || 0,
          bookings: bookings?.length || 0,
        };

        statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="stat-value">${stats.orders}</div>
                    <div class="stat-label">Active Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="stat-value">${stats.wishlist}</div>
                    <div class="stat-label">Wishlist Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-value">${stats.bookings}</div>
                    <div class="stat-label">Upcoming Appointments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-gem"></i>
                    </div>
                    <div class="stat-value" id="loyalty-stat">${
                      document.getElementById("loyalty-points").textContent
                    }</div>
                    <div class="stat-label">Loyalty Points</div>
                </div>
            `;
      }

// Enhanced order rendering functions
function renderRecentOrders(orders) {
    const container = document.getElementById("recent-orders-container");

    if (!orders || orders.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <p>No recent orders</p>
                <button class="action-btn" onclick="window.location.href='shop.html'" style="margin-top: 15px;">
                    Start Shopping
                </button>
            </div>
        `;
        return;
    }

    let ordersHtml = `
        <table class="order-table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th>Tracking</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

    orders.forEach((order) => {
        const statusClass = getStatusClass(order.status || "pending");
        const formattedDate = new Date(order.date || new Date()).toLocaleDateString();
        const formattedTotal = `‚Ç¨${(order.total || 0).toFixed(2)}`;
        
        // Check if order has tracking
        const hasTracking = order.trackingNumber && order.trackingNumber !== '';
        const trackingInfo = hasTracking 
            ? `<i class="fas fa-shipping-fast" title="Tracking: ${order.trackingNumber}"></i>`
            : '<i class="fas fa-clock" title="Awaiting shipment"></i>';

        ordersHtml += `
            <tr>
                <td>${order.orderNumber || order.id}</td>
                <td>${formattedDate}</td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${getStatusLabel(order.status || "pending")}
                    </span>
                </td>
                <td>${formattedTotal}</td>
                <td>${trackingInfo}</td>
                <td>
                    <button class="action-btn view-order-btn" data-order-id="${order.id || order.orderNumber}">
                        <i class="fas fa-eye"></i> Details
                    </button>
                </td>
            </tr>
        `;
    });

    ordersHtml += "</tbody></table>";
    container.innerHTML = ordersHtml;
    
    // Add event listeners
    container.querySelectorAll('.view-order-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const orderId = this.getAttribute('data-order-id');
            viewOrderDetails(orderId);
        });
    });
}

// Enhanced renderFullOrders function
function renderFullOrders(orders) {
    const container = document.getElementById("orders-full-container");

    if (!orders || orders.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <p>No order history</p>
                <button class="action-btn" onclick="window.location.href='shop.html'" style="margin-top: 15px;">
                    Start Shopping
                </button>
            </div>
        `;
        return;
    }

    let ordersHtml = `
        <table class="order-table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Tracking</th>
                    <th>Estimated Delivery</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

    orders.forEach((order) => {
        const statusClass = getStatusClass(order.status || "pending");
        const formattedDate = new Date(order.date || new Date()).toLocaleDateString();
        const formattedTotal = `‚Ç¨${(order.total || 0).toFixed(2)}`;
        const itemCount = order.items ? order.items.length : 0;
        
        // Check if order has tracking
        const hasTracking = order.trackingNumber && order.trackingNumber !== '';
        const trackingInfo = hasTracking 
            ? `<span title="Tracking: ${order.trackingNumber}">üì¶</span>`
            : '<span title="Awaiting shipment">‚è≥</span>';
        
        // Estimated delivery
        let estimatedDelivery = 'N/A';
        if (order.estimatedDelivery) {
            const deliveryDate = new Date(order.estimatedDelivery);
            const today = new Date();
            const diffDays = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays > 0) {
                estimatedDelivery = `${diffDays} days`;
            } else if (diffDays === 0) {
                estimatedDelivery = 'Today';
            } else {
                estimatedDelivery = 'Delivered';
            }
        }

        ordersHtml += `
            <tr>
                <td><strong>${order.orderNumber || order.id}</strong></td>
                <td>${formattedDate}</td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${getStatusLabel(order.status || "pending")}
                    </span>
                </td>
                <td>${itemCount} item${itemCount !== 1 ? 's' : ''}</td>
                <td>${formattedTotal}</td>
                <td>${trackingInfo}</td>
                <td>${estimatedDelivery}</td>
                <td>
                    <button class="action-btn view-order-btn" data-order-id="${order.id || order.orderNumber}">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="action-btn reorder-btn" data-order-id="${order.id || order.orderNumber}">
                        <i class="fas fa-redo"></i> Reorder
                    </button>
                </td>
            </tr>
        `;
    });

    ordersHtml += "</tbody></table>";
    container.innerHTML = ordersHtml;
    
    // Add event listeners
    container.querySelectorAll('.view-order-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const orderId = this.getAttribute('data-order-id');
            viewOrderDetails(orderId);
        });
    });
    
    container.querySelectorAll('.reorder-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const orderId = this.getAttribute('data-order-id');
            reorder(orderId);
        });
    });
}

// Helper functions for order status
function getStatusClass(status) {
    const statusMap = {
        'pending': 'status-pending',
        'processing': 'status-processing',
        'confirmed': 'status-confirmed',
        'shipped': 'status-shipped',
        'delivered': 'status-delivered',
        'cancelled': 'status-cancelled'
    };
    return statusMap[status.toLowerCase()] || 'status-pending';
}

function getStatusLabel(status) {
    const labelMap = {
        'pending': 'Pending',
        'processing': 'Processing',
        'confirmed': 'Confirmed',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
    };
    return labelMap[status.toLowerCase()] || 'Pending';
}

      function renderWishlistPreview(wishlist) {
        const container = document.getElementById("wishlist-preview-container");

        if (!wishlist || wishlist.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-heart"></i>
                <p>Your wishlist is empty</p>
                <button class="action-btn" onclick="window.location.href='shop.html'" style="margin-top: 15px;">
                    Browse Products
                </button>
            </div>
        `;
          return;
        }

        let wishlistHtml = "";
        wishlist.slice(0, 2).forEach((item) => {
          // Handle both direct items and nested productId objects
          const product = item.productId || item;
          const productId = product._id || product.id || item._id || item.id;
          const productName = product.name || item.name || "Unnamed Product";
          const productPrice = product.price || item.price || 0;
          const productImage =
            product.image ||
            item.image ||
            product.images?.[0]?.url ||
            item.images?.[0]?.url ||
            "images/placeholder-product.jpg";

          wishlistHtml += `
            <div class="wishlist-item">
                <div class="item-image">
                    <img src="${productImage}" 
                         alt="${productName}" 
                         onerror="this.src='https://via.placeholder.com/60x60/e8e8e8/666?text=No+Image'"
                         style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div class="item-details">
                    <h4>${productName}</h4>
                    <div class="item-price">‚Ç¨${productPrice.toFixed(2)}</div>
                </div>
                <div class="item-actions">
                    <button class="action-btn add-to-cart-from-wishlist-btn" data-product-id="${productId}">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                    <button class="action-btn remove-from-wishlist-btn" data-product-id="${productId}" style="background-color: #ff6b6b;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        });

        container.innerHTML = wishlistHtml;
        
        // Add event listeners
        container.querySelectorAll('.add-to-cart-from-wishlist-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            addToCartFromWishlist(productId);
          });
        });
        
        container.querySelectorAll('.remove-from-wishlist-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            removeFromWishlist(productId);
          });
        });
      }

      function renderFullWishlist(wishlist) {
        const container = document.getElementById("wishlist-full-container");

        if (!wishlist || wishlist.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-heart"></i>
                <p>Your wishlist is empty</p>
                <button class="action-btn" onclick="window.location.href='shop.html'" style="margin-top: 15px;">
                    Browse Products
                </button>
            </div>
        `;
          return;
        }

        let wishlistHtml = "";
        wishlist.forEach((item) => {
          // Handle both direct items and nested productId objects
          const product = item.productId || item;
          const productId = product._id || product.id || item._id || item.id;
          const productName = product.name || item.name || "Unnamed Product";
          const productPrice = product.price || item.price || 0;
          const productImage =
            product.image ||
            item.image ||
            product.images?.[0]?.url ||
            item.images?.[0]?.url ||
            "images/placeholder-product.jpg";

          wishlistHtml += `
            <div class="dashboard-card">
                <div class="wishlist-item">
                    <div class="item-image">
                        <img src="${productImage}" 
                             alt="${productName}" 
                             onerror="this.src='https://via.placeholder.com/60x60/e8e8e8/666?text=No+Image'"
                             style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div class="item-details">
                        <h4>${productName}</h4>
                        <div class="item-price">‚Ç¨${productPrice.toFixed(
                          2
                        )}</div>
                        <div class="product-detail">${
                          product.category || item.category || "Hair Product"
                        }</div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn add-to-cart-from-wishlist-btn" data-product-id="${productId}">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                        <button class="action-btn remove-from-wishlist-btn" data-product-id="${productId}" style="background-color: #ff6b6b;">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>
            </div>
        `;
        });

        container.innerHTML = wishlistHtml;
        
        // Add event listeners
        container.querySelectorAll('.add-to-cart-from-wishlist-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            addToCartFromWishlist(productId);
          });
        });
        
        container.querySelectorAll('.remove-from-wishlist-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            removeFromWishlist(productId);
          });
        });
      }

      function renderCartPreview(cartData) {
        const container = document.getElementById("cart-preview-container");

        if (!cartData || !cartData.items || cartData.items.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                    </div>
                `;
          return;
        }

        let cartHtml = "";
        let subtotal = 0;

        cartData.items.slice(0, 2).forEach((item) => {
          const itemTotal = (item.price || 0) * (item.quantity || 1);
          subtotal += itemTotal;
          
          const productImage =
            item.image ||
            item.images?.[0]?.url ||
            "images/placeholder-product.jpg";
          const productId = item.productId || item._id || item.id;

          cartHtml += `
                    <div class="cart-item">
                        <div class="item-image">
                            <img src="${productImage}" 
                                 alt="${item.name}" 
                                 onerror="this.src='https://via.placeholder.com/60x60/e8e8e8/666?text=No+Image'"
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="item-details">
                            <h4>${item.name}</h4>
                            <div class="item-price">‚Ç¨${(
                              item.price || 0
                            ).toFixed(2)}</div>
                            <div>Qty: ${item.quantity || 1}</div>
                        </div>
                    </div>
                `;
        });

        // Add checkout button
        cartHtml += `
                <button class="action-btn" onclick="switchSection('cart')" style="width: 100%; margin-top: 10px; padding: 10px;">
                    Checkout (‚Ç¨${subtotal.toFixed(2)})
                </button>
            `;

        container.innerHTML = cartHtml;
      }

      // UPDATED BOOKINGS FUNCTIONS
function renderUpcomingBookings(bookings) {
    const container = document.getElementById("upcoming-bookings-container");

    if (!bookings || bookings.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <p>No upcoming appointments</p>
                <button class="action-btn" onclick="window.location.href='book.html'" style="margin-top: 15px;">
                    Book Wig Service
                </button>
            </div>
        `;
        return;
    }

    let bookingsHtml = "";
    const now = new Date();
    
    // Filter upcoming bookings (status not cancelled or completed, date is in future)
    const upcomingBookings = bookings.filter((booking) => {
        const bookingDate = booking.estimatedCompletion ? 
            new Date(booking.estimatedCompletion) : 
            new Date(booking.createdAt);
        const isUpcoming = bookingDate > now;
        const isActive = booking.status !== 'completed' && 
                        booking.status !== 'cancelled' && 
                        booking.status !== 'rejected';
        return isUpcoming && isActive;
    }).slice(0, 3); // Show only 3 upcoming bookings

    if (upcomingBookings.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <p>No upcoming appointments</p>
                <button class="action-btn" onclick="window.location.href='book.html'" style="margin-top: 15px;">
                    Book Wig Service
                </button>
            </div>
        `;
        return;
    }

    upcomingBookings.forEach((booking) => {
        const bookingDate = booking.estimatedCompletion ? 
            new Date(booking.estimatedCompletion) : 
            new Date(booking.createdAt);
        const formattedDate = bookingDate.toLocaleDateString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        const statusClass = `status-${booking.status.replace('_', '-')}`;
        
        bookingsHtml += `
            <div class="booking-card">
                <div class="booking-date">
                    <i class="fas fa-calendar-alt"></i> ${formattedDate}
                </div>
                <div class="booking-service">
                    <strong>${booking.service || 'Wig Renovation'}</strong>
                </div>
                <div style="margin: 8px 0;">
                    <span style="color: var(--cream);">
                        <i class="fas fa-wig"></i> ${booking.wigCount || 1} Wig${booking.wigCount > 1 ? 's' : ''}
                    </span>
                    <span style="float: right; font-weight: bold;">
                        ‚Ç¨${booking.totalPrice || (booking.wigCount * 15 || 15)}
                    </span>
                </div>
                <div>
                    <span class="status-badge ${statusClass}">
                        ${booking.status || 'Pending'}
                    </span>
                    ${booking.status === 'pending' ? `
                        <button class="action-btn" 
                                onclick="contactAboutBooking('${booking._id || booking.id}')" 
                                style="float: right; padding: 4px 10px; font-size: 12px;">
                            Contact
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    });

    container.innerHTML = bookingsHtml;
}

      function renderFullBookings(bookings) {
        const container = document.getElementById("bookings-full-container");

        if (!bookings || bookings.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <p>No appointments scheduled</p>
                        <button class="action-btn" onclick="window.location.href='book.html'" style="margin-top: 15px;">
                            Book Wig Service
                        </button>
                    </div>
                `;
          return;
        }

        let bookingsHtml = '';
        const now = new Date();
        
        bookings.forEach((booking) => {
          const bookingDate = booking.estimatedCompletion ? new Date(booking.estimatedCompletion) : new Date(booking.createdAt);
          const isUpcoming = bookingDate > now && booking.status !== 'completed' && booking.status !== 'cancelled';
          const statusClass = `status-${booking.status.replace('_', '-')}`;
          const formattedDate = bookingDate.toLocaleDateString();
          
          bookingsHtml += `
                <div class="booking-card">
                    <div class="booking-date">${formattedDate}</div>
                    <div class="booking-service">${booking.service || 'Wig Renovation'}</div>
                    <div>Wigs: ${booking.wigCount} ‚Ä¢ Total: ‚Ç¨${booking.totalPrice || (booking.wigCount * 15)}</div>
                    <div>Status: <span class="status-badge ${statusClass}">${booking.status}</span></div>
                    ${booking.notes ? `<div>Notes: ${booking.notes}</div>` : ''}
                    ${isUpcoming ? `
                        <div class="item-actions" style="margin-top: 10px;">
                            <button class="action-btn" onclick="contactAboutBooking('${booking._id || booking.id}')">Contact Support</button>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        container.innerHTML = bookingsHtml;
      }

function renderNotificationsPreview(notifications) {
    const container = document.getElementById("notifications-preview-container");

    if (!notifications || notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications</p>
            </div>
        `;
        return;
    }

    let notificationsHtml = "";
    
    // Filter to only show recent notifications (not just slice)
    const recentNotifications = notifications
        .filter(n => {
            const notificationDate = new Date(n.createdAt || new Date());
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            return notificationDate > sevenDaysAgo;
        })
        .slice(0, 3); // Show only 3 most recent
    
    if (recentNotifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>No recent notifications</p>
            </div>
        `;
        return;
    }

    recentNotifications.forEach((notification) => {
        const unreadClass = notification.read ? "" : "notification-unread";
        const icon = notification.icon || getNotificationIcon(notification.type);
        const timeAgo = getTimeAgo(notification.createdAt);

        notificationsHtml += `
            <div class="notification-item ${unreadClass}">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <i class="fas ${icon}" style="color: var(--cream);"></i>
                    <h4>${notification.title}</h4>
                </div>
                <p>${notification.message}</p>
                <div class="notification-time">${timeAgo}</div>
            </div>
        `;
    });

    container.innerHTML = notificationsHtml;
}

      // Mock data fallback
      function useMockData() {
        console.log("üìã Using mock data as fallback");

        // Mock stats
        const statsContainer = document.getElementById("stats-container");
        statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Active Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Wishlist Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Upcoming Appointments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-gem"></i>
                    </div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Loyalty Points</div>
                </div>
            `;

        // Mock empty states
        const containers = [
          "recent-orders-container",
          "wishlist-preview-container",
          "cart-preview-container",
          "upcoming-bookings-container",
          "notifications-preview-container",
        ];

        containers.forEach((containerId) => {
          const container = document.getElementById(containerId);
          if (container) {
            const type = containerId.includes("wishlist")
              ? "heart"
              : containerId.includes("cart")
              ? "shopping-cart"
              : containerId.includes("orders")
              ? "box-open"
              : containerId.includes("bookings")
              ? "calendar-times"
              : "bell-slash";

            const message = containerId.includes("wishlist")
              ? "Your wishlist is empty"
              : containerId.includes("cart")
              ? "Your cart is empty"
              : containerId.includes("orders")
              ? "No recent orders"
              : containerId.includes("bookings")
              ? "No upcoming appointments"
              : "No notifications";

            container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-${type}"></i>
                            <p>${message}</p>
                        </div>
                    `;
          }
        });
      }

      // Section switching
      function switchSection(sectionId) {
        contentSections.forEach((section) => {
          section.classList.remove("active");
        });

        const activeSection = document.getElementById(sectionId);
        activeSection.classList.add("active");

        sidebarBubbles.forEach((bubble) => {
          bubble.classList.remove("active");
          if (bubble.getAttribute("data-section") === sectionId) {
            bubble.classList.add("active");
          }
        });

        mobileNavBubbles.forEach((bubble) => {
          bubble.classList.remove("active");
          if (bubble.getAttribute("data-section") === sectionId) {
            bubble.classList.add("active");
          }
        });

        // Load section-specific data
        loadSectionData(sectionId);

        window.scrollTo(0, 0);
      }

      async function loadSectionData(sectionId) {
        try {
          switch (sectionId) {
            case "cart":
              await loadFullCart();
              break;
            case "wishlist":
              await loadFullWishlist();
              break;
            case "orders":
              await loadFullOrders();
              break;
            case "bookings":
              await loadFullBookings();
              break;
            case "notifications":
              await loadFullNotifications();
              break;
          }
        } catch (error) {
          console.error(`Failed to load ${sectionId} data:`, error);
        }
      }

      async function loadFullCart() {
        const container = document.getElementById("cart-full-container");
        container.innerHTML =
          '<div class="loading"><div class="loading-spinner"></div><span>Loading cart...</span></div>';

        try {
          const cartData = await fetchCart();
          renderFullCart(cartData);
        } catch (error) {
          console.error("‚ùå Error loading cart:", error);
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                        <button class="action-btn" onclick="window.location.href='shop.html'" style="margin-top: 15px;">
                            Start Shopping
                        </button>
                    </div>
                `;
        }
      }

      function renderFullCart(cartData) {
        const container = document.getElementById("cart-full-container");

        if (!cartData || !cartData.items || cartData.items.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                        <button class="action-btn" onclick="window.location.href='shop.html'" style="margin-top: 15px;">
                            Start Shopping
                        </button>
                    </div>
                `;
          return;
        }

        let cartHtml = "";
        let subtotal = 0;

        cartData.items.forEach((item) => {
          const itemTotal = (item.price || 0) * (item.quantity || 1);
          subtotal += itemTotal;

          const productImage =
            item.image ||
            item.images?.[0]?.url ||
            "images/placeholder-product.jpg";
          const productId = item.productId || item._id || item.id;

          cartHtml += `
                    <div class="cart-item">
                        <div class="item-image">
                            <img src="${productImage}" 
                                 alt="${item.name}" 
                                 onerror="this.src='https://via.placeholder.com/60x60/e8e8e8/666?text=No+Image'"
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="item-details">
                            <h4>${item.name}</h4>
                            <div class="item-price">‚Ç¨${(
                              item.price || 0
                            ).toFixed(2)}</div>
                            <div class="quantity-control">
                                <button class="quantity-btn minus" data-product-id="${productId}">-</button>
                                <span class="quantity-display">${item.quantity || 1}</span>
                                <button class="quantity-btn plus" data-product-id="${productId}">+</button>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn remove-from-cart-btn" data-product-id="${productId}" style="background-color: #ff6b6b;">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
        });

        const shipping = 5.0;
        const total = subtotal + shipping;

        cartHtml += `
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-bg);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <h4>Subtotal</h4>
                        <h4>‚Ç¨${subtotal.toFixed(2)}</h4>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <h4>Shipping</h4>
                        <h4>‚Ç¨${shipping.toFixed(2)}</h4>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 1.1rem;">
                        <h3>Total</h3>
                        <h3>‚Ç¨${total.toFixed(2)}</h3>
                    </div>
                    <button class="action-btn checkout-btn" style="width: 100%; padding: 12px; font-size: 1rem;">
                        Proceed to Checkout
                    </button>
                </div>
            `;

        container.innerHTML = cartHtml;
        
        // Add event listeners after rendering
        container.querySelectorAll('.quantity-btn.minus').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            updateCartQuantity(productId, -1);
          });
        });
        
        container.querySelectorAll('.quantity-btn.plus').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            updateCartQuantity(productId, 1);
          });
        });
        
        container.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            removeFromCart(productId);
          });
        });
        
        container.querySelector('.checkout-btn').addEventListener('click', function(e) {
          e.stopPropagation();
          checkout();
        });
      }

      async function loadFullWishlist() {
        const container = document.getElementById("wishlist-full-container");
        container.innerHTML =
          '<div class="loading"><div class="loading-spinner"></div><span>Loading wishlist...</span></div>';

        try {
          const wishlist = await fetchWishlist();
          renderFullWishlist(wishlist);
        } catch (error) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-heart"></i>
                        <p>Your wishlist is empty</p>
                        <button class="action-btn" onclick="window.location.href='shop.html'" style="margin-top: 15px;">
                            Browse Products
                        </button>
                    </div>
                `;
        }
      }

      async function loadFullOrders() {
        const container = document.getElementById("orders-full-container");
        container.innerHTML =
          '<div class="loading"><div class="loading-spinner"></div><span>Loading order history...</span></div>';

        try {
          const orders = await fetchOrders();
          renderFullOrders(orders);
        } catch (error) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>No order history</p>
                        <button class="action-btn" onclick="window.location.href='shop.html'" style="margin-top: 15px;">
                            Start Shopping
                        </button>
                    </div>
                `;
        }
      }

      function renderFullOrders(orders) {
        const container = document.getElementById("orders-full-container");

        if (!orders || orders.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>No order history</p>
                        <button class="action-btn" onclick="window.location.href='shop.html'" style="margin-top: 15px;">
                            Start Shopping
                        </button>
                    </div>
                `;
          return;
        }

        let ordersHtml = `
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        orders.forEach((order) => {
          const statusClass = `status-${
            order.status?.toLowerCase() || "pending"
          }`;
          const formattedDate = new Date(
            order.date || new Date()
          ).toLocaleDateString();
          const formattedTotal = `‚Ç¨${order.total?.toFixed(2) || "0.00"}`;

          ordersHtml += `
                    <tr>
                        <td>${order.id || "N/A"}</td>
                        <td>${formattedDate}</td>
                        <td><span class="status-badge ${statusClass}">${
            order.status || "Processing"
          }</span></td>
                        <td>${formattedTotal}</td>
                        <td>
                            <button class="action-btn view-order-btn" data-order-id="${order.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-btn reorder-btn" data-order-id="${order.id}">
                                <i class="fas fa-redo"></i> Reorder
                            </button>
                        </td>
                    </tr>
                `;
        });

        ordersHtml += "</tbody></table>";
        container.innerHTML = ordersHtml;
        
        // Add event listeners
        container.querySelectorAll('.view-order-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const orderId = this.getAttribute('data-order-id');
            viewOrder(orderId);
          });
        });
        
        container.querySelectorAll('.reorder-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const orderId = this.getAttribute('data-order-id');
            reorder(orderId);
          });
        });
      }

      async function loadFullBookings() {
        const container = document.getElementById("bookings-full-container");
        container.innerHTML =
          '<div class="loading"><div class="loading-spinner"></div><span>Loading appointments...</span></div>';

        try {
          const bookings = await fetchBookings();
          renderFullBookings(bookings);
        } catch (error) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <p>No appointments scheduled</p>
                        <button class="action-btn" onclick="window.location.href='book.html'" style="margin-top: 15px;">
                            Book Wig Service
                        </button>
                    </div>
                `;
        }
      }

// Enhanced notification functions in customerdashboard.html
async function loadFullNotifications() {
    const container = document.getElementById("notifications-full-container");
    container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><span>Loading notifications...</span></div>';

    try {
        // Get notifications from localStorage first
        let notifications = JSON.parse(localStorage.getItem('olysHairNotifications')) || [];
        
        // Also get system notifications (from orders and bookings)
        const systemNotifications = await generateSystemNotifications();
        
        // Merge and sort all notifications
        const allNotifications = [...notifications, ...systemNotifications]
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        renderFullNotifications(allNotifications);
    } catch (error) {
        console.error('Error loading notifications:', error);
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications</p>
            </div>
        `;
    }
}

function renderFullNotifications(notifications) {
    const container = document.getElementById("notifications-full-container");

    if (!notifications || notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications</p>
            </div>
        `;
        return;
    }

    let notificationsHtml = '';
    notifications.forEach((notification) => {
        const unreadClass = notification.read ? '' : 'notification-unread';
        const icon = getNotificationIcon(notification.type);
        const timeAgo = getTimeAgo(notification.createdAt);

        notificationsHtml += `
            <div class="notification-item ${unreadClass}" data-notification-id="${notification._id}">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <i class="fas ${icon}" style="color: var(--cream);"></i>
                    <h4 style="margin: 0; flex: 1;">${notification.title}</h4>
                    ${notification.priority === 'high' ? '<span style="color: #ff6b6b; font-size: 12px;">‚ö†Ô∏è Important</span>' : ''}
                </div>
                <p style="margin: 5px 0 10px 0;">${notification.message}</p>
                ${notification.metadata?.actionUrl ? `
                    <a href="${notification.metadata.actionUrl}" 
                       class="action-btn" 
                       style="padding: 5px 10px; font-size: 0.8rem; width: auto;">
                        ${notification.metadata.actionText || 'View Details'}
                    </a>
                ` : ''}
                <div class="notification-time">${timeAgo}</div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="mark-read-btn" data-notification-id="${notification._id}" 
                            style="background: none; border: none; color: var(--cream); cursor: pointer; font-size: 12px;">
                        <i class="fas fa-check"></i> Mark as read
                    </button>
                    <button class="delete-notification-btn" data-notification-id="${notification._id}" 
                            style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        `;
    });

    container.innerHTML = notificationsHtml;
    
    // Add event listeners
    container.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const notificationId = this.getAttribute('data-notification-id');
            markNotificationAsRead(notificationId);
        });
    });
    
    container.querySelectorAll('.delete-notification-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const notificationId = this.getAttribute('data-notification-id');
            deleteNotification(notificationId);
        });
    });
}

// Helper functions
function getNotificationIcon(type) {
    const icons = {
        'order': 'fa-shopping-bag',
        'booking': 'fa-calendar-alt',
        'system': 'fa-info-circle',
        'promotion': 'fa-tag',
        'security': 'fa-shield-alt'
    };
    return icons[type] || 'fa-bell';
}

function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 60) {
        return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    } else if (diffHours < 24) {
        return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    } else if (diffDays < 7) {
        return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    } else {
        return date.toLocaleDateString();
    }
}

async function markNotificationAsRead(notificationId) {
    try {
        const response = await fetch(`${API_BASE_URL}/notifications/${notificationId}/read`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Failed to mark as read');
        
        // Update UI
        const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (notificationElement) {
            notificationElement.classList.remove('notification-unread');
            notificationElement.querySelector('.mark-read-btn').remove();
        }
        
        showNotification('Notification marked as read');
    } catch (error) {
        console.error('Error marking notification as read:', error);
        showNotification('Failed to mark as read', 'error');
    }
}

async function deleteNotification(notificationId) {
    if (!confirm('Are you sure you want to delete this notification?')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/notifications/${notificationId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Failed to delete notification');
        
        // Remove from UI
        const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (notificationElement) {
            notificationElement.remove();
        }
        
        showNotification('Notification deleted');
    } catch (error) {
        console.error('Error deleting notification:', error);
        showNotification('Failed to delete notification', 'error');
    }
}

      function renderFullNotifications(notifications) {
        const container = document.getElementById(
          "notifications-full-container"
        );

        if (!notifications || notifications.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications</p>
                    </div>
                `;
          return;
        }

        let notificationsHtml = "";
        notifications.forEach((notification) => {
          const unreadClass = notification.unread ? "notification-unread" : "";

          notificationsHtml += `
                    <div class="notification-item ${unreadClass}">
                        <h4>${notification.title}</h4>
                        <p>${notification.message}</p>
                        <div class="notification-time">${notification.time}</div>
                    </div>
                `;
        });

        container.innerHTML = notificationsHtml;
      }

      // FIXED CART FUNCTIONS - Using same approach as shop
      async function addToCartFromWishlist(productId) {
        console.log("üõí Adding to cart from wishlist:", productId);
        
        try {
          // Get product details (you might need to fetch product details separately)
          // For now, we'll add with minimal data
          const response = await fetch(`${API_BASE_URL}/cart/add`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${authToken}`
            },
            body: JSON.stringify({
              productId: productId,
              quantity: 1
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to add to cart");
          }
          
          const data = await response.json();
          console.log("‚úÖ Added to cart:", data);
          
          showNotification("Added to cart!");
          
          // Refresh cart data
          await loadCartFromBackend();
          
          // Refresh UI
          const cartData = await fetchCart();
          renderCartPreview(cartData);
          
          if (document.getElementById("cart").classList.contains("active")) {
            await loadFullCart();
          }
          
        } catch (error) {
          console.error("‚ùå Error adding to cart:", error);
          showNotification("Failed to add to cart", "error");
        }
      }

      async function removeFromWishlist(productId) {
        console.log("üóëÔ∏è Removing from wishlist:", productId);
        
        if (!confirm("Are you sure you want to remove this item from your wishlist?")) {
          return;
        }
        
        try {
          const response = await fetch(`${API_BASE_URL}/wishlist/${productId}`, {
            method: "DELETE",
            headers: {
              "Authorization": `Bearer ${authToken}`
            }
          });
          
          if (!response.ok) {
            throw new Error("Failed to remove from wishlist");
          }
          
          showNotification("Removed from wishlist");
          
          // Refresh wishlist
          if (document.getElementById("wishlist").classList.contains("active")) {
            await loadFullWishlist();
          } else {
            const wishlist = await fetchWishlist(2);
            renderWishlistPreview(wishlist);
          }
          
          // Update stats
          await loadDashboardData();
          
        } catch (error) {
          console.error("‚ùå Error removing from wishlist:", error);
          showNotification("Failed to remove from wishlist", "error");
        }
      }

      // FIXED: Using same approach as shop
      async function updateCartQuantity(productId, change) {
        console.log("üìù Updating cart quantity:", productId, change);
        
        // Find item in cart
        const item = cart.find((item) => item.productId === productId);
        if (!item) {
          showNotification("Item not found in cart", "error");
          return;
        }

        const newQuantity = item.quantity + change;

        if (newQuantity <= 0) {
          // Remove item if quantity becomes 0 or negative
          await removeFromCart(productId);
          return;
        }

        try {
          console.log("üìù Updating cart quantity via API:", productId, newQuantity);

          const response = await fetch(
            `${API_BASE_URL}/cart/update/${productId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify({
                quantity: newQuantity,
              }),
            }
          );

          if (!response.ok) {
            throw new Error("Failed to update cart");
          }

          const data = await response.json();
          console.log("‚úÖ Cart quantity updated:", data);

          // Update local cart
          item.quantity = newQuantity;
          localStorage.setItem("olysHairCart", JSON.stringify(cart));
          
          // Refresh cart display
          await loadFullCart();
          
          // Also update cart preview if needed
          const cartData = await fetchCart();
          renderCartPreview(cartData);
          
        } catch (error) {
          console.error("‚ùå Error updating cart:", error);
          showNotification("Failed to update cart", "error");
        }
      }

      // FIXED: Using same approach as shop
      async function removeFromCart(productId) {
        console.log("üóëÔ∏è Removing from cart:", productId);
        
        if (!confirm("Are you sure you want to remove this item from your cart?")) {
          return;
        }

        try {
          console.log("üóëÔ∏è Removing from cart via API:", productId);

          const response = await fetch(
            `${API_BASE_URL}/cart/remove/${productId}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to remove from cart");
          }

          console.log("‚úÖ Item removed from cart");
          
          // Update local cart - remove by productId
          cart = cart.filter((item) => item.productId !== productId);
          localStorage.setItem("olysHairCart", JSON.stringify(cart));
          
          showNotification("Item removed from cart");
          
          // Refresh cart display
          await loadFullCart();
          
          // Also update cart preview if needed
          const cartData = await fetchCart();
          renderCartPreview(cartData);
          
          // Update stats
          await loadDashboardData();
          
        } catch (error) {
          console.error("‚ùå Error removing from cart:", error);
          showNotification("Failed to remove from cart", "error");
        }
      }

      // FIXED: Load cart from backend - Same as shop
      async function loadCartFromBackend() {
        const token = localStorage.getItem("token");

        if (!token) {
          console.log("‚ö†Ô∏è No token found, using localStorage cart only");
          return;
        }

        try {
          console.log("üîÑ Loading cart from backend...");

          const response = await fetch(`${API_BASE_URL}/cart`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Failed to load cart from backend");
          }

          const data = await response.json();
          console.log("‚úÖ Cart loaded from backend:", data);

          if (data.cart && data.cart.items) {
            cart = data.cart.items.map((item) => ({
              productId: item.productId?._id || item.productId, // Ensure productId is stored
              name: item.name || item.productId?.name || "Unknown Product",
              price: item.price || item.productId?.price || 0,
              image: item.image || item.productId?.images?.[0]?.url || "images/placeholder-product.jpg",
              quantity: item.quantity,
              maxStock: item.productId?.stock || 999,
            }));

            // Save to localStorage as backup
            localStorage.setItem("olysHairCart", JSON.stringify(cart));
          }
        } catch (error) {
          console.error("‚ùå Error loading cart from backend:", error);
          console.log("‚ö†Ô∏è Using localStorage cart as fallback");
        }
      }

      async function viewOrder(orderId) {
        console.log("üìã Viewing order:", orderId);
        // You can implement order details view here
        alert("Order details for: " + orderId + "\n\nThis feature will show order details in a future update.");
      }

      async function reorder(orderId) {
        console.log("üîÑ Reordering:", orderId);
        showNotification("Re-order feature coming soon!");
        // You can implement reorder logic here
      }

      function contactAboutBooking(bookingId) {
        alert('Please contact support for any questions about your booking. Booking ID: ' + bookingId);
      }

      async function checkout() {
        console.log("üí∞ Proceeding to checkout");
        
        // Get current cart
        const cartData = await fetchCart();
        
        if (!cartData.items || cartData.items.length === 0) {
          showNotification("Your cart is empty", "error");
          return;
        }
        
        // Save cart to localStorage for checkout page
        localStorage.setItem("olysHairCart", JSON.stringify(cart));
        
        // Redirect to checkout page
        window.location.href = "checkout.html";
      }

      function redirectToLogin() {
        localStorage.removeItem("token");
        window.location.href = "sign-in.html";
      }

      function showError(message) {
        console.error("‚ùå Error:", message);
        alert("Error: " + message);
      }

      function showNotification(message, type = "success") {
        // Remove existing notifications
        document.querySelectorAll(".notification-toast").forEach((notification) => {
          notification.remove();
        });

        const notification = document.createElement("div");
        notification.className = "notification-toast";
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 9999;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          animation: slideIn 0.3s ease;
          background-color: ${type === "success" ? "#4CAF50" : "#F44336"};
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease";
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
        
        // Add CSS for animations if not already added
        if (!document.querySelector('#notification-styles')) {
          const style = document.createElement('style');
          style.id = 'notification-styles';
          style.textContent = `
            @keyframes slideIn {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
              from { transform: translateX(0); opacity: 1; }
              to { transform: translateX(100%); opacity: 0; }
            }
          `;
          document.head.appendChild(style);
        }
      }

      // Event Listeners
      modeToggle.addEventListener("click", () => {
        body.classList.toggle("dark-mode");
        localStorage.setItem(
          "theme",
          body.classList.contains("dark-mode") ? "dark" : "light"
        );
      });

      if (localStorage.getItem("theme") === "dark") {
        body.classList.add("dark-mode");
      }

      userProfile.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (!userProfile.contains(e.target)) {
          dropdownMenu.classList.remove("show");
        }
      });

      sidebarBubbles.forEach((bubble) => {
        bubble.addEventListener("click", () => {
          switchSection(bubble.getAttribute("data-section"));
        });
      });

      mobileNavBubbles.forEach((bubble) => {
        bubble.addEventListener("click", () => {
          const sectionId = bubble.getAttribute("data-section");
          if (sectionId) {
            switchSection(sectionId);
          }
        });
      });

      quickShortcuts.forEach((shortcut) => {
        shortcut.addEventListener("click", () => {
          const sectionId = shortcut.getAttribute("data-section");
          if (sectionId) {
            switchSection(sectionId);
          }
        });
      });

      viewAllLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const sectionId = link.getAttribute("data-section");
          switchSection(sectionId);
        });
      });

      document.querySelectorAll(".dropdown-menu a").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const sectionId = item.getAttribute("data-section");
          if (sectionId) {
            switchSection(sectionId);
          }
          dropdownMenu.classList.remove("show");
        });
      });

      logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.removeItem("token");
        redirectToLogin();
      });

      // Settings form handlers
      document
        .getElementById("save-profile")
        .addEventListener("click", async function () {
          const name = document.getElementById("name").value;
          const email = document.getElementById("email").value;
          const phone = document.getElementById("phone").value;
          const address = document.getElementById("address").value;

          try {
            // API call to update profile
            console.log("Update profile:", { name, email, phone, address });
            showNotification("Profile updated successfully!");
          } catch (error) {
            console.error("Error updating profile:", error);
            showNotification("Error updating profile", "error");
          }
        });

      document
        .getElementById("update-password")
        .addEventListener("click", async function () {
          const currentPassword =
            document.getElementById("current-password").value;
          const newPassword = document.getElementById("new-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          if (newPassword !== confirmPassword) {
            showNotification("New passwords do not match", "error");
            return;
          }

          try {
            console.log("Update password");
            showNotification("Password updated successfully!");

            document.getElementById("current-password").value = "";
            document.getElementById("new-password").value = "";
            document.getElementById("confirm-password").value = "";
          } catch (error) {
            console.error("Error updating password:", error);
            showNotification("Error updating password", "error");
          }
        });

      document
        .getElementById("save-preferences")
        .addEventListener("click", async function () {
          const emailNotifications = document.getElementById(
            "email-notifications"
          ).checked;
          const smsNotifications =
            document.getElementById("sms-notifications").checked;
          const promotionalEmails =
            document.getElementById("promotional-emails").checked;

          try {
            console.log("Update preferences:", {
              emailNotifications,
              smsNotifications,
              promotionalEmails,
            });
            showNotification("Preferences updated successfully!");
          } catch (error) {
            console.error("Error updating preferences:", error);
            showNotification("Error updating preferences", "error");
          }
        });

      document
        .getElementById("mark-all-read")
        .addEventListener("click", async function () {
          try {
            console.log("Mark all notifications as read");
            showNotification("All notifications marked as read!");
          } catch (error) {
            console.error("Error marking notifications as read:", error);
            showNotification("Error marking notifications as read", "error");
          }
        });

        // Enhanced order details view
// Enhanced viewOrderDetails with status history
async function viewOrderDetails(orderId) {
    try {
        const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
        let order = orders.find(o => 
            o.orderNumber === orderId || 
            o.id === orderId || 
            o._id === orderId
        );
        
        if (!order) {
            showNotification('Order not found', 'error');
            return;
        }
        
        // Create modal with status history
        const modalHTML = `
            <div class="modal-overlay">
                <div class="modal-content">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3>Order #${order.orderNumber || order.id}</h3>
                        <button onclick="closeModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--cream);">√ó</button>
                    </div>
                    
                    <!-- Current Status -->
                    <div style="background:${getStatusColor(order.status)};color:white;padding:15px;border-radius:8px;margin-bottom:20px;">
                        <h4 style="margin:0;color:white;">Current Status: ${getStatusLabel(order.status)}</h4>
                        ${order.status === 'cancelled' && order.cancellationReason ? `
                            <p style="margin:10px 0 0 0;font-size:14px;">
                                <strong>Cancellation Reason:</strong> ${order.cancellationReason}
                            </p>
                        ` : ''}
                    </div>
                    
                    <!-- Status Timeline -->
                    <div style="margin-bottom:30px;">
                        <h4>Order Journey</h4>
                        ${renderOrderTimeline(order)}
                    </div>
                    
                    <!-- Status History (if available) -->
                    ${order.statusHistory && order.statusHistory.length > 0 ? `
                    <div style="margin-bottom:20px;">
                        <h4>Status History</h4>
                        <div style="background:var(--light-bg);padding:15px;border-radius:8px;">
                            ${order.statusHistory.map((history, index) => `
                                <div style="padding:10px 0;border-bottom:${index < order.statusHistory.length - 1 ? '1px solid rgba(0,0,0,0.1)' : 'none'};">
                                    <div style="display:flex;justify-content:space-between;">
                                        <strong>${getStatusLabel(history.status)}</strong>
                                        <span style="font-size:12px;color:#666;">
                                            ${new Date(history.changedAt).toLocaleString()}
                                        </span>
                                    </div>
                                    <div style="font-size:13px;color:#666;margin-top:5px;">
                                        <i>${history.message || 'Status updated'}</i>
                                    </div>
                                    ${history.notes ? `
                                    <div style="font-size:12px;color:#888;margin-top:5px;">
                                        Admin Notes: ${history.notes}
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Order Details (existing code) -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                        <!-- ... rest of order details ... -->
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="margin-top:30px;display:flex;gap:10px;">
                        <button class="action-btn" onclick="refreshOrderStatus('${orderId}')">
                            <i class="fas fa-sync-alt"></i> Refresh Status
                        </button>
                        ${order.status !== 'cancelled' ? `
                        <button class="action-btn btn-warning" onclick="requestCancellation('${orderId}')">
                            <i class="fas fa-times"></i> Request Cancellation
                        </button>
                        ` : ''}
                        <button class="action-btn" onclick="closeModal()">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
    } catch (error) {
        console.error('Error viewing order details:', error);
        showNotification('Failed to load order details', 'error');
    }
}

// Helper function to get status color
function getStatusColor(status) {
    const colors = {
        'pending': '#FF9800',
        'confirmed': '#2196F3',
        'processing': '#9C27B0',
        'shipped': '#4CAF50',
        'delivered': '#009688',
        'cancelled': '#F44336'
    };
    return colors[status] || '#666';
}

// Helper function to render order timeline
function renderOrderTimeline(status) {
    const steps = [
        { id: 'pending', label: 'Order Placed', icon: 'fa-shopping-cart' },
        { id: 'processing', label: 'Processing', icon: 'fa-cog' },
        { id: 'confirmed', label: 'Confirmed', icon: 'fa-check' },
        { id: 'shipped', label: 'Shipped', icon: 'fa-shipping-fast' },
        { id: 'delivered', label: 'Delivered', icon: 'fa-home' }
    ];
    
    let currentStepIndex = steps.findIndex(step => step.id === status);
    if (currentStepIndex === -1) currentStepIndex = 0;
    
    return steps.map((step, index) => {
        const isCompleted = index <= currentStepIndex;
        const isCurrent = index === currentStepIndex;
        
        return `
            <div style="display:flex;flex-direction:column;align-items:center;flex:1;position:relative;">
                <div style="width:40px;height:40px;border-radius:50%;background:${isCompleted ? 'var(--cream)' : 'var(--light-bg)'};display:flex;align-items:center;justify-content:center;margin-bottom:8px;z-index:2;">
                    <i class="fas ${step.icon}" style="color:${isCompleted ? 'white' : 'var(--text-dark)'};"></i>
                </div>
                <span style="font-size:12px;text-align:center;">${step.label}</span>
                ${index < steps.length - 1 ? `
                    <div style="position:absolute;top:20px;left:70%;width:100%;height:2px;background:${isCompleted ? 'var(--cream)' : 'var(--light-bg)'};z-index:1;"></div>
                ` : ''}
                ${isCurrent ? '<div style="position:absolute;top:-10px;font-size:24px;color:var(--cream);">‚Üì</div>' : ''}
            </div>
        `;
    }).join('');
}

function getOrderStatusMessage(order) {
    const messages = {
        'pending': 'Your order has been received and is being processed.',
        'processing': 'We are preparing your order for shipment.',
        'confirmed': 'Your order has been confirmed and will be shipped soon.',
        'shipped': `Your order has been shipped. ${order.trackingNumber ? `Tracking: ${order.trackingNumber}` : ''}`,
        'delivered': 'Your order has been delivered.',
        'cancelled': 'This order has been cancelled.'
    };
    return messages[order.status] || 'Your order status is being updated.';
}

function getShippingMethodLabel(method) {
    const labels = {
        'standard': 'Standard Shipping (5-7 days)',
        'express': 'Express Shipping (2-3 days)',
        'overnight': 'Overnight Shipping (1 day)'
    };
    return labels[method] || 'Standard Shipping';
}

// Helper functions for order actions
function trackOrder(trackingNumber) {
    // You can implement tracking with specific carrier APIs
    showNotification(`Tracking number: ${trackingNumber}. You can track your order on the carrier's website.`, 'info');
}

function printOrder(orderId) {
    window.print();
}

async function cancelOrder(orderId) {
    if (!confirm('Are you sure you want to cancel this order?')) {
        return;
    }
    
    try {
        // Update order status in localStorage
        const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
        const orderIndex = orders.findIndex(o => 
            o.orderNumber === orderId || 
            o.id === orderId || 
            o._id === orderId
        );
        
        if (orderIndex !== -1) {
            orders[orderIndex].status = 'cancelled';
            orders[orderIndex].updatedAt = new Date().toISOString();
            localStorage.setItem('olysHairOrders', JSON.stringify(orders));
            
            showNotification('Order cancelled successfully', 'success');
            
            // Refresh orders display
            if (document.getElementById("orders").classList.contains("active")) {
                await loadFullOrders();
            } else {
                const orders = await fetchOrders(3);
                renderRecentOrders(orders);
            }
            
            // Close modal
            closeModal();
        }
    } catch (error) {
        console.error('Error cancelling order:', error);
        showNotification('Failed to cancel order', 'error');
    }
}

function contactSupport(orderId) {
    const subject = encodeURIComponent(`Support Request for Order ${orderId}`);
    const body = encodeURIComponent(`Hello OLYS HAIR support team,\n\nI need assistance with my order ${orderId}.\n\nPlease help me with:\n- [State your issue here]\n\nThank you.`);
    window.location.href = `mailto:support@olyshair.com?subject=${subject}&body=${body}`;
}
// Function to refresh order status from server
async function refreshOrderStatus(orderId) {
    try {
        showNotification('Checking for status updates...', 'info');
        
        // Fetch from server
        const response = await apiCall(`/orders/${orderId}`);
        
        if (response && response.order) {
            // Update local storage
            const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
            const orderIndex = orders.findIndex(o => 
                o.orderNumber === orderId || 
                o.id === orderId || 
                o._id === orderId
            );
            
            if (orderIndex !== -1) {
                orders[orderIndex] = {
                    ...orders[orderIndex],
                    status: response.order.status,
                    trackingNumber: response.order.trackingNumber,
                    statusHistory: response.order.statusHistory || orders[orderIndex].statusHistory,
                    updatedAt: response.order.updatedAt
                };
                
                localStorage.setItem('olysHairOrders', JSON.stringify(orders));
                
                // Refresh display
                if (document.getElementById("orders").classList.contains("active")) {
                    await loadFullOrders();
                } else {
                    const orders = await fetchOrders(3);
                    renderRecentOrders(orders);
                }
                
                showNotification('Order status updated!', 'success');
                
                // Re-open order details to show updated status
                setTimeout(() => {
                    closeModal();
                    viewOrderDetails(orderId);
                }, 1000);
            }
        }
    } catch (error) {
        console.error('Error refreshing order status:', error);
        showNotification('Could not check for updates. Please try again later.', 'error');
    }
}
// Function for customers to request cancellation
async function requestCancellation(orderId) {
    const reason = prompt('Please provide a reason for cancellation:');
    
    if (!reason) {
        return;
    }
    
    try {
        const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
        const order = orders.find(o => 
            o.orderNumber === orderId || 
            o.id === orderId || 
            o._id === orderId
        );
        
        if (!order) {
            showNotification('Order not found', 'error');
            return;
        }
        
        // Send cancellation request to server
        const cancellationRequest = {
            orderId: orderId,
            customerEmail: order.customerEmail,
            customerName: order.customerName,
            reason: reason,
            requestedAt: new Date().toISOString()
        };
        
        // You can save this locally or send to server
        const cancellationRequests = JSON.parse(localStorage.getItem('cancellationRequests')) || [];
        cancellationRequests.push(cancellationRequest);
        localStorage.setItem('cancellationRequests', JSON.stringify(cancellationRequests));
        
        showNotification('Cancellation request submitted. The admin will review your request.', 'success');
        
        // Optionally send email to admin
        // await sendCancellationRequestEmail(cancellationRequest);
        
    } catch (error) {
        console.error('Error requesting cancellation:', error);
        showNotification('Failed to submit cancellation request', 'error');
    }
}

// Enhanced notification functions
async function fetchNotificationsWithAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/notifications?limit=10`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        return data.notifications || [];
    } catch (error) {
        console.error('Error fetching notifications:', error);
        return [];
    }
}

async function markNotificationAsRead(notificationId) {
    try {
        const response = await fetch(`${API_BASE_URL}/notifications/${notificationId}/read`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            // Update UI
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.classList.remove('notification-unread');
                // Update badge count
                updateNotificationBadge();
            }
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error marking notification as read:', error);
        return false;
    }
}

async function markAllNotificationsAsRead() {
    try {
        const response = await fetch(`${API_BASE_URL}/notifications/mark-all-read`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            // Update all notifications in UI
            document.querySelectorAll('.notification-unread').forEach(el => {
                el.classList.remove('notification-unread');
            });
            // Update badge count
            updateNotificationBadge();
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error marking all as read:', error);
        return false;
    }
}

async function deleteNotification(notificationId) {
    try {
        const response = await fetch(`${API_BASE_URL}/notifications/${notificationId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error deleting notification:', error);
        return false;
    }
}

function updateNotificationBadge() {
    // You can add a badge counter to the notification icon
    const notificationIcon = document.querySelector('.fa-bell').closest('.sidebar-bubble, .mobile-nav-bubble');
    // Implement badge update logic here
}

// Enhanced order tracking
async function fetchOrderWithStatus(orderId) {
    try {
        const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            return data.order;
        }
        return null;
    } catch (error) {
        console.error('Error fetching order:', error);
        return null;
    }
}

// Enhanced booking tracking
async function fetchBookingWithStatus(bookingId) {
    try {
        const response = await fetch(`${API_BASE_URL}/bookings/${bookingId}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            return data.booking;
        }
        return null;
    } catch (error) {
        console.error('Error fetching booking:', error);
        return null;
    }
}

// Initialize notifications on page load
document.addEventListener('DOMContentLoaded', async function() {
    // ... existing initialization code ...
    
    // Initialize notification badge
    await updateNotificationBadge();
    
    // If URL has notification parameters
    const urlParams = new URLSearchParams(window.location.search);
    const notificationSection = urlParams.get('section');
    const notificationId = urlParams.get('notification');
    
    if (notificationSection === 'notifications' && notificationId) {
        switchSection('notifications');
        // Optionally scroll to or highlight the specific notification
    }
});


// Add to customerdashboard.html script section

// EmailJS configuration (frontend email service)
const EMAILJS_CONFIG = {
    SERVICE_ID: 'service_h1xa80a', // You'll create this in EmailJS
    TEMPLATE_ID_ORDER: 'template_5gu8i9n',
    TEMPLATE_ID_BOOKING: 'template_lu7lopp',
    PUBLIC_KEY: 'FsuVa-YqW6teRd3ro' // Get from EmailJS dashboard
};

// Initialize EmailJS
emailjs.init("FsuVa-YqW6teRd3ro");

// Function to send order confirmation email
async function sendOrderConfirmationEmail(orderData, customerData) {
    try {
        const templateParams = {
            to_email: customerData.email,
            customer_name: customerData.firstName + ' ' + customerData.lastName,
            order_number: orderData.orderNumber,
            order_date: new Date(orderData.orderDate).toLocaleDateString(),
            items: orderData.items.map(item => 
                `${item.name} √ó ${item.quantity} = ‚Ç¨${(item.price * item.quantity).toFixed(2)}`
            ).join('<br>'),
            subtotal: `‚Ç¨${orderData.subtotal.toFixed(2)}`,
            shipping: `‚Ç¨${orderData.shippingCost.toFixed(2)}`,
            tax: `‚Ç¨${orderData.taxAmount.toFixed(2)}`,
            total: `‚Ç¨${orderData.totalAmount.toFixed(2)}`,
            shipping_address: `${customerData.address}, ${customerData.city}, ${customerData.zipCode}, ${customerData.country}`,
            estimated_delivery: new Date(orderData.estimatedDelivery).toLocaleDateString(),
            payment_method: orderData.paymentMethod
        };

        const response = await emailjs.send(
            EMAILJS_CONFIG.SERVICE_ID,
            EMAILJS_CONFIG.TEMPLATE_ID_ORDER,
            templateParams
        );
        
        console.log('üìß Order confirmation email sent:', response);
        return true;
    } catch (error) {
        console.error('Error sending order email:', error);
        return false;
    }
}

// Function to send booking confirmation email
async function sendBookingConfirmationEmail(bookingData, customerData) {
    try {
        const templateParams = {
            to_email: customerData.customerEmail,
            customer_name: customerData.customerName,
            booking_id: bookingData.booking_id,
            booking_date: new Date(bookingData.createdAt).toLocaleDateString(),
            wig_count: bookingData.wigCount,
            total_price: `‚Ç¨${(parseInt(bookingData.wigCount) * 15).toFixed(2)}`,
            notes: bookingData.notes || 'No special notes',
            phone: customerData.customerPhone,
            next_steps: 'You will be contacted within 24 hours with shipping instructions for your wigs.'
        };

        const response = await emailjs.send(
            EMAILJS_CONFIG.SERVICE_ID,
            EMAILJS_CONFIG.TEMPLATE_ID_BOOKING,
            templateParams
        );
        
        console.log('üìß Booking confirmation email sent:', response);
        return true;
    } catch (error) {
        console.error('Error sending booking email:', error);
        return false;
    }
}

// Enhanced notification functions for dashboard
async function fetchNotifications(limit = null) {
    try {
        // Get notifications from localStorage
        const notifications = JSON.parse(localStorage.getItem('olysHairNotifications')) || [];
        
        // Sort by creation date (newest first)
        const sortedNotifications = notifications.sort((a, b) => 
            new Date(b.createdAt) - new Date(a.createdAt)
        );
        
        // Merge with some system notifications
        const systemNotifications = await generateSystemNotifications();
        const allNotifications = [...sortedNotifications, ...systemNotifications]
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        return limit ? allNotifications.slice(0, limit) : allNotifications;
    } catch (error) {
        console.error('Error fetching notifications:', error);
        return [];
    }
}

// Generate system notifications from orders and bookings
async function generateSystemNotifications() {
    const systemNotifications = [];
    
    // Check for recent orders (last 7 days)
    const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
    const recentOrders = orders.filter(order => {
        const orderDate = new Date(order.orderDate || order.createdAt);
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        return orderDate > sevenDaysAgo;
    });
    
    recentOrders.forEach(order => {
        // Check if notification already exists
        const existingNotif = JSON.parse(localStorage.getItem('olysHairNotifications') || '[]')
            .find(n => n.data?.orderId === order.orderNumber);
            
        if (!existingNotif) {
            systemNotifications.push({
                id: `sys-order-${order.orderNumber}`,
                type: 'system',
                title: `Order #${order.orderNumber} Status`,
                message: `Your order ${order.orderNumber} is ${order.status || 'processing'}.`,
                data: { orderId: order.orderNumber },
                read: false,
                createdAt: new Date(order.orderDate || order.createdAt).toISOString(),
                icon: 'fa-box',
                priority: 'medium'
            });
        }
    });
    
    // Check for recent bookings
    const bookings = JSON.parse(localStorage.getItem('olysHairBookings')) || [];
    const recentBookings = bookings.filter(booking => {
        const bookingDate = new Date(booking.createdAt);
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        return bookingDate > sevenDaysAgo;
    });
    
    recentBookings.forEach(booking => {
        const existingNotif = JSON.parse(localStorage.getItem('olysHairNotifications') || '[]')
            .find(n => n.data?.bookingId === booking.booking_id);
            
        if (!existingNotif) {
            systemNotifications.push({
                id: `sys-booking-${booking.booking_id}`,
                type: 'system',
                title: `Booking #${booking.booking_id}`,
                message: `Your wig service booking is ${booking.status || 'pending'}.`,
                data: { bookingId: booking.booking_id },
                read: false,
                createdAt: new Date(booking.createdAt).toISOString(),
                icon: 'fa-calendar-alt',
                priority: 'medium'
            });
        }
    });
    
    return systemNotifications;
}

// Enhanced renderFullNotifications function
function renderFullNotifications(notifications) {
    const container = document.getElementById("notifications-full-container");

    if (!notifications || notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications</p>
            </div>
        `;
        return;
    }

    let notificationsHtml = '';
    
    // Group by type
    const orderNotifications = notifications.filter(n => n.type === 'order');
    const bookingNotifications = notifications.filter(n => n.type === 'booking');
    const systemNotifications = notifications.filter(n => n.type === 'system');
    
    if (orderNotifications.length > 0) {
        notificationsHtml += `
            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--cream); margin-bottom: 10px;">Order Notifications</h3>
                ${orderNotifications.map(notification => renderNotificationItem(notification)).join('')}
            </div>
        `;
    }
    
    if (bookingNotifications.length > 0) {
        notificationsHtml += `
            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--cream); margin-bottom: 10px;">Booking Notifications</h3>
                ${bookingNotifications.map(notification => renderNotificationItem(notification)).join('')}
            </div>
        `;
    }
    
    if (systemNotifications.length > 0) {
        notificationsHtml += `
            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--cream); margin-bottom: 10px;">System Notifications</h3>
                ${systemNotifications.map(notification => renderNotificationItem(notification)).join('')}
            </div>
        `;
    }

    container.innerHTML = notificationsHtml;
    
    // Add event listeners
    addNotificationEventListeners();
}

// Render individual notification item
function renderNotificationItem(notification) {
    const unreadClass = notification.read ? '' : 'notification-unread';
    const icon = notification.icon || getNotificationIcon(notification.type);
    const timeAgo = getTimeAgo(notification.createdAt);
    
    return `
        <div class="notification-item ${unreadClass}" data-notification-id="${notification.id}">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <i class="fas ${icon}" style="color: var(--cream); font-size: 16px;"></i>
                <h4 style="margin: 0; flex: 1;">${notification.title}</h4>
                ${notification.priority === 'high' ? 
                    '<span style="color: #ff6b6b; font-size: 12px; background: #ffebee; padding: 2px 8px; border-radius: 10px;">Important</span>' : ''}
            </div>
            <p style="margin: 5px 0 10px 0; font-size: 14px;">${notification.message}</p>
            
            ${notification.data?.orderId ? `
                <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>Order:</strong> ${notification.data.orderId}</span>
                        <button onclick="resendOrderEmail('${notification.data.orderId}')" 
                                style="background: var(--cream); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-envelope"></i> Resend Email
                        </button>
                    </div>
                </div>
            ` : ''}
            
            ${notification.data?.bookingId ? `
                <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>Booking:</strong> ${notification.data.bookingId}</span>
                        <button onclick="resendBookingEmail('${notification.data.bookingId}')" 
                                style="background: var(--cream); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-envelope"></i> Resend Email
                        </button>
                    </div>
                </div>
            ` : ''}
            
            <div class="notification-time">${timeAgo}</div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="mark-read-btn" data-notification-id="${notification.id}" 
                        style="background: none; border: none; color: var(--cream); cursor: pointer; font-size: 12px;">
                    <i class="fas fa-check"></i> Mark as read
                </button>
                <button class="delete-notification-btn" data-notification-id="${notification.id}" 
                        style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    `;
}

// Function to resend order confirmation email
async function resendOrderEmail(orderId) {
    try {
        const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
        const order = orders.find(o => o.orderNumber === orderId || o.id === orderId);
        
        if (!order) {
            showNotification('Order not found', 'error');
            return;
        }
        
        // Get customer data
        const userData = JSON.parse(localStorage.getItem('user')) || {};
        const customerData = {
            email: userData.email || order.customerEmail,
            firstName: userData.firstName || order.customerName?.split(' ')[0] || '',
            lastName: userData.lastName || order.customerName?.split(' ')[1] || '',
            address: order.shippingAddress?.street || '',
            city: order.shippingAddress?.city || '',
            zipCode: order.shippingAddress?.zipCode || '',
            country: order.shippingAddress?.country || ''
        };
        
        showNotification('Sending order confirmation email...', 'info');
        
        const success = await sendOrderConfirmationEmail(order, customerData);
        
        if (success) {
            showNotification('Order confirmation email sent successfully!', 'success');
        } else {
            showNotification('Failed to send email. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Error resending order email:', error);
        showNotification('Error sending email', 'error');
    }
}

// Function to resend booking confirmation email
async function resendBookingEmail(bookingId) {
    try {
        const bookings = JSON.parse(localStorage.getItem('olysHairBookings')) || [];
        const booking = bookings.find(b => b.booking_id === bookingId || b._id === bookingId);
        
        if (!booking) {
            showNotification('Booking not found', 'error');
            return;
        }
        
        const customerData = {
            customerEmail: booking.customerEmail,
            customerName: booking.customerName,
            customerPhone: booking.customerPhone
        };
        
        showNotification('Sending booking confirmation email...', 'info');
        
        const success = await sendBookingConfirmationEmail(booking, customerData);
        
        if (success) {
            showNotification('Booking confirmation email sent successfully!', 'success');
        } else {
            showNotification('Failed to send email. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Error resending booking email:', error);
        showNotification('Error sending email', 'error');
    }
}

// Helper function to get time ago
function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    const diffWeeks = Math.floor(diffDays / 7);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    if (diffWeeks < 4) return `${diffWeeks} week${diffWeeks !== 1 ? 's' : ''} ago`;
    
    return date.toLocaleDateString();
}

// Helper function to get notification icon
function getNotificationIcon(type) {
    const icons = {
        'order': 'fa-shopping-bag',
        'booking': 'fa-calendar-check',
        'system': 'fa-info-circle',
        'promotion': 'fa-tag'
    };
    return icons[type] || 'fa-bell';
}

// Function to mark notification as read
async function markNotificationAsRead(notificationId) {
    try {
        const notifications = JSON.parse(localStorage.getItem('olysHairNotifications')) || [];
        const notificationIndex = notifications.findIndex(n => n.id === notificationId);
        
        if (notificationIndex !== -1) {
            notifications[notificationIndex].read = true;
            localStorage.setItem('olysHairNotifications', JSON.stringify(notifications));
            
            // Update UI
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.classList.remove('notification-unread');
                notificationElement.querySelector('.mark-read-btn')?.remove();
            }
            
            showNotification('Notification marked as read');
            updateNotificationBadge();
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
        showNotification('Failed to mark as read', 'error');
    }
}

// Function to delete notification
async function deleteNotification(notificationId) {
    if (!confirm('Are you sure you want to delete this notification?')) {
        return;
    }
    
    try {
        let notifications = JSON.parse(localStorage.getItem('olysHairNotifications')) || [];
        notifications = notifications.filter(n => n.id !== notificationId);
        localStorage.setItem('olysHairNotifications', JSON.stringify(notifications));
        
        // Remove from UI
        const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (notificationElement) {
            notificationElement.remove();
        }
        
        showNotification('Notification deleted');
        updateNotificationBadge();
    } catch (error) {
        console.error('Error deleting notification:', error);
        showNotification('Failed to delete notification', 'error');
    }
}

// Function to mark all notifications as read
async function markAllNotificationsAsRead() {
    try {
        const notifications = JSON.parse(localStorage.getItem('olysHairNotifications')) || [];
        
        notifications.forEach(notification => {
            notification.read = true;
        });
        
        localStorage.setItem('olysHairNotifications', JSON.stringify(notifications));
        
        // Update UI
        document.querySelectorAll('.notification-unread').forEach(el => {
            el.classList.remove('notification-unread');
        });
        
        // Remove mark-as-read buttons
        document.querySelectorAll('.mark-read-btn').forEach(btn => {
            btn.remove();
        });
        
        showNotification('All notifications marked as read');
        updateNotificationBadge();
    } catch (error) {
        console.error('Error marking all as read:', error);
        showNotification('Failed to mark all as read', 'error');
    }
}

// Function to update notification badge
function updateNotificationBadge() {
    const notifications = JSON.parse(localStorage.getItem('olysHairNotifications')) || [];
    const unreadCount = notifications.filter(n => !n.read).length;
    
    const badgeElement = document.getElementById('notificationBadge');
    if (badgeElement) {
        if (unreadCount > 0) {
            badgeElement.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badgeElement.style.display = 'flex';
        } else {
            badgeElement.style.display = 'none';
        }
    }
}

// Add event listeners for notification buttons
function addNotificationEventListeners() {
    document.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const notificationId = this.getAttribute('data-notification-id');
            markNotificationAsRead(notificationId);
        });
    });
    
    document.querySelectorAll('.delete-notification-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const notificationId = this.getAttribute('data-notification-id');
            deleteNotification(notificationId);
        });
    });
}

// Initialize notification system on page load
document.addEventListener('DOMContentLoaded', function() {
    // Update notification badge
    updateNotificationBadge();
    
    // Check URL for notification parameters
    const urlParams = new URLSearchParams(window.location.search);
    const notificationId = urlParams.get('notification');
    
    if (notificationId) {
        // Mark specific notification as read
        markNotificationAsRead(notificationId);
    }
});


// Function to get notification icon
function getNotificationIcon(type) {
    const icons = {
        'order': 'fa-shopping-bag',
        'booking': 'fa-calendar-check',
        'system': 'fa-info-circle',
        'promotion': 'fa-tag'
    };
    return icons[type] || 'fa-bell';
}

// Function to get time ago
function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString();
}

// Function to update notification badge
function updateNotificationBadge() {
    const notifications = JSON.parse(localStorage.getItem('olysHairNotifications')) || [];
    const unreadCount = notifications.filter(n => !n.read).length;
    
    const badgeElement = document.getElementById('notificationBadge');
    if (badgeElement) {
        if (unreadCount > 0) {
            badgeElement.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badgeElement.style.display = 'flex';
        } else {
            badgeElement.style.display = 'none';
        }
    }
}
    </script>
  </body>
</html>