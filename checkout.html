<!DOCTYPE html>
<html lang="en">
<head>
    <!-- üñºÔ∏è Favicon -->
    <link rel="icon" type="image/png" href="/images/Logo Version Transparente-01.png">
    <link rel="apple-touch-icon" href="/images/Logo Version Transparente-01.png">

    <!-- üîç Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "url": "https://www.olyshair.com",
      "logo": "https://www.olyshair.com/images/Logo%20Version%20Transparente-01.png"
    }
    </script>
    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OLYS HAIR - Secure Checkout</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet" />
    
    <!-- Payment SDKs -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=Afdo7xRdDvUKhixkahcnYo27-SmAYrZQgvuZSPATxitvw__sm4A5ZWHtresK_n-UrywV8pCBmuqpRGqg&currency=EUR&disable-funding=card,credit"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
      /* ==================== CSS VARIABLES & RESET ==================== */
      :root {
        --cream: #392625;
        --white: #ffffff;
        --dark-gray: #1e1e1e;
        --light-bg: #f8f5f2;
        --text-dark: #1e1e1e;
        --text-light: #ffffff;
        --card-bg: #ffffff;
        --shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --primary: #392625;
        --primary-light: rgba(57, 38, 37, 0.1);
      }

      .dark-mode {
        --cream: #c8b4a8;
        --white: #1e1e1e;
        --dark-gray: #f8f5f2;
        --light-bg: #2d2d2d;
        --text-dark: #f8f5f2;
        --text-light: #1e1e1e;
        --card-bg: #181212;
        --shadow: 0 5px 15px rgba(182, 131, 131, 0.2);
        --primary: #c8b4a8;
        --primary-light: rgba(200, 180, 168, 0.2);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Montserrat", sans-serif;
        background-color: var(--white);
        color: var(--text-dark);
        overflow-x: hidden;
        line-height: 1.6;
        transition: all 0.3s ease;
        min-height: 100vh;
      }

      h1, h2, h3, h4 {
        font-family: "Playfair Display", serif;
        font-weight: 600;
        color: var(--cream);
      }

      /* ==================== HEADER STYLES ==================== */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
        background-color: var(--white);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
      }

      .logo-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 180px;
        height: 80px;
        background-color: var(--white);
        border-radius: 10px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .logo-img-light, .logo-img-dark {
        max-width: 120px;
        max-height: 50px;
        margin: 0 auto;
        object-fit: contain;
      }

      .logo-img-dark { display: none; }
      .dark-mode .logo-img-light { display: none; }
      .dark-mode .logo-img-dark { display: block; }

      .nav-links {
        display: flex;
        gap: 30px;
      }

      .nav-links a {
        text-decoration: none;
        color: var(--text-dark);
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .nav-links a:hover { color: var(--cream); }

      .header-icons {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .header-icons i {
        font-size: 20px;
        color: var(--cream);
        cursor: pointer;
        position: relative;
      }

      .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--error);
        color: white;
        font-size: 10px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      /* Dark/Light Mode Toggle */
      .mode-toggle {
        width: 60px;
        height: 30px;
        background: var(--light-bg);
        border-radius: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 0 5px;
        position: relative;
      }

      .toggle-circle {
        width: 22px;
        height: 22px;
        background: var(--cream);
        border-radius: 50%;
        position: absolute;
        left: 4px;
        transition: all 0.3s ease;
      }

      .dark-mode .toggle-circle { left: 34px; }
      .mode-toggle i { font-size: 14px; z-index: 2; }
      .fa-sun { color: var(--cream); margin-right: auto; }
      .fa-moon { color: var(--cream); margin-left: auto; }

      /* ==================== CHECKOUT CONTAINER ==================== */
      .checkout-container {
        max-width: 1200px;
        margin: 140px auto 40px;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 40px;
      }

      @media (max-width: 1024px) {
        .checkout-container {
          grid-template-columns: 1fr;
          margin-top: 120px;
        }
      }

      /* ==================== CHECKOUT STEPS ==================== */
      .checkout-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
      }

      .checkout-steps::before {
        content: "";
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--light-bg);
        z-index: 1;
      }

      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
      }

      .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--light-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .step.active .step-circle {
        background: var(--cream);
        color: var(--white);
      }

      .step.completed .step-circle {
        background: var(--success);
        color: var(--white);
      }

      .step-label {
        font-size: 14px;
        font-weight: 500;
      }

      /* ==================== CHECKOUT SECTIONS ==================== */
      .checkout-section {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
      }

      .section-title {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--light-bg);
      }

      /* ==================== FORM STYLES ==================== */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--cream);
      }

      .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--light-bg);
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-dark);
        font-family: "Montserrat", sans-serif;
        transition: border-color 0.3s;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--cream);
      }

      .form-control.error { border-color: var(--error); }
      .form-control.success { border-color: var(--success); }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      @media (max-width: 768px) {
        .form-row { grid-template-columns: 1fr; }
      }

      .field-error {
        color: var(--error);
        font-size: 12px;
        margin-top: 5px;
        display: block;
        min-height: 16px;
      }

      /* ==================== PAYMENT SELECTION ==================== */
      .payment-instructions {
        background: var(--primary-light);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid var(--cream);
      }

      .payment-selection {
        margin-top: 30px;
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .payment-selection.active {
        display: block;
      }

      .payment-options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .payment-option {
        border: 2px solid var(--light-bg);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .payment-option:hover {
        border-color: var(--cream);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .payment-option.selected {
        border-color: var(--cream);
        background: var(--primary-light);
      }

      .payment-option i {
        font-size: 32px;
        color: var(--cream);
      }

      .payment-option small {
        color: var(--text-dark);
        opacity: 0.7;
      }

      /* ==================== PAYMENT PROCESSORS ==================== */
      .payment-processor {
        margin-top: 30px;
        display: none;
        animation: slideIn 0.5s ease;
      }

      .payment-processor.active {
        display: block;
      }

      .stripe-payment-form {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--light-bg);
      }

      #card-element {
        padding: 12px;
        border: 1px solid var(--light-bg);
        border-radius: 8px;
        background: var(--card-bg);
        min-height: 50px;
      }

      #card-errors {
        color: var(--error);
        margin-top: 10px;
        font-size: 14px;
        min-height: 20px;
      }

      .processing-indicator {
        text-align: center;
        padding: 30px;
        display: none;
      }

      .processing-indicator.active {
        display: block;
      }

      .processing-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(200, 180, 168, 0.3);
        border-top-color: var(--cream);
        border-radius: 50%;
        margin: 0 auto 15px;
        animation: spin 1s linear infinite;
      }

      /* ==================== ORDER SUMMARY ==================== */
      .order-summary {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 30px;
        box-shadow: var(--shadow);
        position: sticky;
        top: 140px;
        height: fit-content;
      }

      .order-items {
        margin-bottom: 20px;
        max-height: 400px;
        overflow-y: auto;
        padding-right: 10px;
      }

      .order-item {
        display: flex;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--light-bg);
      }

      .order-item:last-child {
        border-bottom: none;
      }

      .order-item-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        margin-right: 15px;
        flex-shrink: 0;
      }

      .order-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .order-item-details {
        flex: 1;
      }

      .order-item-details h4 {
        margin-bottom: 5px;
        font-size: 16px;
      }

      .item-sku {
        font-size: 12px;
        color: #666;
        margin: 2px 0;
      }

      .order-item-price {
        color: var(--cream);
        font-weight: 600;
        margin: 5px 0;
      }

      .item-total {
        font-weight: 600;
        color: var(--text-dark);
      }

      /* Order Totals */
      .order-totals {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid var(--light-bg);
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 15px;
      }

      .total-row.discount {
        color: var(--success);
        font-weight: 600;
      }

      .total-final {
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--light-bg);
      }

      /* Promo Code */
      .promo-code {
        display: flex;
        margin: 20px 0;
        gap: 0;
      }

      .promo-input {
        flex: 1;
        border-radius: 8px 0 0 8px;
      }

      .promo-btn {
        background: var(--cream);
        color: var(--white);
        border: none;
        border-radius: 0 8px 8px 0;
        padding: 0 20px;
        cursor: pointer;
        transition: background 0.3s;
        font-weight: 500;
      }

      .promo-btn:hover {
        background: var(--dark-gray);
      }

      .promo-message {
        margin-top: 5px;
        font-size: 14px;
        min-height: 20px;
      }

      .promo-message.success { color: var(--success); }
      .promo-message.error { color: var(--error); }

      /* ==================== BUTTONS ==================== */
      .checkout-btn {
        width: 100%;
        padding: 15px;
        background: var(--cream);
        color: var(--white);
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }

      .checkout-btn:hover {
        background: var(--dark-gray);
        transform: translateY(-2px);
      }

      .checkout-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
      }

      .checkout-btn.processing {
        background: var(--warning);
        cursor: wait;
      }

      /* Secondary Button */
      .btn-secondary {
        background: var(--light-bg);
        color: var(--text-dark);
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
      }

      .btn-secondary:hover {
        background: var(--dark-gray);
        color: var(--white);
      }

      /* ==================== SECURITY BADGES ==================== */
      .security-badges {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--light-bg);
      }

      .security-badge {
        font-size: 12px;
        color: #666;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* ==================== FLOATING BUBBLES ==================== */
      .floating-bubbles {
        position: fixed;
        right: 30px;
        bottom: 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 1200;
      }

      .bubble-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--cream);
        color: var(--white);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 22px;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .bubble-btn:hover {
        background: var(--dark-gray);
        transform: scale(1.1);
      }

      .bubble-btn span {
        position: absolute;
        right: 70px;
        background: var(--dark-gray);
        color: var(--white);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        white-space: nowrap;
        display: none;
      }

      .bubble-btn:hover span {
        display: block;
      }

      /* ==================== MODALS ==================== */
      .receipt-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
      }

      .receipt-modal.active {
        opacity: 1;
        visibility: visible;
      }

      .receipt-content {
        background: var(--card-bg);
        border-radius: 10px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 40px;
        position: relative;
        animation: modalSlideIn 0.5s ease;
      }

      .receipt-close {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--cream);
        color: var(--white);
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 10;
        transition: all 0.3s;
      }

      .receipt-close:hover {
        background: var(--dark-gray);
        transform: rotate(90deg);
      }

      .receipt-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--light-bg);
      }

      .receipt-header h2 {
        color: var(--success);
        margin-bottom: 10px;
      }

      .receipt-header p {
        color: var(--text-dark);
        margin: 5px 0;
      }

      .receipt-details {
        margin-bottom: 25px;
      }

      .receipt-details h3 {
        margin-bottom: 15px;
        color: var(--cream);
        font-size: 18px;
      }

      .receipt-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 5px 0;
        border-bottom: 1px dashed var(--light-bg);
      }

      .receipt-row:last-child {
        border-bottom: none;
      }

      .receipt-total {
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid var(--light-bg);
      }

      .receipt-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
      }

      .receipt-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
      }

      .receipt-print {
        background: var(--cream);
        color: var(--white);
      }

      .receipt-print:hover {
        background: var(--dark-gray);
      }

      .receipt-close-btn {
        background: var(--light-bg);
        color: var(--text-dark);
      }

      .receipt-close-btn:hover {
        background: var(--dark-gray);
        color: var(--white);
      }

      /* ==================== NOTIFICATION SYSTEM ==================== */
      .notification {
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1500;
        transform: translateX(120%);
        transition: transform 0.3s ease;
        max-width: 350px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        backdrop-filter: blur(10px);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success { background: rgba(16, 185, 129, 0.9); }
      .notification.error { background: rgba(239, 68, 68, 0.9); }
      .notification.warning { background: rgba(245, 158, 11, 0.9); }
      .notification.info { background: rgba(57, 38, 37, 0.9); }

      /* ==================== LOADING OVERLAY ==================== */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1900;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 70px;
        height: 70px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--cream);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
      }

      .loading-text {
        color: white;
        font-size: 18px;
        font-weight: 500;
      }

      /* ==================== UTILITY CLASSES ==================== */
      .empty-cart-message {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-dark);
      }

      .empty-cart-message i {
        font-size: 48px;
        color: var(--cream);
        margin-bottom: 20px;
      }

      .hidden { display: none; }
      .visible { display: block; }
      .text-center { text-align: center; }
      .text-success { color: var(--success); }
      .text-error { color: var(--error); }

      /* ==================== ANIMATIONS ==================== */
      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-30px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* ==================== RESPONSIVE DESIGN ==================== */
      @media (max-width: 768px) {
        header {
          padding: 15px 20px;
        }
        
        .checkout-container {
          padding: 0 15px;
          margin-top: 120px;
        }
        
        .checkout-section {
          padding: 20px 15px;
        }
        
        .order-summary {
          position: static;
          margin-top: 20px;
        }
        
        .payment-options-grid {
          grid-template-columns: 1fr;
        }
        
        .receipt-content {
          padding: 25px 15px;
        }
        
        .receipt-actions {
          flex-direction: column;
        }
        
        .floating-bubbles {
          bottom: 20px;
          right: 20px;
        }
        
        .bubble-btn {
          width: 50px;
          height: 50px;
          font-size: 18px;
        }
      }

      @media (max-width: 480px) {
        .header-icons {
          gap: 15px;
        }
        
        .nav-links {
          display: none;
        }
        
        .checkout-steps {
          flex-wrap: wrap;
          gap: 15px;
        }
        
        .step {
          flex: 1;
          min-width: 100px;
        }
      }
    </style>
</head>
<body>
    <!-- ==================== HEADER ==================== -->
    <header>
        <div class="logo-container">
            <span>
                <img src="images/Logo Version Transparente-01.png" alt="OLYS HAIR Logo" class="logo-img-light" />
                <img src="images/Artboard 1 copy.png" alt="OLYS HAIR Logo Bright" class="logo-img-dark" />
            </span>
        </div>
        
        <nav class="nav-links">
            <a href="shop.html">Boutique</a>
            <a href="contact.html">Contact</a>
        </nav>
        
        <div class="header-icons">
            <i class="fas fa-search"></i>
            <div class="cart-bubble">
                <i class="fas fa-shopping-bag"></i>
                <span class="cart-count"></span>
            </div>
            <i class="fas fa-user" onclick="window.location.href='customerdashboard.html'"></i>
            <div class="mode-toggle">
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
                <div class="toggle-circle"></div>
            </div>
        </div>
    </header>

    <!-- ==================== MAIN CHECKOUT CONTAINER ==================== -->
    <div class="checkout-container">
        <!-- LEFT COLUMN: Checkout Form -->
        <div class="checkout-form">
            <!-- Progress Steps -->
            <div class="checkout-steps">
                <div class="step active">
                    <div class="step-circle">1</div>
                    <div class="step-label">Information</div>
                </div>
                <div class="step">
                    <div class="step-circle">2</div>
                    <div class="step-label">Paiement</div>
                </div>
                <div class="step">
                    <div class="step-circle">3</div>
                    <div class="step-label">Confirmation</div>
                </div>
            </div>

            <!-- SHIPPING INFORMATION -->
            <div class="checkout-section">
                <h2 class="section-title">Informations de Livraison</h2>
                
                <div class="form-group">
                    <label for="email">Adresse Email *</label>
                    <input type="email" id="email" class="form-control" placeholder="votre@email.com" required />
                    <div class="field-error" id="email-error"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">Pr√©nom *</label>
                        <input type="text" id="firstName" class="form-control" placeholder="Pr√©nom" required />
                        <div class="field-error" id="firstName-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Nom *</label>
                        <input type="text" id="lastName" class="form-control" placeholder="Nom" required />
                        <div class="field-error" id="lastName-error"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="address">Addresse *</label>
                    <input type="text" id="address" class="form-control" placeholder="Addresse" required />
                    <div class="field-error" id="address-error"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">Ville *</label>
                        <input type="text" id="city" class="form-control" placeholder="Ville" required />
                        <div class="field-error" id="city-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="zipCode">Code Postal *</label>
                        <input type="text" id="zipCode" class="form-control" placeholder="Code Postal" required />
                        <div class="field-error" id="zipCode-error"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="country">Pays *</label>
                        <select id="country" class="form-control" required>
                            <option value="">S√©lectionnez un pays</option>
                            <option value="us">√âtats-Unis</option>
                            <option value="uk">Royaume-Uni</option>
                            <option value="fr">France</option>
                            <option value="de">Allemagne</option>
                            <option value="ch">Suisse</option>
                        </select>
                        <div class="field-error" id="country-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="phone">Num√©ro de t√©l√©phone *</label>
                        <input type="tel" id="phone" class="form-control" placeholder="Num√©ro de t√©l√©phone" required />
                        <div class="field-error" id="phone-error"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="saveAddress" />
                        Enregistrer cette adresse pour les commandes futures
                    </label>
                </div>
            </div>

            <!-- SHIPPING METHOD -->
            <div class="checkout-section">
                <h2 class="section-title">M√©thode d'exp√©dition</h2>
                
                <div class="form-group">
                    <label class="shipping-option">
                        <input type="radio" name="shipping" value="standard" checked />
                        <div>
                            <strong>Exp√©dition Standard</strong>
                            <p>5-7 jours ouvrables</p>
                            <span class="shipping-price">‚Ç¨9.99</span>
                        </div>
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="shipping-option">
                        <input type="radio" name="shipping" value="express" />
                        <div>
                            <strong>Livraison Express</strong>
                            <p>2-3 jours ouvrables</p>
                            <span class="shipping-price">‚Ç¨19.99</span>
                        </div>
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="shipping-option">
                        <input type="radio" name="shipping" value="overnight" />
                        <div>
                            <strong>Livraison de nuit</strong>
                            <p>1 jour ouvrable</p>
                            <span class="shipping-price">‚Ç¨29.99</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- PAYMENT SECTION -->
            <div class="checkout-section">
                <h2 class="section-title">Compl√©tez votre commande</h2>
                
                <div class="payment-instructions">
                    <i class="fas fa-shield-alt"></i>
                    <strong>Paiement s√©curis√©</strong>
                    <p>Vos informations de paiement sont crypt√©es et s√©curis√©es.</p>
                </div>

                <!-- Place Order Button -->
                <button class="checkout-btn" id="initiatePayment">
                    <i class="fas fa-lock"></i> V√©rifier et passer la commande
                </button>

                <!-- Payment Selection (Initially Hidden) -->
                <div class="payment-selection" id="paymentSelection">
                    <h3>S√©lectionnez le mode de paiement</h3>
                    <p>Choisissez comment vous souhaitez payer</p>
                    
                    <div class="payment-options-grid">
                        <div class="payment-option" data-method="paypal">
                            <i class="fab fa-paypal"></i>
                            <div>PayPal</div>
                            <small>Payer avec le solde PayPal ou une carte</small>
                        </div>
                        
                        <!-- Add more payment methods as needed -->
                    </div>

                    <!-- Payment Processors -->
                    <div class="payment-processor" id="paypalProcessor">
                        <div id="paypal-button-container"></div>
                    </div>

                    <!-- Processing Indicator -->
                    <div class="processing-indicator" id="paymentProcessing">
                        <div class="processing-spinner"></div>
                        <p>Traitement de votre paiement...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Order Summary -->
        <div class="order-summary">
            <h2 class="section-title">R√©sum√© de la commande</h2>
            
            <div class="order-items" id="orderItems">
                <!-- Items will be populated by JavaScript -->
            </div>
            
            <!-- Promo Code -->
            <div class="promo-code">
                <input type="text" class="form-control promo-input" id="promoCode" placeholder="Code Promo" />
                <button class="promo-btn" id="applyPromo">Appliquer</button>
            </div>
            <div class="promo-message" id="promoMessage"></div>
            
            <!-- Order Totals -->
            <div class="order-totals">
                <div class="total-row">
                    <span>Sous-total</span>
                    <span id="subtotal">‚Ç¨0.00</span>
                </div>
                <div class="total-row discount" id="discountRow" style="display: none;">
                    <span>Remise</span>
                    <span id="discount">-‚Ç¨0.00</span>
                </div>
                <div class="total-row">
                    <span>Livraison</span>
                    <span id="shipping">‚Ç¨0.00</span>
                </div>
                <div class="total-row">
                    <span>Taxe</span>
                    <span id="tax">‚Ç¨0.00</span>
                </div>
                <div class="total-row total-final">
                    <span>Total</span>
                    <span id="total">‚Ç¨0.00</span>
                </div>
            </div>
            
            <!-- Additional Order Info -->
            <div class="order-info">
                <p><i class="fas fa-shipping-fast"></i> Livraison gratuite pour les commandes de plus de 100 ‚Ç¨</p>
                <p><i class="fas fa-undo"></i> Politique de retour de 30 jours</p>
                <p><i class="fas fa-shield-alt"></i> Cryptage SSL s√©curis√©</p>
            </div>
            
            <div class="security-badges">
                <div class="security-badge">
                    <i class="fas fa-lock"></i> Paiement s√©curis√©
                </div>
                <div class="security-badge">
                    <i class="fas fa-shield-alt"></i> SSL Crypt√©
                </div>
                <div class="security-badge">
                    <i class="fas fa-heart"></i> Vendeur de confiance
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== FLOATING BUBBLES ==================== -->
    <div class="floating-bubbles">
        <div class="bubble-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-home"></i>
            <span>Accueil</span>
        </div>
        <div class="bubble-btn" onclick="window.location.href='shop.html'">
            <i class="fas fa-shopping-bag"></i>
            <span>Boutique</span>
        </div>
        <div class="bubble-btn" onclick="window.location.href='customerdashboard.html'">
            <i class="fas fa-user"></i>
            <span>Compte</span>
        </div>
    </div>

    <!-- ==================== RECEIPT MODAL ==================== -->
    <div class="receipt-modal" id="receiptModal">
        <div class="receipt-content">
            <div class="receipt-close" id="closeReceipt">
                <i class="fas fa-times"></i>
            </div>
            
            <div class="receipt-header">
                <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success); margin-bottom: 15px;"></i>
                <h2>Commande confirm√©e !</h2>
                <p>Merci pour votre achat</p>
                <p id="orderNumber">Commande #OL-123456</p>
            </div>
            
            <div class="receipt-details">
                <h3>D√©tails de la commande</h3>
                <div id="receipt-items"></div>
                <div class="receipt-row">
                    <span>Sous-total</span>
                    <span id="receipt-subtotal">‚Ç¨0.00</span>
                </div>
                <div class="receipt-row" id="receipt-discount-row" style="display: none;">
                    <span>Remise</span>
                    <span id="receipt-discount">-‚Ç¨0.00</span>
                </div>
                <div class="receipt-row">
                    <span>Livraison</span>
                    <span id="receipt-shipping">‚Ç¨0.00</span>
                </div>
                <div class="receipt-row">
                    <span>Taxe</span>
                    <span id="receipt-tax">‚Ç¨0.00</span>
                </div>
                <div class="receipt-row receipt-total">
                    <span>Total</span>
                    <span id="receipt-total">‚Ç¨0.00</span>
                </div>
            </div>
            
            <div class="receipt-details">
                <h3>Informations de livraison</h3>
                <div id="receipt-shipping-info"></div>
            </div>
            
            <div class="receipt-details">
                <h3>Livraison estim√©e</h3>
                <p id="receipt-delivery">5-7 jours ouvrables</p>
            </div>
            
            <div class="receipt-actions">
                <button class="receipt-btn receipt-print" onclick="window.print()">
                    <i class="fas fa-print"></i> Imprimer le re√ßu
                </button>
                <button class="receipt-btn receipt-close-btn" id="closeReceiptBtn">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== NOTIFICATION SYSTEM ==================== -->
    <div class="notification" id="notification"></div>

    <!-- ==================== LOADING OVERLAY ==================== -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Traitement en cours...</div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            STRIPE_PUBLISHABLE_KEY: "pk_test_51SAVVd3tLr6waZvCb40vB1OfO3ZOX8EU1htFN8HNdu3kURHsNoP6K5rkTx7vUMu9TNbXONzrc2bRjk3NNS5Y92NQ00uSJr71I0",
            PAYPAL_CLIENT_ID: "Afdo7xRdDvUKhixkahcnYo27-SmAYrZQgvuZSPATxitvw__sm4A5ZWHtresK_n-UrywV8pCBmuqpRGqg",
            API_BASE_URL: "https://olyshairi-e-commerce-hairspo-online-kgz2.onrender.com/api",
            CURRENCY: "EUR",
            TAX_RATE: 0.08,
            EMAILJS_PUBLIC_KEY: "FsuVa-YqW6teRd3ro",
            EMAILJS_SERVICE_ID: "service_qkn3llq",
            EMAILJS_TEMPLATE_ID: "template_9f1xedk"
        };

        // ==================== GLOBAL VARIABLES ====================
        let stripe = null;
        let elements = null;
        let cardElement = null;
        let selectedPaymentMethod = null;
        let currentOrderData = null;
        let appliedPromoCode = null;
        let promoDiscount = 0;
        let orderPayload = null;
        let paypalButtons = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener("DOMContentLoaded", async function() {
            console.log("üöÄ Checkout page loaded");
            
            // Check authentication
            if (!checkAuthentication()) {
                return;
            }
            
            // Initialize EmailJS
            emailjs.init(CONFIG.EMAILJS_PUBLIC_KEY);
            
            // Initialize UI
            initializeUI();
            setupEventListeners();
            updateCartCount();
            
            // Load order review
            await loadOrderReview();
            
            // Initialize Stripe
            initializeStripe();
            
            console.log("‚úÖ Checkout initialization complete");
        });

        // ==================== AUTHENTICATION ====================
        function checkAuthentication() {
            const token = localStorage.getItem("token");
            const user = localStorage.getItem("user");
            
            if (!token || !user) {
                showNotification("Please sign in to access checkout", "error");
                
                // Redirect to sign-in page
                setTimeout(() => {
                    window.location.href = "sign-in.html?redirect=checkout";
                }, 2000);
                return false;
            }
            
            try {
                const userData = JSON.parse(user);
                console.log('‚úÖ User authenticated:', userData.email);
                
                // Pre-fill user data if available
                prefillUserData(userData);
                
                return true;
            } catch (e) {
                console.error('Error parsing user data:', e);
                return false;
            }
        }

        function prefillUserData(userData) {
            if (userData.email) {
                const emailField = document.getElementById("email");
                if (emailField && !emailField.value) {
                    emailField.value = userData.email;
                }
            }
            
            if (userData.shippingAddress) {
                // Pre-fill shipping address if saved
                const fields = ['firstName', 'lastName', 'address', 'city', 'zipCode', 'phone'];
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element && userData.shippingAddress[field]) {
                        element.value = userData.shippingAddress[field];
                    }
                });
            }
        }

        // ==================== UI INITIALIZATION ====================
        function initializeUI() {
            // Dark/Light mode toggle
            const modeToggle = document.querySelector('.mode-toggle');
            if (modeToggle) {
                modeToggle.addEventListener('click', toggleDarkMode);
                
                // Check for saved theme preference
                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                }
            }
            
            // Billing address toggle
            const sameAsShipping = document.getElementById("sameAsShipping");
            const billingAddressFields = document.getElementById("billingAddressFields");
            if (sameAsShipping && billingAddressFields) {
                sameAsShipping.addEventListener("change", () => {
                    billingAddressFields.style.display = sameAsShipping.checked ? "none" : "block";
                });
            }
        }

        function setupEventListeners() {
            // Place Order button
            const initiatePaymentBtn = document.getElementById("initiatePayment");
            if (initiatePaymentBtn) {
                initiatePaymentBtn.addEventListener("click", handlePlaceOrderClick);
            }
            
            // Payment method selection
            document.querySelectorAll(".payment-option").forEach(option => {
                option.addEventListener("click", function() {
                    selectPaymentMethod(this.dataset.method);
                });
            });
            
            // Promo code
            const applyPromoBtn = document.getElementById("applyPromo");
            if (applyPromoBtn) {
                applyPromoBtn.addEventListener("click", applyPromoCode);
            }
            
            // Enter key for promo code
            const promoInput = document.getElementById("promoCode");
            if (promoInput) {
                promoInput.addEventListener("keypress", function(e) {
                    if (e.key === "Enter") {
                        applyPromoCode();
                    }
                });
            }
            
            // Shipping method change
            document.querySelectorAll('input[name="shipping"]').forEach(radio => {
                radio.addEventListener("change", updateShippingCost);
            });
            
            // Form validation on blur
            const formFields = ['email', 'firstName', 'lastName', 'address', 'city', 'zipCode', 'country', 'phone'];
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener("blur", () => validateField(fieldId));
                }
            });
            
            // Modal close buttons
            const closeReceiptBtn = document.getElementById("closeReceiptBtn");
            if (closeReceiptBtn) {
                closeReceiptBtn.addEventListener("click", closeReceiptModal);
            }
            
            const closeReceiptIcon = document.getElementById("closeReceipt");
            if (closeReceiptIcon) {
                closeReceiptIcon.addEventListener("click", closeReceiptModal);
            }
            
            // Click outside modal to close
            const receiptModal = document.getElementById("receiptModal");
            if (receiptModal) {
                receiptModal.addEventListener("click", function(e) {
                    if (e.target === this) {
                        closeReceiptModal();
                    }
                });
            }
        }

        // ==================== CART FUNCTIONS ====================
        function getCart() {
            const cart = localStorage.getItem("olysHairCart");
            return cart ? JSON.parse(cart) : [];
        }

        function updateCartCount() {
            const cart = getCart();
            const itemCount = cart.reduce((total, item) => total + (item.quantity || 1), 0);
            
            const cartCountElement = document.querySelector('.cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = itemCount;
                cartCountElement.style.display = itemCount > 0 ? 'flex' : 'none';
            }
        }

        // ==================== ORDER REVIEW ====================
        async function loadOrderReview() {
            const cart = getCart();
            const orderItemsContainer = document.getElementById("orderItems");
            
            if (!orderItemsContainer) return;
            
            // Clear existing items
            orderItemsContainer.innerHTML = '';
            
            if (cart.length === 0) {
                orderItemsContainer.innerHTML = `
                    <div class="empty-cart-message">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Your cart is empty</h3>
                        <p>Add products to your cart to proceed with checkout</p>
                        <button class="btn-secondary" onclick="window.location.href='shop.html'">
                            Continue Shopping
                        </button>
                    </div>
                `;
                
                // Disable checkout
                const initiatePaymentBtn = document.getElementById("initiatePayment");
                if (initiatePaymentBtn) {
                    initiatePaymentBtn.disabled = true;
                    initiatePaymentBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Cart is Empty';
                }
                
                return;
            }
            
            // Display cart items
            let subtotal = 0;
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                orderItem.innerHTML = `
                    <div class="order-item-image">
                        <img src="${item.image || 'images/placeholder-product.jpg'}" 
                             alt="${item.name}" 
                             onerror="this.src='images/placeholder-product.jpg'">
                    </div>
                    <div class="order-item-details">
                        <h4>${item.name}</h4>
                        <p class="item-sku">SKU: ${item.sku || 'N/A'}</p>
                        <p class="order-item-price">‚Ç¨${item.price.toFixed(2)} √ó ${item.quantity}</p>
                        <p class="item-total">Total: ‚Ç¨${itemTotal.toFixed(2)}</p>
                    </div>
                `;
                orderItemsContainer.appendChild(orderItem);
            });
            
            // Calculate totals
            const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || "standard";
            const shippingCost = getShippingCost(shippingMethod);
            const tax = subtotal * CONFIG.TAX_RATE;
            const total = subtotal + shippingCost + tax - promoDiscount;
            
            // Update UI
            updateTotals(subtotal, shippingCost, tax, total);
            
            // Store current order data
            currentOrderData = {
                subtotal,
                shipping: shippingCost,
                tax,
                total,
                discount: promoDiscount,
                items: cart
            };
        }

        function updateTotals(subtotal, shipping, tax, total) {
            const subtotalEl = document.getElementById("subtotal");
            const shippingEl = document.getElementById("shipping");
            const taxEl = document.getElementById("tax");
            const totalEl = document.getElementById("total");
            const discountRow = document.getElementById("discountRow");
            const discountEl = document.getElementById("discount");
            
            if (subtotalEl) subtotalEl.textContent = `‚Ç¨${subtotal.toFixed(2)}`;
            if (shippingEl) shippingEl.textContent = `‚Ç¨${shipping.toFixed(2)}`;
            if (taxEl) taxEl.textContent = `‚Ç¨${tax.toFixed(2)}`;
            if (totalEl) totalEl.textContent = `‚Ç¨${total.toFixed(2)}`;
            
            // Show/hide discount row
            if (promoDiscount > 0) {
                discountRow.style.display = 'flex';
                discountEl.textContent = `-‚Ç¨${promoDiscount.toFixed(2)}`;
            } else {
                discountRow.style.display = 'none';
            }
        }

        function updateShippingCost() {
            if (!currentOrderData) return;
            
            const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || "standard";
            const shippingCost = getShippingCost(shippingMethod);
            
            currentOrderData.shipping = shippingCost;
            currentOrderData.total = currentOrderData.subtotal + shippingCost + currentOrderData.tax - promoDiscount;
            
            updateTotals(
                currentOrderData.subtotal,
                currentOrderData.shipping,
                currentOrderData.tax,
                currentOrderData.total
            );
        }

        function getShippingCost(method) {
            const shippingRates = {
                standard: 9.99,
                express: 19.99,
                overnight: 29.99
            };
            return shippingRates[method] || shippingRates.standard;
        }

        // ==================== FORM VALIDATION ====================
        function validateField(fieldId) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(`${fieldId}-error`);
            
            if (!field || !errorElement) return true;
            
            let isValid = true;
            let errorMessage = "";
            
            const value = field.value.trim();
            
            switch(fieldId) {
                case "email":
                    if (!value) {
                        isValid = false;
                        errorMessage = "Email is required";
                    } else if (!isValidEmail(value)) {
                        isValid = false;
                        errorMessage = "Please enter a valid email address";
                    }
                    break;
                    
                case "firstName":
                case "lastName":
                    if (!value) {
                        isValid = false;
                        errorMessage = "This field is required";
                    } else if (value.length < 2) {
                        isValid = false;
                        errorMessage = "Must be at least 2 characters";
                    }
                    break;
                    
                case "phone":
                    if (!value) {
                        isValid = false;
                        errorMessage = "Phone number is required";
                    } else if (!isValidPhone(value)) {
                        isValid = false;
                        errorMessage = "Please enter a valid phone number";
                    }
                    break;
                    
                case "country":
                    if (!value) {
                        isValid = false;
                        errorMessage = "Please select a country";
                    }
                    break;
                    
                default:
                    if (!value) {
                        isValid = false;
                        errorMessage = "This field is required";
                    }
            }
            
            // Update UI
            if (isValid) {
                field.classList.remove("error");
                field.classList.add("success");
                errorElement.textContent = "";
            } else {
                field.classList.remove("success");
                field.classList.add("error");
                errorElement.textContent = errorMessage;
            }
            
            return isValid;
        }

        function validateCheckoutForm() {
            const requiredFields = [
                'email', 'firstName', 'lastName', 
                'address', 'city', 'zipCode', 'country', 'phone'
            ];
            
            let isValid = true;
            
            // Validate all fields
            requiredFields.forEach(fieldId => {
                if (!validateField(fieldId)) {
                    isValid = false;
                }
            });
            
            // Check cart
            const cart = getCart();
            if (cart.length === 0) {
                showNotification("Your cart is empty", "error");
                isValid = false;
            }
            
            return isValid;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function isValidPhone(phone) {
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            return phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ""));
        }

        // ==================== PAYMENT FLOW ====================
        function handlePlaceOrderClick() {
            console.log("üõí Place Order clicked");
            
            // Validate form
            if (!validateCheckoutForm()) {
                showNotification("Please fix errors in the form", "error");
                
                // Scroll to first error
                const firstError = document.querySelector(".form-control.error");
                if (firstError) {
                    firstError.scrollIntoView({ behavior: "smooth", block: "center" });
                }
                
                return;
            }
            
            // Prepare order data
            const formData = getFormData();
            orderPayload = buildOrderPayload(formData);
            
            // Show payment selection
            const paymentSelection = document.getElementById("paymentSelection");
            if (paymentSelection) {
                paymentSelection.classList.add("active");
                paymentSelection.scrollIntoView({ behavior: "smooth", block: "center" });
            }
            
            // Update button state
            const initiatePaymentBtn = document.getElementById("initiatePayment");
            if (initiatePaymentBtn) {
                initiatePaymentBtn.disabled = true;
                initiatePaymentBtn.innerHTML = '<i class="fas fa-check"></i> Ready for Payment';
                initiatePaymentBtn.classList.add("processing");
            }
            
            showNotification("Please select your payment method", "info");
            updateCheckoutSteps("payment");
        }

        function selectPaymentMethod(method) {
            console.log(`üí∞ Selected payment method: ${method}`);
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll(".payment-option").forEach(opt => {
                opt.classList.remove("selected");
            });
            
            const selectedOption = document.querySelector(`.payment-option[data-method="${method}"]`);
            if (selectedOption) {
                selectedOption.classList.add("selected");
            }
            
            // Hide all processors
            document.querySelectorAll(".payment-processor").forEach(proc => {
                proc.classList.remove("active");
            });
            
            // Show processing indicator
            const processingIndicator = document.getElementById("paymentProcessing");
            if (processingIndicator) {
                processingIndicator.classList.add("active");
            }
            
            // Handle different payment methods
            switch(method) {
                case 'paypal':
                    initializePayPalPayment();
                    break;
                case 'credit-card':
                    // Show credit card form
                    document.getElementById("creditCardProcessor").classList.add("active");
                    if (processingIndicator) processingIndicator.classList.remove("active");
                    break;
                default:
                    if (processingIndicator) processingIndicator.classList.remove("active");
                    showNotification(`${method} payment would be processed here`, "info");
            }
        }

        // ==================== PAYMENT METHODS ====================
        function initializeStripe() {
            if (CONFIG.STRIPE_PUBLISHABLE_KEY && CONFIG.STRIPE_PUBLISHABLE_KEY.includes('pk_')) {
                stripe = Stripe(CONFIG.STRIPE_PUBLISHABLE_KEY);
                elements = stripe.elements();
                
                const cardElementContainer = document.getElementById('card-element');
                if (elements && cardElementContainer) {
                    cardElement = elements.create('card', {
                        style: {
                            base: {
                                fontSize: '16px',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'),
                                fontFamily: '"Montserrat", sans-serif',
                                '::placeholder': {
                                    color: '#aab7c4'
                                }
                            }
                        }
                    });
                    
                    cardElement.mount('#card-element');
                    
                    // Handle card errors
                    cardElement.on('change', function(event) {
                        const displayError = document.getElementById('card-errors');
                        if (event.error) {
                            displayError.textContent = event.error.message;
                            displayError.style.display = 'block';
                        } else {
                            displayError.textContent = '';
                            displayError.style.display = 'none';
                        }
                    });
                }
            }
        }

        function initializePayPalPayment() {
            const container = document.getElementById('paypal-button-container');
            if (!container) return;
            
            // Clear container
            container.innerHTML = '';
            
            // Hide processing indicator
            const processingIndicator = document.getElementById("paymentProcessing");
            if (processingIndicator) {
                processingIndicator.classList.remove("active");
            }
            
            // Show PayPal processor
            document.getElementById("paypalProcessor").classList.add("active");
            
            // Render PayPal buttons
            if (typeof paypal !== 'undefined') {
                paypalButtons = paypal.Buttons({
                    style: {
                        layout: 'vertical',
                        color: 'gold',
                        shape: 'rect',
                        label: 'paypal',
                        height: 55
                    },
                    
                    createOrder: async function(data, actions) {
                        console.log("üîÑ Creating PayPal order...");
                        
                        try {
                            showLoading(true, "Creating PayPal order...");
                            
                            // Create order on your backend
                            const response = await fetch(`${CONFIG.API_BASE_URL}/payments/paypal/create-order`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                },
                                body: JSON.stringify(orderPayload)
                            });
                            
                            if (!response.ok) {
                                const error = await response.json();
                                throw new Error(error.message || 'Failed to create order');
                            }
                            
                            const result = await response.json();
                            console.log("‚úÖ PayPal order created:", result.id);
                            
                            showLoading(false);
                            return result.id;
                            
                        } catch (error) {
                            console.error("‚ùå PayPal createOrder error:", error);
                            showLoading(false);
                            showNotification(error.message || "Failed to create PayPal order", "error");
                            throw error;
                        }
                    },
                    
                    onApprove: async function(data, actions) {
                        console.log("‚úÖ PayPal order approved:", data.orderID);
                        
                        try {
                            showLoading(true, "Processing PayPal payment...");
                            
                            // Capture payment on your backend
                            const response = await fetch(`${CONFIG.API_BASE_URL}/payments/paypal/capture/${data.orderID}`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                }
                            });
                            
                            if (!response.ok) {
                                const error = await response.json();
                                throw new Error(error.message || 'Payment capture failed');
                            }
                            
                            const result = await response.json();
                            console.log("‚úÖ PayPal payment captured:", result);
                            
                            // Handle successful payment
                            await handlePaymentSuccess({
                                transactionId: result.transactionId,
                                method: 'paypal',
                                amount: orderPayload.amount,
                                orderId: data.orderID
                            }, getFormData(), data.orderID);
                            
                            showLoading(false);
                            
                        } catch (error) {
                            console.error("‚ùå PayPal onApprove error:", error);
                            showLoading(false);
                            showNotification(error.message || "Payment failed", "error");
                        }
                    },
                    
                    onError: function(err) {
                        console.error("‚ùå PayPal SDK error:", err);
                        showNotification("PayPal payment failed. Please try again.", "error");
                    },
                    
                    onCancel: function(data) {
                        console.log("‚ö†Ô∏è PayPal payment cancelled:", data);
                        showNotification("PayPal payment was cancelled", "warning");
                    }
                });
                
                paypalButtons.render('#paypal-button-container');
                
            } else {
                showNotification("PayPal SDK not loaded. Please refresh the page.", "error");
            }
        }

        // ==================== ORDER PROCESSING ====================
        function getFormData() {
            const shippingMethod = document.querySelector('input[name="shipping"]:checked');
            
            return {
                email: document.getElementById("email").value.trim(),
                firstName: document.getElementById("firstName").value.trim(),
                lastName: document.getElementById("lastName").value.trim(),
                address: document.getElementById("address").value.trim(),
                city: document.getElementById("city").value.trim(),
                zipCode: document.getElementById("zipCode").value.trim(),
                country: document.getElementById("country").value.trim(),
                phone: document.getElementById("phone").value.trim(),
                shippingMethod: shippingMethod ? shippingMethod.value : "standard",
                sameAsShipping: document.getElementById("sameAsShipping")?.checked ?? true
            };
        }

        function buildOrderPayload(formData) {
            const cart = getCart();
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shippingCost = getShippingCost(formData.shippingMethod);
            const taxAmount = subtotal * CONFIG.TAX_RATE;
            const total = subtotal + shippingCost + taxAmount - promoDiscount;
            
            const shippingAddress = {
                firstName: formData.firstName,
                lastName: formData.lastName,
                email: formData.email,
                address: formData.address,
                city: formData.city,
                zipCode: formData.zipCode,
                country: formData.country,
                phone: formData.phone
            };
            
            return {
                email: formData.email,
                guestEmail: formData.email,
                orderNumber: generateOrderNumber(),
                items: cart.map(item => ({
                    productId: item.productId || item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    image: item.image || "",
                    sku: item.sku || ""
                })),
                shippingAddress: shippingAddress,
                billingAddress: formData.sameAsShipping ? shippingAddress : {
                    firstName: document.getElementById("billingFirstName")?.value || formData.firstName,
                    lastName: document.getElementById("billingLastName")?.value || formData.lastName,
                    email: formData.email,
                    address: document.getElementById("billingAddressInput")?.value || formData.address,
                    city: document.getElementById("billingCity")?.value || formData.city,
                    zipCode: document.getElementById("billingZipCode")?.value || formData.zipCode,
                    country: document.getElementById("billingCountry")?.value || formData.country,
                    phone: formData.phone
                },
                shipping: shippingCost,
                tax: taxAmount,
                discount: promoDiscount,
                subtotal: subtotal,
                amount: total,
                currency: CONFIG.CURRENCY,
                paymentMethod: selectedPaymentMethod || 'paypal'
            };
        }

        function generateOrderNumber() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `OLYS-${timestamp}-${random}`;
        }

        async function handlePaymentSuccess(paymentResult, formData, orderId) {
            console.log("üéâ Payment successful:", paymentResult);
            
            try {
                showLoading(true, "Completing your order...");
                
                // Build complete order data
                const completeOrderData = {
                    ...orderPayload,
                    transactionId: paymentResult.transactionId,
                    paymentMethod: paymentResult.method,
                    paymentStatus: 'paid',
                    status: 'processing',
                    orderDate: new Date().toISOString(),
                    estimatedDelivery: calculateDeliveryDate(formData.shippingMethod)
                };
                
                // Save order to localStorage
                saveOrderToLocalStorage(completeOrderData);
                
                // Send confirmation email
                await sendOrderConfirmationEmail(completeOrderData, formData);
                
                // Create notification
                await createOrderNotification(completeOrderData);
                
                // Clear cart
                localStorage.removeItem("olysHairCart");
                updateCartCount();
                
                // Update UI
                updateReceiptModal(paymentResult, formData, completeOrderData);
                updateCheckoutSteps("completed");
                
                showLoading(false);
                showNotification("‚úÖ Payment successful! Order confirmed.", "success");
                
                // Show receipt modal
                setTimeout(() => {
                    const receiptModal = document.getElementById("receiptModal");
                    if (receiptModal) {
                        receiptModal.classList.add("active");
                    }
                }, 1000);
                
            } catch (error) {
                console.error("‚ùå Error in handlePaymentSuccess:", error);
                showLoading(false);
                showNotification("Order processed, but there was an error: " + error.message, "warning");
            }
        }

        // ==================== ORDER MANAGEMENT ====================
        function saveOrderToLocalStorage(orderData) {
            try {
                const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
                
                const orderWithMeta = {
                    ...orderData,
                    id: orderData.orderNumber,
                    status: 'processing',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    trackingNumber: '',
                    shippingCarrier: 'Standard Shipping'
                };
                
                orders.unshift(orderWithMeta);
                
                // Keep only last 50 orders
                if (orders.length > 50) {
                    orders.splice(50);
                }
                
                localStorage.setItem('olysHairOrders', JSON.stringify(orders));
                
                // Update order count in header
                updateOrderCount(orders.length);
                
                console.log('‚úÖ Order saved to localStorage:', orderData.orderNumber);
                
                return orderData.orderNumber;
            } catch (error) {
                console.error('‚ùå Error saving order:', error);
                throw error;
            }
        }

        function updateOrderCount(count) {
            const orderCountElement = document.querySelector('.order-count');
            if (orderCountElement) {
                orderCountElement.textContent = count;
                orderCountElement.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        async function sendOrderConfirmationEmail(orderData, formData) {
            try {
                const emailParams = {
                    to_email: formData.email,
                    to_name: `${formData.firstName} ${formData.lastName}`,
                    order_number: orderData.orderNumber,
                    order_date: new Date(orderData.orderDate).toLocaleDateString(),
                    customer_name: `${formData.firstName} ${formData.lastName}`,
                    shipping_address: `
                        ${formData.address}
                        ${formData.city}, ${formData.zipCode}
                        ${formData.country}
                    `,
                    order_items: orderData.items.map(item => `
                        ${item.name} - ‚Ç¨${item.price.toFixed(2)} √ó ${item.quantity} = ‚Ç¨${(item.price * item.quantity).toFixed(2)}
                    `).join('<br>'),
                    subtotal: `‚Ç¨${orderData.subtotal.toFixed(2)}`,
                    shipping: `‚Ç¨${orderData.shipping.toFixed(2)}`,
                    tax: `‚Ç¨${orderData.tax.toFixed(2)}`,
                    discount: promoDiscount > 0 ? `‚Ç¨${promoDiscount.toFixed(2)}` : '‚Ç¨0.00',
                    total: `‚Ç¨${orderData.amount.toFixed(2)}`,
                    estimated_delivery: orderData.estimatedDelivery,
                    payment_method: orderData.paymentMethod,
                    transaction_id: orderData.transactionId
                };
                
                await emailjs.send(
                    CONFIG.EMAILJS_SERVICE_ID,
                    CONFIG.EMAILJS_TEMPLATE_ID,
                    emailParams
                );
                
                console.log('‚úÖ Confirmation email sent');
            } catch (error) {
                console.error('‚ùå Error sending email:', error);
                // Don't throw error - we don't want email failure to block order
            }
        }

        async function createOrderNotification(orderData) {
            try {
                const notifications = JSON.parse(localStorage.getItem('olysHairNotifications')) || [];
                
                const notification = {
                    id: `notif-${Date.now()}`,
                    type: 'order',
                    title: 'üéâ Order Confirmed!',
                    message: `Your order #${orderData.orderNumber} has been placed. Total: ‚Ç¨${orderData.amount.toFixed(2)}`,
                    data: {
                        orderId: orderData.orderNumber,
                        orderData: orderData
                    },
                    read: false,
                    createdAt: new Date().toISOString(),
                    priority: 'high',
                    icon: 'fa-shopping-bag',
                    actionUrl: `customerdashboard.html?section=orders&order=${orderData.orderNumber}`,
                    actionText: 'View Order'
                };
                
                notifications.unshift(notification);
                localStorage.setItem('olysHairNotifications', JSON.stringify(notifications));
                
                console.log('üì¢ Order notification created');
            } catch (error) {
                console.error('‚ùå Error creating notification:', error);
            }
        }

        // ==================== UI UPDATES ====================
        function updateCheckoutSteps(stage) {
            const steps = document.querySelectorAll(".step");
            
            if (stage === "payment") {
                steps[0].classList.add("completed");
                steps[1].classList.add("active");
            } else if (stage === "completed") {
                steps.forEach(step => {
                    step.classList.remove("active");
                    step.classList.add("completed");
                });
            }
        }

        function updateReceiptModal(paymentResult, formData, orderData) {
            // Order number
            const orderNumberEl = document.getElementById("orderNumber");
            if (orderNumberEl) {
                orderNumberEl.textContent = `Order #${orderData.orderNumber}`;
            }
            
            // Order items
            const receiptItemsEl = document.getElementById("receipt-items");
            if (receiptItemsEl) {
                receiptItemsEl.innerHTML = '';
                
                orderData.items.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    const itemEl = document.createElement("div");
                    itemEl.className = "receipt-row";
                    itemEl.innerHTML = `
                        <span>${item.name} √ó ${item.quantity}</span>
                        <span>‚Ç¨${itemTotal.toFixed(2)}</span>
                    `;
                    receiptItemsEl.appendChild(itemEl);
                });
            }
            
            // Totals
            const receiptSubtotalEl = document.getElementById("receipt-subtotal");
            const receiptShippingEl = document.getElementById("receipt-shipping");
            const receiptTaxEl = document.getElementById("receipt-tax");
            const receiptTotalEl = document.getElementById("receipt-total");
            const receiptDiscountRow = document.getElementById("receipt-discount-row");
            const receiptDiscountEl = document.getElementById("receipt-discount");
            
            if (receiptSubtotalEl) receiptSubtotalEl.textContent = `‚Ç¨${orderData.subtotal.toFixed(2)}`;
            if (receiptShippingEl) receiptShippingEl.textContent = `‚Ç¨${orderData.shipping.toFixed(2)}`;
            if (receiptTaxEl) receiptTaxEl.textContent = `‚Ç¨${orderData.tax.toFixed(2)}`;
            if (receiptTotalEl) receiptTotalEl.textContent = `‚Ç¨${orderData.amount.toFixed(2)}`;
            
            // Discount
            if (promoDiscount > 0) {
                receiptDiscountRow.style.display = 'flex';
                receiptDiscountEl.textContent = `-‚Ç¨${promoDiscount.toFixed(2)}`;
            } else {
                receiptDiscountRow.style.display = 'none';
            }
            
            // Shipping info
            const shippingInfoEl = document.getElementById("receipt-shipping-info");
            if (shippingInfoEl) {
                shippingInfoEl.innerHTML = `
                    <p><strong>${formData.firstName} ${formData.lastName}</strong></p>
                    <p>${formData.address}</p>
                    <p>${formData.city}, ${formData.zipCode}</p>
                    <p>${formData.country.toUpperCase()}</p>
                    <p>üìû ${formData.phone}</p>
                    <p>üìß ${formData.email}</p>
                `;
            }
            
            // Delivery estimate
            const deliveryEl = document.getElementById("receipt-delivery");
            if (deliveryEl) {
                deliveryEl.textContent = orderData.estimatedDelivery;
            }
        }

        function closeReceiptModal() {
            const receiptModal = document.getElementById("receiptModal");
            if (receiptModal) {
                receiptModal.classList.remove("active");
            }
            
            // Redirect to dashboard after a delay
            setTimeout(() => {
                window.location.href = 'customerdashboard.html?section=orders';
            }, 500);
        }

        // ==================== PROMO CODE ====================
        function applyPromoCode() {
            const promoCode = document.getElementById("promoCode").value.trim().toUpperCase();
            const promoMessage = document.getElementById("promoMessage");
            
            if (!promoCode) {
                promoMessage.textContent = "Please enter a promo code";
                promoMessage.className = "promo-message error";
                return;
            }
            
            // Valid promo codes
            const validPromoCodes = {
                "SAVE10": 0.10, // 10% discount
                "OLYS20": 0.20, // 20% discount
                "WELCOME15": 0.15 // 15% discount
            };
            
            if (validPromoCodes[promoCode]) {
                const discountRate = validPromoCodes[promoCode];
                promoDiscount = currentOrderData.subtotal * discountRate;
                appliedPromoCode = promoCode;
                
                // Update totals
                currentOrderData.total = currentOrderData.subtotal + currentOrderData.shipping + currentOrderData.tax - promoDiscount;
                updateTotals(
                    currentOrderData.subtotal,
                    currentOrderData.shipping,
                    currentOrderData.tax,
                    currentOrderData.total
                );
                
                promoMessage.textContent = `Promo code applied! You saved ‚Ç¨${promoDiscount.toFixed(2)}`;
                promoMessage.className = "promo-message success";
                
                // Update order payload if it exists
                if (orderPayload) {
                    orderPayload.discount = promoDiscount;
                    orderPayload.amount = currentOrderData.total;
                }
                
                showNotification(`Promo code applied! Saved ‚Ç¨${promoDiscount.toFixed(2)}`, "success");
                
            } else {
                promoMessage.textContent = "Invalid promo code";
                promoMessage.className = "promo-message error";
                showNotification("Invalid promo code", "error");
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showNotification(message, type = "info", duration = 5000) {
            const notification = document.getElementById("notification");
            if (!notification) return;
            
            let icon = "info-circle";
            if (type === "success") icon = "check-circle";
            if (type === "error") icon = "exclamation-circle";
            if (type === "warning") icon = "exclamation-triangle";
            
            notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove("show");
            }, duration);
        }

        function showLoading(show, message = "Processing...") {
            const overlay = document.getElementById("loadingOverlay");
            const loadingText = document.getElementById("loadingText");
            
            if (!overlay) return;
            
            if (loadingText) {
                loadingText.textContent = message;
            }
            
            if (show) {
                overlay.classList.add("active");
            } else {
                overlay.classList.remove("active");
            }
        }

        function calculateDeliveryDate(shippingMethod) {
            const today = new Date();
            let deliveryDays;
            
            switch(shippingMethod) {
                case 'overnight':
                    deliveryDays = 1;
                    break;
                case 'express':
                    deliveryDays = 3;
                    break;
                default: // standard
                    deliveryDays = 7;
            }
            
            // Add business days (skip weekends)
            let daysAdded = 0;
            while (daysAdded < deliveryDays) {
                today.setDate(today.getDate() + 1);
                if (today.getDay() !== 0 && today.getDay() !== 6) {
                    daysAdded++;
                }
            }
            
            return today.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
            
            // Save preference
            const isDarkMode = document.body.classList.contains("dark-mode");
            localStorage.setItem("darkMode", isDarkMode);
        }

        // ==================== PAGE UNLOAD PROTECTION ====================
        window.addEventListener("beforeunload", function (e) {
            // Check if payment is in progress
            const isProcessing = document.getElementById("loadingOverlay")?.classList.contains("active");
            
            if (isProcessing) {
                e.preventDefault();
                e.returnValue = "You have a payment in progress. Are you sure you want to leave?";
            }
        });

        // ==================== ERROR HANDLING ====================
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showNotification('An unexpected error occurred. Please refresh the page.', 'error');
        });

        // ==================== INITIALIZE ON LOAD ====================
        console.log("üì¶ Checkout system initialized");
    </script>
</body>
</html>