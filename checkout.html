<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- ðŸ–¼ï¸ Favicon (s'affiche dans l'onglet du navigateur) -->
    <link rel="icon" type="image/png" href="/images/Logo Version Transparente-01.png">
    <!-- Optionnel pour les Ã©crans d'accueil Apple/Android -->
    <link rel="apple-touch-icon" href="/images/Logo Version Transparente-01.png">

    <!-- ðŸ” DonnÃ©es StructurÃ©es Google (affiche le logo dans les rÃ©sultats de recherche) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "url": "https://www.olyshair.com",
      "logo": "https://www.olyshair.com/images/Logo%20Version%20Transparente-01.png"
    }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OLYS HAIR - Secure Checkout</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --cream: #392625;
        --white: #ffffff;
        --dark-gray: #1e1e1e;
        --light-bg: #f8f5f2;
        --text-dark: #1e1e1e;
        --text-light: #ffffff;
        --card-bg: #ffffff;
        --shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
      }

      .dark-mode {
        --cream: #c8b4a8;
        --white: #1e1e1e;
        --dark-gray: #f8f5f2;
        --light-bg: #2d2d2d;
        --text-dark: #f8f5f2;
        --text-light: #1e1e1e;
        --card-bg: #181212;
        --shadow: 0 5px 15px rgba(182, 131, 131, 0.2);
      }

      body {
        font-family: "Montserrat", sans-serif;
        background-color: var(--white);
        color: var(--text-dark);
        overflow-x: hidden;
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      h1,
      h2,
      h3,
      h4 {
        font-family: "Playfair Display", serif;
        font-weight: 600;
        color: var(--cream);
      }

      /* Header Styles */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
        background-color: var(--white);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
      }

      .logo-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 180px;
        height: 80px;
        background-color: var(--white);
        border-radius: 10px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .logo-img-light {
        max-width: 120px;
        max-height: 50px;
        display: block;
        margin: 0 auto;
        object-fit: contain;
      }

      .logo-img-dark {
        max-width: 120px;
        max-height: 50px;
        display: none;
        margin: 0 auto;
        object-fit: contain;
        background: transparent;
      }

      .dark-mode .logo-img-light {
        display: none;
      }

      .dark-mode .logo-img-dark {
        display: block;
      }

      .nav-links {
        display: flex;
        gap: 30px;
      }

      .nav-links a {
        text-decoration: none;
        color: var(--text-dark);
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .nav-links a:hover {
        color: var(--cream);
      }

      .header-icons {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .header-icons i {
        font-size: 20px;
        color: var(--cream);
        cursor: pointer;
      }

      /* Dark/Light Mode Toggle */
      .mode-toggle {
        position: relative;
        width: 60px;
        height: 30px;
        background-color: var(--light-bg);
        border-radius: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 0 5px;
        transition: background-color 0.3s ease;
      }

      .toggle-circle {
        position: absolute;
        width: 22px;
        height: 22px;
        background-color: var(--cream);
        border-radius: 50%;
        transition: all 0.3s ease;
        left: 4px;
      }

      .dark-mode .toggle-circle {
        left: 34px;
      }

      .mode-toggle i {
        font-size: 14px;
        z-index: 2;
      }

      .fa-sun {
        color: var(--cream);
        margin-right: auto;
      }

      .fa-moon {
        color: var(--cream);
        margin-left: auto;
      }

      /* Checkout Container */
      .checkout-container {
        max-width: 1200px;
        margin: 140px auto 40px;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 40px;
      }

      /* Checkout Steps */
      .checkout-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
      }

      .checkout-steps::before {
        content: "";
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--light-bg);
        z-index: 1;
      }

      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
      }

      .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--light-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .step.active .step-circle {
        background-color: var(--cream);
        color: var(--white);
      }

      .step.completed .step-circle {
        background-color: var(--success);
        color: var(--white);
      }

      .step-label {
        font-size: 14px;
        font-weight: 500;
      }

      /* Checkout Sections */
      .checkout-section {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
      }

      .section-title {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--light-bg);
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--cream);
      }

      .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--light-bg);
        border-radius: 8px;
        background-color: var(--card-bg);
        color: var(--text-dark);
        font-family: "Montserrat", sans-serif;
        transition: border-color 0.3s;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--cream);
      }

      .form-control.error {
        border-color: var(--error);
      }

      .form-control.success {
        border-color: var(--success);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      /* Payment Methods */
      .payment-methods {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 20px;
      }

      .payment-method {
        border: 1px solid var(--light-bg);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .payment-method:hover,
      .payment-method.active {
        border-color: var(--cream);
        background-color: var(--light-bg);
      }

      .payment-method.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .payment-method i {
        font-size: 24px;
        margin-bottom: 10px;
        color: var(--cream);
      }

      /* Stripe Card Element */
      #card-element {
        padding: 12px 15px;
        border: 1px solid var(--light-bg);
        border-radius: 8px;
        background-color: var(--card-bg);
      }

      .StripeElement--focus {
        border-color: var(--cream);
        box-shadow: 0 0 0 1px var(--cream);
      }

      .StripeElement--invalid {
        border-color: var(--error);
      }

      .StripeElement--complete {
        border-color: var(--success);
      }

      #card-errors {
        color: var(--error);
        margin-top: 8px;
        font-size: 14px;
        display: none;
      }

      /* Payment Method Specific Containers */
      .payment-form-container {
        margin-top: 20px;
      }

      #paypal-button-container,
      #apple-pay-button {
        margin-top: 15px;
        min-height: 50px;
      }

      /* Order Summary */
      .order-summary {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 30px;
        box-shadow: var(--shadow);
        position: sticky;
        top: 140px;
        height: fit-content;
      }

      .order-items {
        margin-bottom: 20px;
      }

      .order-item {
        display: flex;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--light-bg);
      }

      .order-item-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        margin-right: 15px;
      }

      .order-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .order-item-details {
        flex: 1;
      }

      .order-item-details h4 {
        margin-bottom: 5px;
      }

      .item-sku {
        font-size: 12px;
        color: #666;
        margin: 2px 0;
      }

      .order-item-price {
        color: var(--cream);
        font-weight: 600;
      }

      .item-total {
        font-weight: 600;
      }

      .order-totals {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--light-bg);
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .total-final {
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--light-bg);
      }

      /* Promo Code */
      .promo-code {
        display: flex;
        margin-top: 20px;
      }

      .promo-input {
        flex: 1;
        border-radius: 8px 0 0 8px;
      }

      .promo-btn {
        background-color: var(--cream);
        color: var(--white);
        border: none;
        border-radius: 0 8px 8px 0;
        padding: 0 20px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .promo-btn:hover {
        background-color: var(--dark-gray);
      }

      .promo-success {
        color: var(--success);
        font-size: 14px;
        margin-top: 5px;
      }

      /* Checkout Button */
      .checkout-btn {
        width: 100%;
        padding: 15px;
        background-color: var(--cream);
        color: var(--white);
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }

      .checkout-btn:hover {
        background-color: var(--dark-gray);
      }

      .checkout-btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      /* Security Badges */
      .security-badges {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
      }

      .security-badge {
        font-size: 12px;
        color: #666;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* Floating Bubbles */
      .floating-bubbles {
        position: fixed;
        right: 30px;
        bottom: 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 1200;
      }

      .bubble-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--cream);
        color: var(--white);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 22px;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .bubble-btn span {
        display: none;
        position: absolute;
        right: 70px;
        background: var(--dark-gray);
        color: var(--white);
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 14px;
        white-space: nowrap;
      }

      .bubble-btn:hover {
        background-color: var(--dark-gray);
        transform: scale(1.1);
      }

      .bubble-btn:hover span {
        display: block;
      }

      /* Receipt Modal */
      .receipt-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .receipt-modal.active {
        opacity: 1;
        visibility: visible;
      }

      .receipt-content {
        background-color: var(--card-bg);
        border-radius: 10px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 30px;
        box-shadow: var(--shadow);
        position: relative;
      }

      .receipt-close {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: var(--cream);
        color: var(--white);
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 10;
      }

      .receipt-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--light-bg);
      }

      .receipt-details {
        margin-bottom: 20px;
      }

      .receipt-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .receipt-total {
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--light-bg);
      }

      .receipt-actions {
        display: flex;
        gap: 10px;
        margin-top: 30px;
      }

      .receipt-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s;
      }

      .receipt-print {
        background-color: var(--cream);
        color: var(--white);
      }

      .receipt-print:hover {
        background-color: var(--dark-gray);
      }

      .receipt-close-btn {
        background-color: var(--light-bg);
        color: var(--text-dark);
      }

      .receipt-close-btn:hover {
        background-color: #e0e0e0;
      }

      /* Notification System */
      .notification {
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1500;
        transform: translateX(120%);
        transition: transform 0.3s ease;
        max-width: 350px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background-color: var(--success);
      }

      .notification.error {
        background-color: var(--error);
      }

      .notification.warning {
        background-color: var(--warning);
      }

      .notification.info {
        background-color: var(--cream);
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1900;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--cream);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Enhanced Styles */
      .empty-cart-message {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-dark);
      }

      .empty-cart-message i {
        font-size: 48px;
        color: var(--cream);
        margin-bottom: 20px;
      }

      .btn-primary {
        background-color: var(--cream);
        color: var(--white);
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-top: 15px;
      }

      .field-error {
        color: var(--error);
        font-size: 12px;
        margin-top: 5px;
        display: block;
      }

      .loading {
        opacity: 0.7;
        pointer-events: none;
      }

      .payment-status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        text-align: center;
        font-weight: 500;
      }

      .payment-status.success {
        background-color: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid var(--success);
      }

      .payment-status.error {
        background-color: rgba(239, 68, 68, 0.1);
        color: var(--error);
        border: 1px solid var(--error);
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .checkout-container {
          grid-template-columns: 1fr;
        }

        .order-summary {
          position: static;
          margin-top: 30px;
        }
      }

      @media (max-width: 768px) {
        header {
          padding: 15px 20px;
        }

        .checkout-container {
          margin-top: 120px;
          padding: 0 15px;
        }

        .checkout-steps {
          flex-wrap: wrap;
          gap: 15px;
        }

        .step {
          flex: 1;
          min-width: 100px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .payment-methods {
          grid-template-columns: 1fr;
        }

        .floating-bubbles {
          bottom: 80px;
        }

        .bubble-btn span {
          right: 65px;
          bottom: 0;
        }
      }

      @media (max-width: 480px) {
        .checkout-section {
          padding: 20px 15px;
        }

        .order-summary {
          padding: 20px 15px;
        }
      }
      /* Add to header icons section */
.cart-count, .order-count, .booking-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: var(--error);
    color: white;
    font-size: 10px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    display: none; /* Hidden by default */
}

.cart-bubble, .order-tracking-bubble {
    position: relative;
    cursor: pointer;
}
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="logo-container">
        <span>
          <img
            src="images/Logo Version Transparente-01.png"
            alt="OLYS HAIR Logo"
            class="logo-img-light"
          />
          <img
            src="images/logo-bright.png"
            alt="OLYS HAIR Logo Bright"
            class="logo-img-dark"
          />
        </span>
      </div>
      <div class="nav-links">
        <a href="shop.html">Shop</a>
        <a href="contact.html">Contact</a>
      </div>
      <div class="header-icons">
        <i class="fas fa-search"></i>
        <div class="cart-bubble">
          <i class="fas fa-shopping-bag"></i>
          <span class="cart-count"></span>
        </div>
        <i class="fas fa-user"></i>
        <div class="mode-toggle">
          <i class="fas fa-sun"></i>
          <i class="fas fa-moon"></i>
          <div class="toggle-circle"></div>
        </div>
      </div>
    </header>

    <!-- Checkout Container -->
    <div class="checkout-container">
      <!-- Checkout Form -->
      <div class="checkout-form">
        <!-- Checkout Steps -->
        <div class="checkout-steps">
          <div class="step active">
            <div class="step-circle">1</div>
            <div class="step-label">Shipping</div>
          </div>
          <div class="step">
            <div class="step-circle">2</div>
            <div class="step-label">Payment</div>
          </div>
          <div class="step">
            <div class="step-circle">3</div>
            <div class="step-label">Confirmation</div>
          </div>
        </div>

        <!-- Shipping Information -->
        <div class="checkout-section">
          <h2 class="section-title">Shipping Information</h2>

          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              class="form-control"
              placeholder="your@email.com"
              required
            />
            <div class="field-error" id="email-error"></div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input
                type="text"
                id="firstName"
                class="form-control"
                placeholder="First Name"
                required
              />
              <div class="field-error" id="firstName-error"></div>
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input
                type="text"
                id="lastName"
                class="form-control"
                placeholder="Last Name"
                required
              />
              <div class="field-error" id="lastName-error"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="address">Address</label>
            <input
              type="text"
              id="address"
              class="form-control"
              placeholder="Street Address"
              required
            />
            <div class="field-error" id="address-error"></div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="city">City</label>
              <input
                type="text"
                id="city"
                class="form-control"
                placeholder="City"
                required
              />
              <div class="field-error" id="city-error"></div>
            </div>
            <div class="form-group">
              <label for="zipCode">ZIP/Postal Code</label>
              <input
                type="text"
                id="zipCode"
                class="form-control"
                placeholder="ZIP Code"
                required
              />
              <div class="field-error" id="zipCode-error"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="country">Country</label>
              <select id="country" class="form-control" required>
                <option value="">Select Country</option>
                <option value="us">United States</option>
                <option value="uk">United Kingdom</option>
                <option value="fr">France</option>
                <option value="de">Germany</option>
                <option value="ch">Switzerland</option>
              </select>
              <div class="field-error" id="country-error"></div>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input
                type="tel"
                id="phone"
                class="form-control"
                placeholder="Phone Number"
                required
              />
              <div class="field-error" id="phone-error"></div>
            </div>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="saveAddress" />
              Save this address for future orders
            </label>
          </div>
        </div>

        <!-- Shipping Method -->
        <div class="checkout-section">
          <h2 class="section-title">Shipping Method</h2>

          <div class="form-group">
            <label>
              <input type="radio" name="shipping" value="standard" checked />
              Standard Shipping (5-7 business days) - â‚¬1.00
            </label>
          </div>

          <div class="form-group">
            <label>
              <input type="radio" name="shipping" value="express" />
              Express Shipping (2-3 business days) - â‚¬19.99
            </label>
          </div>

          <div class="form-group">
            <label>
              <input type="radio" name="shipping" value="overnight" />
              Overnight Shipping (1 business day) - â‚¬29.99
            </label>
          </div>
        </div>

        <!-- Payment Method -->
        <div class="checkout-section">
          <h2 class="section-title">Payment Method</h2>

          <div class="payment-methods">
            <div class="payment-method active" data-method="credit-card">
              <i class="fab fa-cc-visa"></i>
              <div>Credit Card</div>
            </div>
            <div class="payment-method" data-method="paypal">
              <i class="fab fa-paypal"></i>
              <div>PayPal</div>
            </div>
           <!-- <div class="payment-method" data-method="apple-pay">
              <i class="fab fa-apple-pay"></i>
              <div>Apple Pay</div>
            </div>-->
           <!-- <div class="payment-method" data-method="klarna">
              <i class="fas fa-credit-card"></i>
              <div>Klarna</div>
            </div>-->
          </div>

          <!-- Credit Card Form (Stripe) -->
          <div class="payment-form-container" id="credit-card-form">
            <div class="form-group">
              <label for="cardName">Name on Card</label>
              <input
                type="text"
                id="cardName"
                class="form-control"
                placeholder="Full Name"
                required
              />
              <div class="field-error" id="cardName-error"></div>
            </div>

            <div class="form-group">
              <label for="card-element">Card Details</label>
              <div id="card-element" class="form-control">
                <!-- Stripe Elements will be inserted here -->
              </div>
              <div id="card-errors" role="alert"></div>
            </div>
          </div>

          <!-- PayPal Button Container -->
          <div
            class="payment-form-container"
            id="paypal-button-container"
            style="display: none"
          ></div>

          <!-- Apple Pay Button Container -->
          <div
            class="payment-form-container"
            id="apple-pay-button"
            style="display: none"
          ></div>

          <!-- Klarna Payment Container -->
          <div
            class="payment-form-container"
            id="klarna-payment-form"
            style="display: none"
          >
            <p>You will be redirected to Klarna to complete your payment.</p>
          </div>
        </div>

        <!-- Billing Address -->
        <div class="checkout-section">
          <h2 class="section-title">Billing Address</h2>

          <div class="form-group">
            <label>
              <input type="checkbox" id="sameAsShipping" checked />
              Same as shipping address
            </label>
          </div>

          <div id="billingAddressFields" style="display: none">
            <div class="form-row">
              <div class="form-group">
                <label for="billingFirstName">First Name</label>
                <input
                  type="text"
                  id="billingFirstName"
                  class="form-control"
                  placeholder="First Name"
                />
              </div>
              <div class="form-group">
                <label for="billingLastName">Last Name</label>
                <input
                  type="text"
                  id="billingLastName"
                  class="form-control"
                  placeholder="Last Name"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="billingAddressInput">Address</label>
              <input
                type="text"
                id="billingAddressInput"
                class="form-control"
                placeholder="Street Address"
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="billingCity">City</label>
                <input
                  type="text"
                  id="billingCity"
                  class="form-control"
                  placeholder="City"
                />
              </div>
              <div class="form-group">
                <label for="billingZipCode">ZIP/Postal Code</label>
                <input
                  type="text"
                  id="billingZipCode"
                  class="form-control"
                  placeholder="ZIP Code"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="billingCountry">Country</label>
              <select id="billingCountry" class="form-control">
                <option value="">Select Country</option>
                <option value="us">United States</option>
                <option value="uk">United Kingdom</option>
                <option value="fr">France</option>
                <option value="de">Germany</option>
                <option value="ch">Switzerland</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h2 class="section-title">Order Summary</h2>

        <div class="order-items">
          <!-- Order items will be populated by JavaScript -->
        </div>

        <div class="promo-code">
          <input
            type="text"
            class="form-control promo-input"
            placeholder="Promo Code"
            id="promoCode"
          />
          <button class="promo-btn" id="applyPromo">Apply</button>
        </div>
        <div id="promo-message"></div>

        <div class="order-totals">
          <div class="total-row">
            <span>Subtotal</span>
            <span id="subtotal">â‚¬0.00</span>
          </div>
          <div class="total-row">
            <span>Shipping</span>
            <span id="shipping">â‚¬0.00</span>
          </div>
          <div class="total-row">
            <span>Tax</span>
            <span id="tax">â‚¬0.00</span>
          </div>
          <div class="total-row total-final">
            <span>Total</span>
            <span id="total">â‚¬0.00</span>
          </div>
        </div>

        <button class="checkout-btn" id="placeOrder">
          <i class="fas fa-lock"></i> Place Order
        </button>

        <div class="security-badges">
          <div class="security-badge">
            <i class="fas fa-lock"></i> Secure Checkout
          </div>
          <div class="security-badge">
            <i class="fas fa-shield-alt"></i> SSL Encrypted
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Bubbles -->
    <div class="floating-bubbles">
      <div class="bubble-btn" onclick="window.location.href='index.html'">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </div>
      <div class="bubble-btn" onclick="window.location.href='shop.html'">
        <i class="fas fa-shopping-bag"></i>
        <span>Shop</span>
      </div>
      <div
        class="bubble-btn"
        onclick="window.location.href='customerdashboard.html'"
      >
        <i class="fas fa-user"></i>
        <span>Account</span>
      </div>
    </div>

    <!-- Receipt Modal -->
    <div class="receipt-modal" id="receiptModal">
      <div class="receipt-content">
        <div class="receipt-close">
          <i class="fas fa-times"></i>
        </div>

        <div class="receipt-header">
          <h2>Order Confirmation</h2>
          <p>Thank you for your purchase!</p>
          <p id="orderNumber">Order #OL-123456</p>
        </div>

        <div class="receipt-details">
          <h3>Order Details</h3>
          <div id="receipt-items">
            <!-- Receipt items will be populated by JavaScript -->
          </div>
          <div class="receipt-row">
            <span>Subtotal</span>
            <span id="receipt-subtotal">â‚¬0.00</span>
          </div>
          <div class="receipt-row">
            <span>Shipping</span>
            <span id="receipt-shipping">â‚¬0.00</span>
          </div>
          <div class="receipt-row">
            <span>Tax</span>
            <span id="receipt-tax">â‚¬0.00</span>
          </div>
          <div class="receipt-row receipt-total">
            <span>Total</span>
            <span id="receipt-total">â‚¬0.00</span>
          </div>
        </div>

        <div class="receipt-details">
          <h3>Shipping Information</h3>
          <div id="receipt-shipping-info">
            <!-- Shipping info will be populated by JavaScript -->
          </div>
        </div>

        <div class="receipt-details">
          <h3>Estimated Delivery</h3>
          <p id="receipt-delivery">5-7 business days</p>
        </div>

        <div class="receipt-actions">
          <button class="receipt-btn receipt-print">
            <i class="fas fa-print"></i> Print Receipt
          </button>
          <button class="receipt-btn receipt-close-btn">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
      </div>
    </div>

    <!-- Notification System -->
    <div class="notification" id="notification"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=Afdo7xRdDvUKhixkahcnYo27-SmAYrZQgvuZSPATxitvw__sm4A5ZWHtresK_n-UrywV8pCBmuqpRGqg&currency=EUR"></script>
<!--<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>-->
 
<script>

// Update the handlePaymentSuccess function in checkout.html:
async function handlePaymentSuccess(paymentResult, formData, orderId) {
    try {
        // Get cart data
        const cart = getCart();
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = getShippingCost(formData.shippingMethod);
        const tax = subtotal * CONFIG.TAX_RATE;
        const total = subtotal + shipping + tax;
        
        // Generate order number
        const orderNumber = orderId || `ORD-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        
        // Prepare order data for email
        const orderData = {
            orderNumber: orderNumber,
            customerName: `${formData.firstName} ${formData.lastName}`,
            customerEmail: formData.email,
            customerPhone: formData.phone,
            shippingAddress: `${formData.address}, ${formData.city}, ${formData.zipCode}, ${formData.country}`,
            billingAddress: formData.sameAsShipping ? 
                `${formData.address}, ${formData.city}, ${formData.zipCode}, ${formData.country}` :
                `${formData.billing.address}, ${formData.billing.city}, ${formData.billing.zipCode}, ${formData.billing.country}`,
            orderDate: new Date().toISOString(),
            items: cart.map(item => ({
                name: item.name,
                quantity: item.quantity,
                price: item.price,
                total: item.price * item.quantity
            })),
            subtotal: subtotal,
            shippingCost: shipping,
            taxAmount: tax,
            totalAmount: total,
            paymentMethod: selectedPaymentMethod === 'credit-card' ? 'Credit Card' : 
                         selectedPaymentMethod === 'paypal' ? 'PayPal' : selectedPaymentMethod,
            status: 'processing',
            transactionId: paymentResult.transactionId || paymentResult.orderID || 'N/A'
        };
        
        // Save order to localStorage
        saveOrderToLocalStorage(orderData);
        
        // Send confirmation emails via backend
        const emailResponse = await fetch(`${CONFIG.API_BASE_URL}/email/order-confirmation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({
                orderData: orderData,
                customerEmail: formData.email,
                adminEmail: 'shop@olyshair.com'
            })
        });
        
        const emailResult = await emailResponse.json();
        
        if (!emailResult.success) {
            console.warn('Email sending had issues:', emailResult);
            // Continue with order even if email fails
        }
        
        // Clear cart after successful order
        localStorage.removeItem("olysHairCart");
        updateCartCount();
        
        // Update receipt modal
        updateReceiptModal(paymentResult, formData);
        updateCheckoutSteps("completed");
        
        showNotification("âœ… Order confirmed! A confirmation email has been sent.", "success");
        
        setTimeout(() => {
            const receiptModal = document.getElementById("receiptModal");
            if (receiptModal) receiptModal.classList.add("active");
        }, 1000);
        
    } catch (error) {
        console.error("Order processing error:", error);
        // Still show success but warn about email
        showNotification("Order processed, but email sending failed: " + error.message, "warning");
    }
}
// Function to save order to localStorage
function saveOrderToLocalStorage(orderData) {
    try {
        const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
        
        const orderWithMeta = {
            ...orderData,
            status: 'processing',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        orders.push(orderWithMeta);
        localStorage.setItem('olysHairOrders', JSON.stringify(orders));
        
        // Update order count in header
        updateOrderCount(orders.length);
        
        return orderData.order_number;
    } catch (error) {
        console.error('Error saving order to localStorage:', error);
        throw error;
    }
}

// Function to update order count in header
function updateOrderCount(count) {
    const orderCountElement = document.querySelector('.order-count');
    if (orderCountElement) {
        orderCountElement.textContent = count;
        orderCountElement.style.display = count > 0 ? 'flex' : 'none';
    }
}

// Function to update cart count in header
function updateCartCount() {
    const cartCountElement = document.querySelector('.cart-count');
    if (cartCountElement) {
        const cart = JSON.parse(localStorage.getItem('olysHairCart')) || [];
        const itemCount = cart.reduce((total, item) => total + (item.quantity || 1), 0);
        cartCountElement.textContent = itemCount;
        cartCountElement.style.display = itemCount > 0 ? 'flex' : 'none';
    }
}
    function checkAuthentication() {
    const token = localStorage.getItem("token");
    const user = localStorage.getItem("user");
    
    if (!token || !user) {
        // User is not logged in
        showNotification("Please sign in to access checkout", "error");
        
        // Save any cart data from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const directPurchase = urlParams.get('direct');
        
        if (directPurchase === 'true') {
            localStorage.setItem("checkoutRedirect", "true");
        }
        
        // Redirect to sign-in page
        setTimeout(() => {
            window.location.href = "sign-in.html?redirect=checkout";
        }, 2000);
        return false;
    }
    
    // Parse user data
    try {
        const userData = JSON.parse(user);
        console.log('âœ… User authenticated:', userData.email);
        return true;
    } catch (e) {
        console.error('Error parsing user data:', e);
        return false;
    }
}
function handleDirectPurchase() {
    const urlParams = new URLSearchParams(window.location.search);
    const isDirect = urlParams.get('direct') === 'true';
    
    if (isDirect) {
        const directPurchase = localStorage.getItem('olysHairDirectPurchase');
        
        if (directPurchase) {
            try {
                const directCart = JSON.parse(directPurchase);
                
                if (Array.isArray(directCart) && directCart.length > 0) {
                    // Use the direct purchase cart instead of regular cart
                    localStorage.setItem('olysHairCart', JSON.stringify(directCart));
                    
                    // Clear the direct purchase flag after use
                    localStorage.removeItem('olysHairDirectPurchase');
                    
                    console.log('âœ… Direct purchase loaded:', directCart);
                }
            } catch (error) {
                console.error('Error parsing direct purchase:', error);
            }
        }
    }
}

// Dynamic API URL configuration
// ==================== ENHANCED CONFIGURATION ====================
/* checkout.js - rewritten frontend checkout logic (replace the large inline script) */

/* CONFIG (keep your existing values or adjust) */
const CONFIG = {
  STRIPE_PUBLISHABLE_KEY: "pk_test_51SAVVd3tLr6waZvCb40vB1OfO3ZOX8EU1htFN8HNdu3kURHsNoP6K5rkTx7vUMu9TNbXONzrc2bRjk3NNS5Y92NQ00uSJr71I0",
  PAYPAL_CLIENT_ID: "Afdo7xRdDvUKhixkahcnYo27-SmAYrZQgvuZSPATxitvw__sm4A5ZWHtresK_n-UrywV8pCBmuqpRGqg",
  API_BASE_URL: "https://olyshairi-e-commerce-hairspo-online-kgz2.onrender.com/api",
  CURRENCY: "EUR",
  TAX_RATE: 0.08
};

/* Globals */
let stripe = null;
let elements = null;
let cardElement = null;
let selectedPaymentMethod = "credit-card";
let currentOrderData = null;
let appliedPromoCode = null;

/* ------------------------ Utilities ------------------------ */
function getAuthToken() {
  return localStorage.getItem('authToken') || document.cookie.match(/authToken=([^;]+)/)?.[1] || null;
}

function showNotification(message, type = "info", duration = 5000) {
  const n = document.getElementById("notification");
  if (!n) return;
  let icon = "info-circle";
  if (type === "success") icon = "check-circle";
  if (type === "error") icon = "exclamation-circle";
  if (type === "warning") icon = "exclamation-triangle";
  n.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
  n.className = `notification ${type} show`;
  setTimeout(()=> n.classList.remove("show"), duration);
}

function showLoading(show) {
  const overlay = document.getElementById("loadingOverlay");
  if (!overlay) return;
  overlay.classList.toggle("active", !!show);
}

function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

function isValidPhone(phone) { return /^[\+]?[1-9][\d]{0,15}$/.test(phone.replace(/[\s\-\(\)]/g, "")); }

function generateOrderNumber() {
  return 'OL-' + Date.now();
}

/* ------------------------ Form helpers ------------------------ */
function getFormData() {
  const shippingMethod = document.querySelector('input[name="shipping"]:checked');
  return {
    email: document.getElementById("email")?.value?.trim() || "",
    firstName: document.getElementById("firstName")?.value?.trim() || "",
    lastName: document.getElementById("lastName")?.value?.trim() || "",
    address: document.getElementById("address")?.value?.trim() || "",
    city: document.getElementById("city")?.value?.trim() || "",
    zipCode: document.getElementById("zipCode")?.value?.trim() || "",
    country: document.getElementById("country")?.value?.trim() || "",
    phone: document.getElementById("phone")?.value?.trim() || "",
    cardName: document.getElementById("cardName")?.value?.trim() || "",
    shippingMethod: shippingMethod ? shippingMethod.value : "standard",
    sameAsShipping: document.getElementById("sameAsShipping")?.checked ?? true,
    billing: {
      firstName: document.getElementById("billingFirstName")?.value?.trim() || "",
      lastName: document.getElementById("billingLastName")?.value?.trim() || "",
      address: document.getElementById("billingAddressInput")?.value?.trim() || "",
      city: document.getElementById("billingCity")?.value?.trim() || "",
      zipCode: document.getElementById("billingZipCode")?.value?.trim() || "",
      country: document.getElementById("billingCountry")?.value?.trim() || ""
    }
  };
}

/* ------------------------ Cart & totals ------------------------ */
function getCart() {
  return JSON.parse(localStorage.getItem("olysHairCart")) || [];
}

function updateTotals(subtotal, shipping, taxRate) {
  const tax = subtotal * taxRate;
  const total = subtotal + shipping + tax;
  const discount = appliedPromoCode ? subtotal * 0.1 : 0;
  const finalTotal = total - discount;

  const elSubtotal = document.getElementById("subtotal");
  const elShipping = document.getElementById("shipping");
  const elTax = document.getElementById("tax");
  const elTotal = document.getElementById("total");

  if (elSubtotal) elSubtotal.textContent = `â‚¬${subtotal.toFixed(2)}`;
  if (elShipping) elShipping.textContent = `â‚¬${shipping.toFixed(2)}`;
  if (elTax) elTax.textContent = `â‚¬${tax.toFixed(2)}`;
  if (elTotal) elTotal.textContent = `â‚¬${finalTotal.toFixed(2)}`;

  currentOrderData = {
    subtotal,
    shipping,
    tax,
    total: finalTotal,
    discount,
    items: getCart()
  };
}

/* Build items array for backend - enforce productId presence */
function buildItemsForBackend(cart) {
  // Validate that cart items have productId
  const missingIds = cart.filter(i => !(i.productId || i.id));
  if (missingIds.length > 0) {
    console.error("Cart items missing productId:", missingIds);
    throw new Error("One or more cart items are missing product IDs.");
  }

  return cart.map(i => ({
    productId: i.productId || i.id, // This will be used as the 'product' ObjectId
    name: i.name,
    price: Number(i.price || 0),
    quantity: Number(i.quantity || 1),
    image: i.image || "",
    sku: i.sku || ""
  }));
}

/* ------------------------ Order payload builder ------------------------ */
function buildOrderPayload(formData) {
  const cart = getCart();
  const itemsForBackend = buildItemsForBackend(cart);

  const subtotal = itemsForBackend.reduce((s, it) => s + (it.price * it.quantity), 0);
  const shippingCost = getShippingCost(formData.shippingMethod || "standard");
  const taxAmount = +(subtotal * CONFIG.TAX_RATE).toFixed(2);
  const discountAmount = appliedPromoCode ? +(subtotal * 0.1).toFixed(2) : 0;
  const total = +(subtotal + shippingCost + taxAmount - discountAmount).toFixed(2);

  // shippingAddress object matches your Order.addressSchema
  const shippingAddress = {
    firstName: formData.firstName,
    lastName: formData.lastName,
    email: formData.email,
    address: formData.address,
    city: formData.city,
    state: "", // optional
    zipCode: formData.zipCode,
    country: formData.country,
    phone: formData.phone
  };

  const billingAddress = formData.sameAsShipping ? { ...shippingAddress } : {
    firstName: formData.billing.firstName || formData.firstName,
    lastName: formData.billing.lastName || formData.lastName,
    email: formData.email,
    address: formData.billing.address || formData.address,
    city: formData.billing.city || formData.city,
    state: "",
    zipCode: formData.billing.zipCode || formData.zipCode,
    country: formData.billing.country || formData.country,
    phone: formData.phone
  };

  return {
    email: formData.email,
    guestEmail: formData.email,       // explicit for backend guestEmail requirement
    orderNumber: generateOrderNumber(),
    items: itemsForBackend.map(it => ({
      product: it.productId,   // REQUIRED FOR MONGODB
      name: it.name,
      price: it.price,
      quantity: it.quantity,
      image: it.image,
      sku: it.sku
    })),
    shippingAddress,
    billingAddress,
    shipping: shippingCost,
    tax: taxAmount,
    discount: discountAmount,
    subtotal: subtotal,
    amount: total,                   // total amount to charge
    currency: CONFIG.CURRENCY,
    paymentMethod: selectedPaymentMethod === 'paypal' ? 'paypal' : (selectedPaymentMethod === 'credit-card' ? 'credit_card' : selectedPaymentMethod)
  };
}
// Initialize counts on page load
function initializeCounts() {
    const cart = JSON.parse(localStorage.getItem('olysHairCart')) || [];
    const orders = JSON.parse(localStorage.getItem('olysHairOrders')) || [];
    const bookings = JSON.parse(localStorage.getItem('olysHairBookings')) || [];
    
    updateCartCount();
    updateOrderCount(orders.length);
    updateBookingCount(bookings.length);
}

document.addEventListener('DOMContentLoaded', function() {
    initializeCounts();
    // ... other initialization code
});
/* ------------------------ PayPal integration (createOrder + onApprove) ------------------------ */
function loadPayPalButton() {
  if (typeof paypal === 'undefined') {
    console.error('PayPal SDK not loaded');
    return;
  }

  const container = document.getElementById('paypal-button-container');
  if (!container) return;
  container.innerHTML = '';

  paypal.Buttons({
    style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },

    createOrder: async function(data, actions) {
      try {
        const formData = getFormData();
        // validate form before contacting server
        if (!validateCheckoutForm()) throw new Error('Please complete the checkout form first.');

        const orderPayload = buildOrderPayload(formData);

        console.log('Creating PayPal order - payload:', orderPayload);

        const response = await fetch(`${CONFIG.API_BASE_URL}/payments/paypal/create-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
          },
          body: JSON.stringify(orderPayload)
        });

        const result = await response.json();
        if (!response.ok) {
          console.error('Create order failed:', result);
          throw new Error(result.error || result.message || 'Failed to create order');
        }

        console.log('PayPal create order response:', result);
        // PayPal SDK expects the order id string
        return result.id;
      } catch (err) {
        console.error('PayPal createOrder error:', err);
        showNotification(err.message || 'Failed to create PayPal order', 'error');
        throw err;
      }
    },

    onApprove: async function(data, actions) {
      try {
        showLoading(true);
        const resp = await fetch(`${CONFIG.API_BASE_URL}/payments/paypal/capture/${data.orderID}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        });
        const result = await resp.json();
        if (!resp.ok || !result.success) {
          throw new Error(result.error || 'Payment capture failed');
        }

        console.log('PayPal capture result:', result);

        // call success handler with server result and local form data
        await handlePaymentSuccess({
          transactionId: result.transactionId,
          method: 'paypal',
          amount: currentOrderData.total,
          orderId: data.orderID
        }, getFormData(), data.orderID);

        showNotification('Payment successful!', 'success');
        showLoading(false);
      } catch (err) {
        showLoading(false);
        console.error('onApprove error:', err);
        showNotification('Payment failed: ' + (err.message || ''), 'error');
      }
    },

    onError: function(err) {
      console.error('PayPal SDK error:', err);
      showNotification('PayPal payment failed. Please try again.', 'error');
    },

    onCancel: function(data) {
      console.log('PayPal payment cancelled by user', data);
      showNotification('PayPal payment was cancelled', 'warning');
    }

  }).render('#paypal-button-container');
}

/* ------------------------ Stripe / Credit-card: send same payload shape ------------------------ */
async function createServerOrderAndReturnId(orderPayload) {
  // If you want server to always create DB order before capturing payment, call this endpoint.
  // Here we re-use /payments/paypal/create-order for shape but you can create a dedicated endpoint for Stripe.
  const resp = await fetch(`${CONFIG.API_BASE_URL}/orders/create-local`, { // optional dedicated endpoint
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getAuthToken()}` },
    body: JSON.stringify(orderPayload)
  });

  if (!resp.ok) {
    const data = await resp.json().catch(()=>({error: 'Unknown server error'}));
    throw new Error(data.error || data.message || 'Failed to create server order');
  }

  return (await resp.json());
}

/* ------------------------ Process Payment (Place Order button) ------------------------ */
async function processPayment(e) {
  e?.preventDefault?.();
  if (!validateCheckoutForm()) return;

  const submit = document.getElementById('placeOrder');
  const originalText = submit?.innerHTML || "Processing...";
  submit.disabled = true;
  submit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

  try {
    const formData = getFormData();
    const orderPayload = buildOrderPayload(formData);

    // For credit card (Stripe) -> create payment intent on server with same payload
    if (selectedPaymentMethod === 'credit-card') {
      // send to your stripe create-payment-intent endpoint (which should accept the same order payload)
      const resp = await fetch(`${CONFIG.API_BASE_URL}/payments/stripe/create-payment-intent`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getAuthToken()}` },
        body: JSON.stringify(orderPayload)
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Failed to initialize card payment');

      // confirm card payment using stripe.js
      const { clientSecret, orderId } = data;
      const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card: cardElement,
          billing_details: {
            name: formData.cardName,
            email: formData.email,
            phone: formData.phone,
            address: { line1: formData.address, city: formData.city, postal_code: formData.zipCode, country: formData.country }
          }
        }
      });
      if (error) throw error;
      // tell server to confirm payment and update order if needed
      await handlePaymentSuccess({ transactionId: paymentIntent.id, method: 'credit-card', amount: orderPayload.amount, orderId }, formData, orderId);
      showNotification('Payment successful!', 'success');
    }

    // For PayPal, user must click the PayPal button (we show message)
    if (selectedPaymentMethod === 'paypal') {
      showNotification('Complete PayPal payment using the PayPal button above', 'info', 4000);
    }

    // Other methods can be added similarly

  } catch (err) {
    console.error('processPayment error:', err);
    showNotification(err.message || 'Payment failed', 'error');
  } finally {
    submit.disabled = false;
    submit.innerHTML = originalText;
  }
}

/* ------------------------ load & UI init ------------------------ */
async function loadOrderReview() {
      handleDirectPurchase();
  const orderItemsContainer = document.querySelector(".order-items");
  const cart = getCart();
  if (!orderItemsContainer) return;

  orderItemsContainer.innerHTML = '';
  if (cart.length === 0) {
    orderItemsContainer.innerHTML = `<div class="empty-cart-message"><i class="fas fa-shopping-cart"></i><p>Your cart is empty</p><button onclick="window.location.href='shop.html'">Continue Shopping</button></div>`;
    updateTotals(0, 0, 0);
    document.getElementById("placeOrder").disabled = true;
    return;
  }

  let subtotal = 0;
  // Display each cart item
  cart.forEach(item => {
    const itemTotal = Number(item.price || 0) * Number(item.quantity || 1);
    subtotal += itemTotal;
    const orderItem = document.createElement('div');
    orderItem.className = 'order-item';
    orderItem.innerHTML = `
      <div class="order-item-image"><img src="${item.image || 'images/placeholder-product.jpg'}" alt="${item.name || ''}" onerror="this.src='images/placeholder-product.jpg'"></div>
      <div class="order-item-details"><h4>${item.name || ''}</h4><p class="item-sku">SKU: ${item.sku || 'N/A'}</p><div class="order-item-price">â‚¬${Number(item.price||0).toFixed(2)} Ã— ${item.quantity}</div><div class="item-total">Total: â‚¬${itemTotal.toFixed(2)}</div></div>
    `;
    orderItemsContainer.appendChild(orderItem);
  });

  const shippingCost = getShippingCost("standard");
  updateTotals(subtotal, shippingCost, CONFIG.TAX_RATE);
  document.getElementById("placeOrder").disabled = false;
}

/* ------------------------ Small helpers reused from original ------------------------ */
function getShippingCost(method) {
  const shippingRates = { standard: 9.99, express: 19.99, overnight: 29.99 };
  return shippingRates[method] || shippingRates.standard;
}

/* ------------------------ Validation ------------------------ */
function validateField(fieldId) {
  const field = document.getElementById(fieldId);
  const errorElement = document.getElementById(`${fieldId}-error`);
  if (!field || !errorElement) return true;
  let isValid = true, errorMessage = "";

  switch(fieldId) {
    case "email":
      if (!field.value) { isValid = false; errorMessage = "Email is required"; }
      else if (!isValidEmail(field.value)) { isValid = false; errorMessage = "Please enter a valid email address"; }
      break;
    case "firstName":
    case "lastName":
      if (!field.value.trim()) { isValid = false; errorMessage = "This field is required"; }
      break;
    case "phone":
      if (!field.value.trim()) { isValid = false; errorMessage = "Phone number is required"; }
      else if (!isValidPhone(field.value)) { isValid = false; errorMessage = "Please enter a valid phone number"; }
      break;
    default:
      if (!field.value.trim()) { isValid = false; errorMessage = "This field is required"; }
  }

  if (isValid) { field.classList.remove("error"); errorElement.textContent = ""; }
  else { field.classList.add("error"); errorElement.textContent = errorMessage; }

  return isValid;
}

function validateCheckoutForm() {
  const required = ["email","firstName","lastName","address","city","zipCode","country","phone"];
  let ok = true;
  required.forEach(f => { if(!validateField(f)) ok = false; });
  if (!ok) { showNotification("Please fix the errors in the form before proceeding", "error"); const firstError = document.querySelector(".error"); if (firstError) firstError.scrollIntoView({ behavior: "smooth", block: "center" }); }
  // Ensure cart items include productId
  try {
    buildItemsForBackend(getCart());
  } catch (err) {
    showNotification(err.message, "error");
    ok = false;
  }
  return ok;
}

/* ------------------------ Success handler & receipt update (reuse existing) ------------------------ */
async function handlePaymentSuccess(paymentResult, formData, orderId) {
  try {
    localStorage.removeItem("olysHairCart");
    updateReceiptModal(paymentResult, formData);
    updateCheckoutSteps("completed");
    showNotification("Payment successful! Thank you for your order.", "success");
    setTimeout(()=> {
      const receiptModal = document.getElementById("receiptModal");
      if (receiptModal) receiptModal.classList.add("active");
    }, 1000);
  } catch (err) {
    console.error("handlePaymentSuccess error:", err);
  }
}

function updateReceiptModal(paymentResult, formData) {
  const orderNumberElement = document.getElementById("orderNumber");
  if (orderNumberElement) orderNumberElement.textContent = `Order #${paymentResult.orderId || ''}`;
  const receiptItems = document.getElementById("receipt-items");
  if (receiptItems) {
    receiptItems.innerHTML = "";
    (currentOrderData?.items || []).forEach((item) => {
      const itemTotal = item.price * item.quantity;
      const itemElement = document.createElement("div");
      itemElement.className = "receipt-row";
      itemElement.innerHTML = `<span>${item.name} Ã— ${item.quantity}</span><span>â‚¬${itemTotal.toFixed(2)}</span>`;
      receiptItems.appendChild(itemElement);
    });
  }
  // totals
  const receiptSubtotal = document.getElementById("receipt-subtotal");
  const receiptShipping = document.getElementById("receipt-shipping");
  const receiptTax = document.getElementById("receipt-tax");
  const receiptTotal = document.getElementById("receipt-total");
  if (receiptSubtotal) receiptSubtotal.textContent = `â‚¬${(currentOrderData?.subtotal||0).toFixed(2)}`;
  if (receiptShipping) receiptShipping.textContent = `â‚¬${(currentOrderData?.shipping||0).toFixed(2)}`;
  if (receiptTax) receiptTax.textContent = `â‚¬${(currentOrderData?.tax||0).toFixed(2)}`;
  if (receiptTotal) receiptTotal.textContent = `â‚¬${(currentOrderData?.total||0).toFixed(2)}`;
  const shippingInfo = document.getElementById("receipt-shipping-info");
  if (shippingInfo) {
    shippingInfo.innerHTML = `<p>${formData.firstName} ${formData.lastName}</p><p>${formData.address}</p><p>${formData.city}, ${formData.zipCode}</p><p>${formData.country.toUpperCase()}</p><p>${formData.phone}</p>`;
  }
  const deliveryElement = document.getElementById("receipt-delivery");
  if (deliveryElement) {
    switch (formData.shippingMethod) {
      case "express": deliveryElement.textContent = "2-3 business days"; break;
      case "overnight": deliveryElement.textContent = "1 business day"; break;
      default: deliveryElement.textContent = "5-7 business days";
    }
  }
}

/* ------------------------ Initialization & event wiring ------------------------ */
function setupEventListeners() {
  document.getElementById("placeOrder")?.addEventListener("click", processPayment);
  document.getElementById("applyPromo")?.addEventListener("click", () => {
    const promo = document.getElementById("promoCode")?.value?.trim();
    if (promo && promo.toUpperCase() === "SAVE10") {
      appliedPromoCode = promo;
      updateTotals(currentOrderData.subtotal, currentOrderData.shipping, CONFIG.TAX_RATE);
      showNotification("Promo code applied", "success");
    } else {
      appliedPromoCode = null;
      showNotification("Invalid promo code", "error");
    }
  });
  document.querySelectorAll('input[name="shipping"]').forEach(r => r.addEventListener("change", () => {
    updateTotals(currentOrderData.subtotal, getShippingCost(document.querySelector('input[name="shipping"]:checked')?.value || "standard"), CONFIG.TAX_RATE);
  }));
  document.querySelectorAll(".payment-method").forEach(m => m.addEventListener("click", function() {
    if (this.classList.contains("disabled")) return;
    document.querySelectorAll(".payment-method").forEach(x => x.classList.remove("active"));
    this.classList.add("active");
    selectedPaymentMethod = this.dataset.method;
    togglePaymentForms(selectedPaymentMethod);
  }));
}

function togglePaymentForms(method) {
  const credit = document.getElementById("credit-card-form");
  const paypalContainer = document.getElementById("paypal-button-container");
  const apple = document.getElementById("apple-pay-button");
  const klarna = document.getElementById("klarna-payment-form");
  if (credit) credit.style.display = 'none';
  if (paypalContainer) paypalContainer.style.display = 'none';
  if (apple) apple.style.display = 'none';
  if (klarna) klarna.style.display = 'none';
  if (method === 'credit-card' && credit) credit.style.display = 'block';
  if (method === 'paypal' && paypalContainer) { paypalContainer.style.display = 'block'; loadPayPalButton(); }
  if (method === 'apple-pay' && apple) apple.style.display = 'block';
  if (method === 'klarna' && klarna) klarna.style.display = 'block';
}

/* ------------------------ Run initialization on DOM ready ------------------------ */
document.addEventListener("DOMContentLoaded", async function() {
  if (!checkAuthentication()) {
        return; // Stop execution if not authenticated
    }
  // minimal UI set-up (theme, billing toggle etc) - keep your existing behaviour if you want
  const sameAsShipping = document.getElementById("sameAsShipping");
  const billingAddressFields = document.getElementById("billingAddressFields");
  sameAsShipping?.addEventListener("change", () => {
    billingAddressFields.style.display = sameAsShipping.checked ? "none" : "block";
  });

  setupEventListeners();
  await loadOrderReview();

  // init stripe if available
  if (CONFIG.STRIPE_PUBLISHABLE_KEY && CONFIG.STRIPE_PUBLISHABLE_KEY.includes('pk_')) {
    stripe = Stripe(CONFIG.STRIPE_PUBLISHABLE_KEY);
    elements = stripe.elements();
    const cardElementContainer = document.getElementById('card-element');
    if (elements && cardElementContainer) {
      cardElement = elements.create('card', { hidePostalCode: true });
      cardElement.mount('#card-element');
    }
  }
   

  // init paypal button if user chooses paypal or default
  // we don't auto-render here â€” it's called by togglePaymentForms when PayPal method chosen
  console.log('Checkout initialized');
});
// Function to handle direct purchase from localStorage


</script>
  </body>
</html>
